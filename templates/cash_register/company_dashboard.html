{% extends 'layout.html' %}

{% block content %}
<div class="container my-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="bi bi-cash-coin me-2 text-warning"></i>
                    Arqueos de Caja - {{ company.name }}
                </h1>
                <div>
                    <a href="{{ url_for('cash_register.dashboard') }}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left me-1"></i> Volver
                    </a>
                    <a href="{{ url_for('cash_register.new_register', company_id=company.id) }}" class="btn btn-success">
                        <i class="bi bi-plus-circle me-1"></i> Nuevo Arqueo
                    </a>
                </div>
            </div>
            <hr>
        </div>
    </div>

    <!-- Resumen semanal -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-dark border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calendar-week me-2"></i>
                        Resumen Semana {{ current_week }} ({{ week_start }} - {{ week_end }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if summary %}
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-group list-group-flush bg-transparent">
                                <li class="list-group-item bg-dark border-secondary d-flex justify-content-between">
                                    <span>Total Semanal:</span>
                                    <span class="fw-bold text-success">{{ format_currency(summary.weekly_total) }}</span>
                                </li>
                                <li class="list-group-item bg-dark border-secondary d-flex justify-content-between">
                                    <span>Total Mensual:</span>
                                    <span class="fw-bold text-success">{{ format_currency(summary.monthly_total) }}</span>
                                </li>
                                <li class="list-group-item bg-dark border-secondary d-flex justify-content-between">
                                    <span>Total Anual:</span>
                                    <span class="fw-bold text-success">{{ format_currency(summary.yearly_total) }}</span>
                                </li>
                                <li class="list-group-item bg-dark border-secondary d-flex justify-content-between">
                                    <span>Gastos Semanales:</span>
                                    <span class="fw-bold text-danger">{{ format_currency(summary.weekly_expenses) }}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-group list-group-flush bg-transparent">
                                {% if staff_cost %}
                                <li class="list-group-item bg-dark border-secondary d-flex justify-content-between">
                                    <span>Horas Trabajadas (Semana):</span>
                                    <span class="fw-bold">{{ staff_cost.weekly_hours }} h</span>
                                </li>
                                <li class="list-group-item bg-dark border-secondary d-flex justify-content-between">
                                    <span>Coste Personal (Semana):</span>
                                    <span class="fw-bold text-danger">{{ format_currency(staff_cost.weekly_cost) }}</span>
                                </li>
                                <li class="list-group-item bg-dark border-secondary d-flex justify-content-between">
                                    <span>% Coste/Ingresos (Semana):</span>
                                    <span class="fw-bold {% if summary.weekly_staff_cost_percentage > 30 %}text-danger{% else %}text-warning{% endif %}">
                                        {{ format_percentage(summary.weekly_staff_cost_percentage) }}
                                    </span>
                                </li>
                                <li class="list-group-item bg-dark border-secondary d-flex justify-content-between">
                                    <span>% Coste/Ingresos (Mes):</span>
                                    <span class="fw-bold {% if summary.monthly_staff_cost_percentage > 30 %}text-danger{% else %}text-warning{% endif %}">
                                        {{ format_percentage(summary.monthly_staff_cost_percentage) }}
                                    </span>
                                </li>
                                {% else %}
                                <li class="list-group-item bg-dark border-secondary">
                                    <span class="text-muted">No hay datos de coste de personal disponibles</span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        No hay datos para la semana actual. Comience registrando arqueos diarios.
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-transparent border-top border-secondary">
                    <a href="{{ url_for('cash_register.company_report', company_id=company.id) }}" class="btn btn-outline-warning btn-sm">
                        <i class="bi bi-graph-up me-1"></i> Ver Informe Completo
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Métodos de pago (gráfico) -->
        <div class="col-md-6">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pie-chart me-2"></i>
                        Métodos de Pago (Semana)
                    </h5>
                </div>
                <div class="card-body">
                    {% if summary and summary.weekly_total > 0 %}
                    <canvas id="paymentMethodsChart" width="100" height="100"></canvas>
                    {% else %}
                    <div class="alert alert-warning">
                        No hay datos suficientes para mostrar el gráfico.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Acciones Rápidas -->
        <div class="col-md-6">
            <div class="card bg-dark border-secondary h-100">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning-charge me-2"></i>
                        Acciones Rápidas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('cash_register.new_register', company_id=company.id) }}" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i> Nuevo Arqueo
                        </a>
                        <a href="{{ url_for('cash_register.company_report', company_id=company.id) }}" class="btn btn-primary">
                            <i class="bi bi-graph-up me-2"></i> Ver Reportes
                        </a>
                        <a href="{{ url_for('cash_register.manage_tokens', company_id=company.id) }}" class="btn btn-warning">
                            <i class="bi bi-key me-2"></i> Gestionar Tokens de Acceso
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Arqueos Recientes -->
        <div class="col-md-6">
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Arqueos Recientes
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_registers %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for register in recent_registers %}
                                <tr>
                                    <td>{{ register.date.strftime('%d/%m/%Y') }}</td>
                                    <td class="text-success">{{ format_currency(register.total_amount) }}</td>
                                    <td>
                                        <span class="badge bg-success">Activo</span>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('cash_register.edit_register', register_id=register.id) }}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <!-- Se ha eliminado el botón de confirmar ya que los arqueos no requieren confirmación -->
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-3">
                        <div class="alert alert-warning mb-0">
                            No hay arqueos registrados.
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Se ha eliminado la sección "Arqueos Pendientes" ya que los arqueos no requieren confirmación -->
    </div>

    <!-- Gestión Centralizada de Arqueos -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-dark border-info">
                <div class="card-header bg-info text-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-table me-2"></i>
                            Gestión de Arqueos de Caja
                        </h5>
                        <a href="{{ url_for('cash_register.new_register', company_id=company.id) }}" class="btn btn-sm btn-dark">
                            <i class="bi bi-plus-circle me-1"></i> Nuevo Arqueo
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filtros de búsqueda -->
                    <form method="GET" action="{{ url_for('cash_register.manage_registers', company_id=company.id) }}" class="mb-4">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label text-light">Mes</label>
                                <select name="month" class="form-select bg-dark text-light border-secondary">
                                    <option value="0">Todos</option>
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-light">Año</label>
                                <input type="number" name="year" class="form-control bg-dark text-light border-secondary" 
                                       value="{{ current_year }}" min="2020" max="2099">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label text-light">Mostrar</label>
                                <select name="limit" class="form-select bg-dark text-light border-secondary">
                                    <option value="10">10 registros</option>
                                    <option value="25">25 registros</option>
                                    <option value="50">50 registros</option>
                                    <option value="100">100 registros</option>
                                    <option value="0">Todos</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="bi bi-search me-1"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Tabla de arqueos -->
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Efectivo</th>
                                    <th>Tarjeta</th>
                                    <th>Delivery</th>
                                    <th>Cheque</th>
                                    <th>Gastos</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for register in recent_registers %}
                                <tr>
                                    <td>{{ register.date.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ format_currency(register.cash_amount) }}</td>
                                    <td>{{ format_currency(register.card_amount) }}</td>
                                    <td>{{ format_currency(register.delivery_cash_amount + register.delivery_online_amount) }}</td>
                                    <td>{{ format_currency(register.check_amount) }}</td>
                                    <td>{{ format_currency(register.expenses_amount) }}</td>
                                    <td class="text-success fw-bold">{{ format_currency(register.total_amount) }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{{ url_for('cash_register.edit_register', register_id=register.id) }}" 
                                               class="btn btn-sm btn-primary" title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('cash_register.view_register', register_id=register.id) }}" 
                                               class="btn btn-sm btn-info" title="Ver detalles">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-danger" 
                                                    onclick="confirmDelete({{ register.id }}, '{{ register.date.strftime('%d/%m/%Y') }}')"
                                                    title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    {% if not recent_registers %}
                    <div class="alert alert-info my-3">
                        No se encontraron arqueos con los criterios especificados.
                    </div>
                    {% endif %}

                    <!-- Paginación -->
                    <div class="mt-3">
                        <a href="{{ url_for('cash_register.manage_registers', company_id=company.id) }}" 
                           class="btn btn-outline-light">
                            <i class="bi bi-card-list me-1"></i> Ver todos los arqueos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tokens Activos -->
    <div class="row">
        <div class="col-md-12">
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-key me-2 text-warning"></i>
                            Tokens de Acceso Activos
                        </h5>
                        <a href="{{ url_for('cash_register.manage_tokens', company_id=company.id) }}" class="btn btn-sm btn-outline-warning">
                            Gestionar Tokens
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if active_tokens %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-striped mb-0">
                            <thead>
                                <tr>
                                    <th>Creado</th>
                                    <th>Expira</th>
                                    <th>Empleado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for token in active_tokens %}
                                <tr>
                                    <td>{{ token.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                                    <td>
                                        {% if token.expires_at %}
                                        {{ token.expires_at.strftime('%d/%m/%Y') }}
                                        {% else %}
                                        <span class="text-muted">Sin expiración</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if token.employee %}
                                        {{ token.employee.name }} {{ token.employee.last_name }}
                                        {% else %}
                                        <span class="text-muted">Sin asignar</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info copy-token" 
                                                data-token-url="{{ url_for('cash_register.public_register', token_str=token.token, _external=True) }}">
                                            <i class="bi bi-clipboard"></i> Copiar URL
                                        </button>
                                        <form action="{{ url_for('cash_register.deactivate_token', token_id=token.id) }}" method="POST" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Desactivar este token?')">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-3">
                        <div class="alert alert-info mb-0">
                            No hay tokens de acceso activos. Cree tokens para que empleados puedan enviar arqueos.
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Función para confirmar eliminación de arqueo
    window.confirmDelete = function(registerId, registerDate) {
        if (confirm(`¿Estás seguro de que deseas eliminar el arqueo del ${registerDate}? Esta acción no se puede deshacer.`)) {
            // Si el usuario confirma, redirigir a la ruta de eliminación
            window.location.href = `/cash-register/delete/${registerId}`;
        }
    };
    // Configurar gráfico de métodos de pago
    {% if summary and summary.weekly_total > 0 %}
    const paymentMethodsData = {{ payment_methods_data|safe }};
    const ctx = document.getElementById('paymentMethodsChart').getContext('2d');
    
    const paymentMethodsChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: paymentMethodsData.labels,
            datasets: [{
                data: paymentMethodsData.data,
                backgroundColor: [
                    '#28a745',  // Efectivo - Verde
                    '#007bff',  // Tarjeta - Azul
                    '#17a2b8',  // Delivery Efectivo - Cyan
                    '#6f42c1',  // Delivery Online - Púrpura
                    '#ffc107'   // Cheque - Amarillo
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#fff'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.raw || 0;
                            let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            let percentage = Math.round((value / total) * 100);
                            return `${label}: ${value.toFixed(2)} € (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
    
    // Configurar botones de copia de URL de token
    document.querySelectorAll('.copy-token').forEach(button => {
        button.addEventListener('click', function() {
            const url = this.getAttribute('data-token-url');
            navigator.clipboard.writeText(url).then(() => {
                // Cambiar temporalmente el texto del botón
                const originalHtml = this.innerHTML;
                this.innerHTML = '<i class="bi bi-check"></i> Copiado';
                this.classList.remove('btn-outline-info');
                this.classList.add('btn-success');
                
                // Restaurar después de 2 segundos
                setTimeout(() => {
                    this.innerHTML = originalHtml;
                    this.classList.remove('btn-success');
                    this.classList.add('btn-outline-info');
                }, 2000);
            });
        });
    });
});
</script>
{% endblock %}