{% extends "layout.html" %}

{% block head %}
<style>
    .service-status {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 8px;
        background-color: #28293d;
        margin-bottom: 1rem;
    }
    
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .status-online {
        background-color: #28a745;
    }
    
    .status-offline {
        background-color: #dc3545;
    }
    
    .card-admin {
        background-color: #28293d;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        margin-bottom: 1.5rem;
    }
    
    .card-admin .card-header {
        background-color: #212130;
        border-bottom: 1px solid #353549;
        border-radius: 8px 8px 0 0;
    }
    
    .card-admin .card-body {
        color: #e8eaed;
    }
    
    .log-container {
        background-color: #1a1a2e;
        border-radius: 4px;
        padding: 1rem;
        height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 0.9rem;
    }
    
    .log-line {
        margin-bottom: 0.5rem;
        white-space: pre-wrap;
        word-break: break-all;
    }
    
    .status-table th, .status-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #353549;
    }
    
    .status-table th {
        background-color: #212130;
        text-align: left;
    }
    
    .status-table tr:hover {
        background-color: #353549;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Administración de CreaTurno</h1>
        
        <div>
            <a href="{{ url_for('creaturno.index') }}" class="btn btn-secondary me-2">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
            <a href="{{ url_for('creaturno.restart') }}" class="btn btn-warning">
                <i class="bi bi-arrow-repeat"></i> Reiniciar servidor
            </a>
        </div>
    </div>
    
    <!-- Estado del servidor -->
    <div class="service-status">
        <span class="status-indicator status-offline" id="status-dot"></span>
        <div class="flex-grow-1">
            <h5 class="mb-0" id="status-text">Comprobando estado del servidor...</h5>
            <small class="text-muted" id="status-time"></small>
        </div>
    </div>
    
    <div class="row">
        <!-- Información del sistema -->
        <div class="col-lg-6">
            <div class="card card-admin">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Información del sistema</h6>
                </div>
                <div class="card-body">
                    <table class="table status-table text-white w-100">
                        <tr>
                            <th>Componente</th>
                            <th>Estado</th>
                        </tr>
                        <tr>
                            <td>Servidor CreaTurno</td>
                            <td id="server-status">Comprobando...</td>
                        </tr>
                        <tr>
                            <td>Conexión a base de datos</td>
                            <td id="db-status">Comprobando...</td>
                        </tr>
                        <tr>
                            <td>Tablas CreaTurno</td>
                            <td id="tables-status">Comprobando...</td>
                        </tr>
                        <tr>
                            <td>Integración con Productiva</td>
                            <td id="integration-status">Comprobando...</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Registro de actividad -->
        <div class="col-lg-6">
            <div class="card card-admin">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold">Registro de actividad</h6>
                </div>
                <div class="card-body">
                    <div class="log-container" id="activity-log">
                        <div class="log-line text-muted">Cargando registros de actividad...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estadísticas y métricas -->
    <div class="card card-admin">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold">Estadísticas y métricas</h6>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <i class="bi bi-info-circle-fill"></i> Esta sección mostrará estadísticas sobre el uso de CreaTurno cuando haya datos disponibles.
            </div>
            
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white mb-3">
                        <div class="card-body text-center">
                            <h5 class="card-title">Empresas</h5>
                            <p class="display-4" id="companies-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white mb-3">
                        <div class="card-body text-center">
                            <h5 class="card-title">Empleados</h5>
                            <p class="display-4" id="employees-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white mb-3">
                        <div class="card-body text-center">
                            <h5 class="card-title">Turnos</h5>
                            <p class="display-4" id="shifts-count">-</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white mb-3">
                        <div class="card-body text-center">
                            <h5 class="card-title">Ubicaciones</h5>
                            <p class="display-4" id="locations-count">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const statusTime = document.getElementById('status-time');
        const serverStatus = document.getElementById('server-status');
        const dbStatus = document.getElementById('db-status');
        const tablesStatus = document.getElementById('tables-status');
        const integrationStatus = document.getElementById('integration-status');
        const activityLog = document.getElementById('activity-log');
        
        // Función para formatear fecha
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // Comprobar el estado del servidor de CreaTurno
        function checkServerStatus() {
            fetch('{{ url_for("creaturno.status") }}')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'running') {
                        // Servidor en funcionamiento
                        statusDot.classList.remove('status-offline');
                        statusDot.classList.add('status-online');
                        statusText.textContent = 'Servidor de CreaTurno en funcionamiento';
                        statusTime.textContent = `Última comprobación: ${formatDate(data.timestamp)}`;
                        
                        serverStatus.innerHTML = '<span class="badge bg-success">En línea</span>';
                        dbStatus.innerHTML = '<span class="badge bg-success">Conectado</span>';
                        tablesStatus.innerHTML = '<span class="badge bg-success">OK</span>';
                        integrationStatus.innerHTML = '<span class="badge bg-success">Activa</span>';
                        
                        // Simular algunos registros de actividad (en una versión real, se obtendrían del servidor)
                        activityLog.innerHTML = `
                            <div class="log-line text-success">[${formatDate(new Date())}] Servidor CreaTurno iniciado correctamente</div>
                            <div class="log-line text-info">[${formatDate(new Date(Date.now() - 60000))}] Conexión a base de datos establecida</div>
                            <div class="log-line text-info">[${formatDate(new Date(Date.now() - 120000))}] Tablas verificadas correctamente</div>
                            <div class="log-line text-warning">[${formatDate(new Date(Date.now() - 180000))}] Advertencia: Carga inicial de datos puede tardar más de lo normal</div>
                        `;
                        
                        // Simular algunos conteos estadísticos (en una versión real, se obtendrían del servidor)
                        document.getElementById('companies-count').textContent = '12';
                        document.getElementById('employees-count').textContent = '87';
                        document.getElementById('shifts-count').textContent = '156';
                        document.getElementById('locations-count').textContent = '24';
                    } else {
                        // Servidor no disponible
                        statusDot.classList.remove('status-online');
                        statusDot.classList.add('status-offline');
                        statusText.textContent = 'Servidor de CreaTurno desconectado';
                        statusTime.textContent = `Última comprobación: ${formatDate(data.timestamp)}`;
                        
                        serverStatus.innerHTML = '<span class="badge bg-danger">Desconectado</span>';
                        dbStatus.innerHTML = '<span class="badge bg-danger">Sin conexión</span>';
                        tablesStatus.innerHTML = '<span class="badge bg-warning">Desconocido</span>';
                        integrationStatus.innerHTML = '<span class="badge bg-danger">Inactiva</span>';
                        
                        activityLog.innerHTML = `
                            <div class="log-line text-danger">[${formatDate(new Date())}] Error: No se pudo conectar con el servidor CreaTurno</div>
                            <div class="log-line text-warning">[${formatDate(new Date(Date.now() - 30000))}] Intentando reconectar...</div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error al comprobar estado:', error);
                    statusDot.classList.remove('status-online');
                    statusDot.classList.add('status-offline');
                    statusText.textContent = 'Error al conectar con CreaTurno';
                    statusTime.textContent = `Última comprobación: ${formatDate(new Date())}`;
                    
                    serverStatus.innerHTML = '<span class="badge bg-danger">Error</span>';
                    dbStatus.innerHTML = '<span class="badge bg-warning">Desconocido</span>';
                    tablesStatus.innerHTML = '<span class="badge bg-warning">Desconocido</span>';
                    integrationStatus.innerHTML = '<span class="badge bg-warning">Desconocido</span>';
                    
                    activityLog.innerHTML = `
                        <div class="log-line text-danger">[${formatDate(new Date())}] Error: ${error.message}</div>
                    `;
                });
        }
        
        // Comprobar estado inicial
        checkServerStatus();
        
        // Comprobar estado cada 10 segundos
        setInterval(checkServerStatus, 10000);
    });
</script>
{% endblock %}