{% extends "layout.html" %}

{% block styles %}
{{ super() }}
<style>
    /* Estilos para el iframe que contiene CreaTurno */
    .creaturno-container {
        width: 100%;
        height: calc(100vh - 100px);
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    
    .creaturno-iframe {
        width: 100%;
        height: 100%;
        border: none;
        margin: 0;
        padding: 0;
    }
    
    /* Breadcrumb */
    .breadcrumb {
        background-color: transparent;
        border-radius: 0;
        padding: 0.5rem 0;
        margin-bottom: 0.5rem;
    }
    
    /* Pequeño banner para mostrar información del usuario y de CreaTurno */
    .creaturno-info {
        background-color: #f8f9fa;
        padding: 5px 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .creaturno-info .status {
        display: flex;
        align-items: center;
    }
    
    .creaturno-info .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .status-indicator.online {
        background-color: #28a745;
    }
    
    .status-indicator.offline {
        background-color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Inicio</a></li>
        <li class="breadcrumb-item active" aria-current="page">CreaTurno</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>CreaTurno - Gestión de Turnos</h1>
    {% if current_user.is_admin() %}
    <a href="{{ url_for('creaturno.admin') }}" class="btn btn-outline-primary">
        <i class="fas fa-cog"></i> Administración
    </a>
    {% endif %}
</div>

<div class="creaturno-info">
    <div>
        <strong>Usuario:</strong> {{ user_info.full_name }} ({{ user_info.username }})
        {% if user_info.is_admin %}
        <span class="badge bg-danger">Admin</span>
        {% endif %}
    </div>
    <div class="status">
        <span class="status-indicator online" id="status-indicator"></span>
        <span id="status-text">Conectado</span>
    </div>
</div>

<div class="creaturno-container">
    <iframe src="http://localhost:5001" class="creaturno-iframe" id="creaturno-iframe"></iframe>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Script para verificar periódicamente si el servidor de CreaTurno está disponible
    function checkServerStatus() {
        fetch('/creaturno/status')
            .then(response => response.json())
            .then(data => {
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                if (data.status === 'running') {
                    statusIndicator.className = 'status-indicator online';
                    statusText.textContent = 'Conectado';
                } else {
                    statusIndicator.className = 'status-indicator offline';
                    statusText.textContent = 'Desconectado';
                    
                    // Mostrar mensaje de error en el iframe
                    const iframe = document.getElementById('creaturno-iframe');
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    if (iframeDoc) {
                        iframeDoc.body.innerHTML = `
                            <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                                <h2>Servidor de CreaTurno no disponible</h2>
                                <p>Por favor, contacte con el administrador del sistema.</p>
                                <button onclick="window.parent.location.reload()">Reintentar</button>
                            </div>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error al verificar estado del servidor:', error);
                
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'Error de conexión';
            });
    }
    
    // Verificar estado cada 30 segundos
    setInterval(checkServerStatus, 30000);
    
    // Verificar estado al cargar la página
    document.addEventListener('DOMContentLoaded', checkServerStatus);
    
    // Manejar eventos de mensaje desde el iframe
    window.addEventListener('message', function(event) {
        // Verificar origen del mensaje
        if (event.origin !== 'http://localhost:5001') {
            return;
        }
        
        const message = event.data;
        
        // Manejar diferentes tipos de mensajes
        if (message.type === 'auth') {
            // Enviar información de autenticación al iframe
            const iframe = document.getElementById('creaturno-iframe');
            iframe.contentWindow.postMessage({
                type: 'auth_response',
                user: {{ user_info|tojson }}
            }, 'http://localhost:5001');
        }
    });
</script>
{% endblock %}