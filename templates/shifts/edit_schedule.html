{% extends "layout.html" %}

{% block title %}Editar Programación - {{ schedule.name }}{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .schedule-grid {
        display: grid;
        grid-template-columns: 150px repeat(auto-fill, minmax(120px, 1fr));
        gap: 1px;
        background-color: #dee2e6;
        border: 1px solid #dee2e6;
    }
    
    .grid-cell {
        background-color: white;
        padding: 8px;
        min-height: 120px;
    }
    
    .grid-header {
        background-color: #f8f9fa;
        text-align: center;
        font-weight: bold;
        min-height: auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    
    .employee-cell {
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        background-color: #f8f9fa;
    }
    
    .shift-card {
        background-color: #e7f5ff;
        border-left: 4px solid #0d6efd;
        border-radius: 4px;
        padding: 8px;
        font-size: 0.85rem;
        margin-bottom: 5px;
        cursor: pointer;
        position: relative;
    }
    
    .shift-card:hover {
        background-color: #cfe2ff;
    }
    
    .shift-time {
        font-weight: bold;
    }
    
    .shift-break {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .shift-notes {
        font-style: italic;
        font-size: 0.75rem;
        margin-top: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .shift-actions {
        position: absolute;
        top: 5px;
        right: 5px;
        display: none;
    }
    
    .shift-card:hover .shift-actions {
        display: block;
    }
    
    .add-shift-btn {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 2px dashed #dee2e6;
        color: #6c757d;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .add-shift-btn:hover {
        border-color: #6c757d;
        color: #495057;
    }
    
    .weekend-cell {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4 mb-4">
        <i class="fas fa-edit me-2"></i> Editar Programación
    </h1>

    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('shifts.index') }}">Sistema de Turnos</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('shifts.company_dashboard', company_id=company.id) }}">{{ company.name }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('shifts.view_schedule', schedule_id=schedule.id) }}">{{ schedule.name }}</a></li>
            <li class="breadcrumb-item active">Editar</li>
        </ol>
    </nav>
    
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-info-circle me-1"></i>
                        Detalles de la Programación
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-success me-2" id="saveScheduleBtn">
                            <i class="fas fa-save me-1"></i> Guardar Cambios
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="publishScheduleBtn">
                            <i class="fas fa-check-circle me-1"></i> Publicar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <form id="scheduleForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">Nombre</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ schedule.name }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="status" class="form-label">Estado</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="draft" {% if schedule.status == 'draft' %}selected{% endif %}>Borrador</option>
                                    <option value="published" {% if schedule.status == 'published' %}selected{% endif %}>Publicado</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="start_date" class="form-label">Fecha de Inicio</label>
                                <input type="text" class="form-control datepicker" id="start_date" name="start_date" value="{{ schedule.start_date|date_format }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="end_date" class="form-label">Fecha de Fin</label>
                                <input type="text" class="form-control datepicker" id="end_date" name="end_date" value="{{ schedule.end_date|date_format }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Descripción</label>
                            <textarea class="form-control" id="description" name="description" rows="2">{{ schedule.description or '' }}</textarea>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-users me-1"></i>
                    Empleados Disponibles
                </div>
                <div class="card-body">
                    <div class="list-group" id="employeesList">
                        {% for employee in employees %}
                        <div class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ employee.first_name }} {{ employee.last_name }}</h6>
                            </div>
                            <small class="text-muted">{{ employee.position or 'Sin cargo asignado' }}</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-calendar-alt me-1"></i>
            Editor de Turnos
        </div>
        <div class="card-body">
            <div id="scheduleGrid">
                {% if schedule.start_date and schedule.end_date %}
                    {% set start_date = schedule.start_date|datetime_from_string %}
                    {% set end_date = schedule.end_date|datetime_from_string %}
                    {% set date_range = [] %}
                    {% set current_date = start_date %}
                    
                    {# Generar rango de fechas #}
                    {% for day in range((end_date - start_date).days + 1) %}
                        {% set _ = date_range.append(current_date) %}
                        {% set current_date = current_date + timedelta(days=1) %}
                    {% endfor %}
                    
                    <div class="schedule-grid">
                        {# Header con fechas #}
                        <div class="grid-cell grid-header">Empleado</div>
                        {% for date in date_range %}
                            <div class="grid-cell grid-header">
                                {{ date.strftime('%d/%m/%Y') }}<br>
                                <small>{{ ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'][date.weekday()] }}</small>
                            </div>
                        {% endfor %}
                        
                        {# Filas de empleados #}
                        {% for employee in employees %}
                            <div class="grid-cell employee-cell" data-employee-id="{{ employee.id }}">
                                {{ employee.first_name }} {{ employee.last_name }}
                            </div>
                            
                            {% for date in date_range %}
                                {% set date_str = date.strftime('%Y-%m-%d') %}
                                {% set is_weekend = date.weekday() >= 5 %}
                                <div class="grid-cell {% if is_weekend %}weekend-cell{% endif %}" 
                                    data-date="{{ date_str }}" 
                                    data-employee-id="{{ employee.id }}">
                                    <div class="add-shift-btn" title="Añadir turno">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        Primero debe definir un período válido para la programación.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar turnos -->
<div class="modal fade" id="shiftModal" tabindex="-1" aria-labelledby="shiftModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shiftModalLabel">Añadir Turno</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shiftForm">
                    <input type="hidden" id="shift_id" name="shift_id">
                    <input type="hidden" id="schedule_id" name="schedule_id" value="{{ schedule.id }}">
                    <input type="hidden" id="employee_id" name="employee_id">
                    <input type="hidden" id="date" name="date">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="start_time" class="form-label">Hora de inicio</label>
                            <input type="text" class="form-control timepicker" id="start_time" name="start_time" required>
                        </div>
                        <div class="col-md-6">
                            <label for="end_time" class="form-label">Hora de fin</label>
                            <input type="text" class="form-control timepicker" id="end_time" name="end_time" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="break_time" class="form-label">Tiempo de descanso (minutos)</label>
                        <input type="number" class="form-control" id="break_time" name="break_time" min="0" value="0">
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notas</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto d-none" id="deleteShiftBtn">
                    <i class="fas fa-trash-alt me-1"></i> Eliminar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveShiftBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar datepickers
        flatpickr(".datepicker", {
            dateFormat: "d/m/Y",
            locale: "es",
            allowInput: true
        });
        
        // Inicializar timepickers
        flatpickr(".timepicker", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true,
            minuteIncrement: 15
        });
        
        // Referencias
        const shiftModal = new bootstrap.Modal(document.getElementById('shiftModal'));
        const shiftForm = document.getElementById('shiftForm');
        const deleteShiftBtn = document.getElementById('deleteShiftBtn');
        const saveShiftBtn = document.getElementById('saveShiftBtn');
        const scheduleForm = document.getElementById('scheduleForm');
        const saveScheduleBtn = document.getElementById('saveScheduleBtn');
        const publishScheduleBtn = document.getElementById('publishScheduleBtn');
        
        // Variables globales
        let shifts = [];
        let currentShiftId = null;
        
        // Cargar datos iniciales
        loadScheduleData();
        
        // Event listeners
        document.querySelectorAll('.add-shift-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const cell = this.closest('.grid-cell');
                const employeeId = cell.dataset.employeeId;
                const date = cell.dataset.date;
                
                openShiftModal(null, employeeId, date);
            });
        });
        
        saveShiftBtn.addEventListener('click', function() {
            saveShift();
        });
        
        deleteShiftBtn.addEventListener('click', function() {
            deleteShift();
        });
        
        saveScheduleBtn.addEventListener('click', function() {
            saveSchedule();
        });
        
        publishScheduleBtn.addEventListener('click', function() {
            document.getElementById('status').value = 'published';
            saveSchedule();
        });
        
        // Funciones
        function loadScheduleData() {
            fetch(`/shifts/api/schedules/{{ schedule.id }}`)
                .then(response => response.json())
                .then(data => {
                    shifts = data.shifts;
                    renderShifts();
                })
                .catch(error => {
                    console.error('Error loading schedule data:', error);
                });
        }
        
        function renderShifts() {
            // Limpiar turnos existentes
            document.querySelectorAll('.shift-card').forEach(card => card.remove());
            
            // Renderizar turnos
            shifts.forEach(shift => {
                const cell = document.querySelector(`.grid-cell[data-date="${shift.date}"][data-employee-id="${shift.employee_id}"]`);
                if (cell) {
                    // Ocultar el botón de añadir
                    const addBtn = cell.querySelector('.add-shift-btn');
                    if (addBtn) addBtn.style.display = 'none';
                    
                    // Crear tarjeta de turno
                    const shiftCard = document.createElement('div');
                    shiftCard.className = 'shift-card';
                    shiftCard.setAttribute('data-shift-id', shift.id);
                    
                    shiftCard.innerHTML = `
                        <div class="shift-time">${shift.start_time} - ${shift.end_time}</div>
                        ${shift.break_time ? `<div class="shift-break">Descanso: ${shift.break_time} min</div>` : ''}
                        ${shift.notes ? `<div class="shift-notes" title="${shift.notes}">${shift.notes}</div>` : ''}
                        <div class="shift-actions">
                            <button type="button" class="btn btn-sm btn-outline-secondary edit-shift-btn">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    `;
                    
                    // Añadir event listener
                    shiftCard.addEventListener('click', function() {
                        const shiftId = this.getAttribute('data-shift-id');
                        openShiftModal(shiftId, shift.employee_id, shift.date);
                    });
                    
                    cell.appendChild(shiftCard);
                }
            });
        }
        
        function openShiftModal(shiftId, employeeId, date) {
            // Limpiar formulario
            shiftForm.reset();
            
            // Establecer datos base
            document.getElementById('employee_id').value = employeeId;
            document.getElementById('date').value = date;
            
            if (shiftId) {
                // Modo edición
                currentShiftId = shiftId;
                document.getElementById('shift_id').value = shiftId;
                document.getElementById('shiftModalLabel').textContent = 'Editar Turno';
                deleteShiftBtn.classList.remove('d-none');
                
                // Buscar datos del turno
                const shift = shifts.find(s => s.id == shiftId);
                if (shift) {
                    document.getElementById('start_time').value = shift.start_time;
                    document.getElementById('end_time').value = shift.end_time;
                    document.getElementById('break_time').value = shift.break_time || 0;
                    document.getElementById('notes').value = shift.notes || '';
                }
            } else {
                // Modo creación
                currentShiftId = null;
                document.getElementById('shift_id').value = '';
                document.getElementById('shiftModalLabel').textContent = 'Añadir Turno';
                deleteShiftBtn.classList.add('d-none');
                
                // Valores por defecto
                document.getElementById('start_time').value = '09:00';
                document.getElementById('end_time').value = '18:00';
                document.getElementById('break_time').value = '60';
            }
            
            // Reinicializar time pickers
            document.querySelectorAll('.timepicker').forEach(input => {
                const fp = input._flatpickr;
                if (fp) {
                    fp.setDate(input.value);
                }
            });
            
            shiftModal.show();
        }
        
        function saveShift() {
            const formData = {
                schedule_id: parseInt(document.getElementById('schedule_id').value),
                employee_id: parseInt(document.getElementById('employee_id').value),
                date: document.getElementById('date').value,
                start_time: document.getElementById('start_time').value,
                end_time: document.getElementById('end_time').value,
                break_time: parseInt(document.getElementById('break_time').value) || 0,
                notes: document.getElementById('notes').value
            };
            
            let url, method;
            
            if (currentShiftId) {
                // Actualizar turno existente
                url = `/shifts/api/shifts/${currentShiftId}`;
                method = 'PUT';
            } else {
                // Crear nuevo turno
                url = '/shifts/api/shifts';
                method = 'POST';
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Actualizar datos locales
                if (currentShiftId) {
                    shifts = shifts.map(s => s.id == currentShiftId ? data : s);
                } else {
                    shifts.push(data);
                }
                
                // Actualizar vista
                renderShifts();
                
                // Cerrar modal
                shiftModal.hide();
            })
            .catch(error => {
                console.error('Error saving shift:', error);
                alert('Error al guardar el turno. Por favor, inténtelo de nuevo.');
            });
        }
        
        function deleteShift() {
            if (!currentShiftId) return;
            
            if (!confirm('¿Está seguro de que desea eliminar este turno?')) {
                return;
            }
            
            fetch(`/shifts/api/shifts/${currentShiftId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Actualizar datos locales
                shifts = shifts.filter(s => s.id != currentShiftId);
                
                // Actualizar vista
                renderShifts();
                
                // Cerrar modal
                shiftModal.hide();
            })
            .catch(error => {
                console.error('Error deleting shift:', error);
                alert('Error al eliminar el turno. Por favor, inténtelo de nuevo.');
            });
        }
        
        function saveSchedule() {
            // Esta función simula guardar los cambios de la programación
            // En una implementación real, enviaría los datos al servidor
            
            const name = document.getElementById('name').value;
            const status = document.getElementById('status').value;
            
            if (!name) {
                alert('El nombre de la programación es obligatorio');
                return;
            }
            
            alert('Cambios guardados correctamente');
            
            // Redirigir a la vista de la programación
            // window.location.href = `/shifts/schedule/{{ schedule.id }}`;
        }
    });
</script>
{% endblock %}