{% extends "layout.html" %}

{% block title %}Nueva Programación de Turnos{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    .error-feedback {
        width: 100%;
        margin-top: 0.25rem;
        font-size: 80%;
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4 mb-4">
        <i class="fas fa-calendar-plus me-2"></i> Nueva Programación de Turnos
    </h1>

    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('shifts.index') }}">Sistema de Turnos</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('shifts.company_dashboard', company_id=company.id) }}">{{ company.name }}</a></li>
            <li class="breadcrumb-item active">Nueva Programación</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-calendar-plus me-1"></i>
                    Detalles de la Nueva Programación
                </div>
                <div class="card-body">
                    <form method="POST" id="scheduleForm">
                        <div class="mb-3">
                            <label for="name" class="form-label">Nombre de la Programación <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   placeholder="Ej: Turnos Semana 25-2023">
                            <div class="error-feedback" id="name-error"></div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="start_date" class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                                <input type="text" class="form-control datepicker" id="start_date" name="start_date" required
                                       placeholder="DD/MM/YYYY">
                                <div class="error-feedback" id="start_date-error"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="end_date" class="form-label">Fecha de Fin <span class="text-danger">*</span></label>
                                <input type="text" class="form-control datepicker" id="end_date" name="end_date" required
                                       placeholder="DD/MM/YYYY">
                                <div class="error-feedback" id="end_date-error"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Descripción</label>
                            <textarea class="form-control" id="description" name="description" rows="3"
                                      placeholder="Descripción opcional de esta programación de turnos"></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('shifts.company_dashboard', company_id=company.id) }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i> Guardar y Continuar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar datepickers
        flatpickr(".datepicker", {
            dateFormat: "d/m/Y",
            locale: "es",
            allowInput: true
        });
        
        // Validación del formulario
        const form = document.getElementById('scheduleForm');
        
        form.addEventListener('submit', function(event) {
            let valid = true;
            
            // Validar nombre
            const nameInput = document.getElementById('name');
            if (!nameInput.value.trim()) {
                document.getElementById('name-error').textContent = 'El nombre es obligatorio';
                nameInput.classList.add('is-invalid');
                valid = false;
            } else {
                document.getElementById('name-error').textContent = '';
                nameInput.classList.remove('is-invalid');
            }
            
            // Validar fechas
            const startDateInput = document.getElementById('start_date');
            const endDateInput = document.getElementById('end_date');
            
            if (!startDateInput.value) {
                document.getElementById('start_date-error').textContent = 'La fecha de inicio es obligatoria';
                startDateInput.classList.add('is-invalid');
                valid = false;
            } else {
                document.getElementById('start_date-error').textContent = '';
                startDateInput.classList.remove('is-invalid');
            }
            
            if (!endDateInput.value) {
                document.getElementById('end_date-error').textContent = 'La fecha de fin es obligatoria';
                endDateInput.classList.add('is-invalid');
                valid = false;
            } else {
                document.getElementById('end_date-error').textContent = '';
                endDateInput.classList.remove('is-invalid');
            }
            
            // Validar que la fecha de fin sea posterior a la de inicio
            if (startDateInput.value && endDateInput.value) {
                const startParts = startDateInput.value.split('/');
                const endParts = endDateInput.value.split('/');
                
                if (startParts.length === 3 && endParts.length === 3) {
                    const startDate = new Date(startParts[2], startParts[1] - 1, startParts[0]);
                    const endDate = new Date(endParts[2], endParts[1] - 1, endParts[0]);
                    
                    if (endDate < startDate) {
                        document.getElementById('end_date-error').textContent = 'La fecha de fin debe ser posterior a la fecha de inicio';
                        endDateInput.classList.add('is-invalid');
                        valid = false;
                    }
                }
            }
            
            if (!valid) {
                event.preventDefault();
            }
        });
    });
</script>
{% endblock %}