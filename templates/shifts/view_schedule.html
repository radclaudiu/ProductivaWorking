{% extends "layout.html" %}

{% block title %}Ver Programación - {{ schedule.name }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .schedule-table th {
        text-align: center;
        vertical-align: middle;
    }
    
    .schedule-table td {
        height: 100px;
        vertical-align: top;
        padding: 8px;
    }
    
    .schedule-table .employee-name {
        width: 150px;
        font-weight: bold;
        vertical-align: middle;
        background-color: #f8f9fa;
    }
    
    .shift-card {
        background-color: #e7f5ff;
        border-left: 4px solid #0d6efd;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 5px;
        font-size: 0.85rem;
    }
    
    .shift-time {
        font-weight: bold;
    }
    
    .shift-break {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .shift-notes {
        font-style: italic;
        font-size: 0.75rem;
        margin-top: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .date-header {
        min-width: 120px;
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4 mb-4">
        <i class="fas fa-calendar-alt me-2"></i> {{ schedule.name }}
    </h1>

    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('shifts.index') }}">Sistema de Turnos</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('shifts.company_dashboard', company_id=company.id) }}">{{ company.name }}</a></li>
            <li class="breadcrumb-item active">{{ schedule.name }}</li>
        </ol>
    </nav>
    
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-info-circle me-1"></i>
                Detalles de la Programación
            </div>
            <div>
                <a href="{{ url_for('shifts.edit_schedule', schedule_id=schedule.id) }}" class="btn btn-sm btn-warning me-2">
                    <i class="fas fa-edit me-1"></i> Editar
                </a>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-download me-1"></i> Exportar
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('shifts.export_schedule', schedule_id=schedule.id, format='pdf') }}">Exportar PDF</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('shifts.export_schedule', schedule_id=schedule.id, format='excel') }}">Exportar Excel</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Empresa:</strong> {{ company.name }}</p>
                    <p><strong>Período:</strong> {{ schedule.start_date|date_format }} - {{ schedule.end_date|date_format }}</p>
                </div>
                <div class="col-md-6">
                    <p>
                        <strong>Estado:</strong>
                        {% if schedule.status == 'draft' %}
                        <span class="badge bg-warning text-dark">Borrador</span>
                        {% elif schedule.status == 'published' %}
                        <span class="badge bg-success">Publicado</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ schedule.status }}</span>
                        {% endif %}
                    </p>
                    <p><strong>Creado:</strong> {{ schedule.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                </div>
                {% if schedule.description %}
                <div class="col-md-12 mt-2">
                    <p><strong>Descripción:</strong> {{ schedule.description }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Programación de Turnos
        </div>
        <div class="card-body">
            {% if employees and schedule.start_date and schedule.end_date %}
                {% set start_date = schedule.start_date|datetime_from_string %}
                {% set end_date = schedule.end_date|datetime_from_string %}
                {% set date_range = [] %}
                {% set current_date = start_date %}
                
                {# Generar rango de fechas #}
                {% for day in range((end_date - start_date).days + 1) %}
                    {% set _ = date_range.append(current_date) %}
                    {% set current_date = current_date + timedelta(days=1) %}
                {% endfor %}
                
                <div class="table-responsive">
                    <table class="table table-bordered schedule-table">
                        <thead>
                            <tr>
                                <th>Empleado</th>
                                {% for date in date_range %}
                                <th class="date-header">
                                    {{ date.strftime('%d/%m/%Y') }}<br>
                                    <small>{{ ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'][date.weekday()] }}</small>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for employee in employees %}
                            <tr>
                                <td class="employee-name">{{ employee.first_name }} {{ employee.last_name }}</td>
                                {% for date in date_range %}
                                <td>
                                    {% set date_str = date.strftime('%Y-%m-%d') %}
                                    {% if shifts_by_date.get(date_str) and shifts_by_date[date_str].get(employee.id) %}
                                        {% set shift = shifts_by_date[date_str][employee.id] %}
                                        <div class="shift-card">
                                            <div class="shift-time">{{ shift.start_time }} - {{ shift.end_time }}</div>
                                            {% if shift.break_time %}
                                            <div class="shift-break">Descanso: {{ shift.break_time }} min</div>
                                            {% endif %}
                                            {% if shift.notes %}
                                            <div class="shift-notes" title="{{ shift.notes }}">{{ shift.notes }}</div>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i>
                    {% if not employees %}
                    No hay empleados activos en esta empresa.
                    {% else %}
                    No se ha definido un período para esta programación.
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}