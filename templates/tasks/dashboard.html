{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-grid"></i> Sistema de Gestión de Tareas</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver al Dashboard Principal
                </a>
            </div>
        </div>
    </div>

    <!-- Botones principales de navegación -->
    <div class="row mb-5">
        <div class="col-md-6">
            <div class="card shadow h-100 hover-card">
                <div class="card-body text-center py-5">
                    <img src="{{ url_for('static', filename='icons/task-management.svg') }}" alt="Gestión de Tareas" class="mb-4" style="width: 80px; height: 80px;">
                    <h3 class="card-title">Gestión de Tareas</h3>
                    <p class="card-text">Administra tareas diarias, semanales y mensuales</p>
                    <a href="#tasks-section" class="btn btn-primary btn-lg mt-3 stretched-link">
                        <i class="bi bi-list-check"></i> Ir a Tareas
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow h-100 hover-card">
                <div class="card-body text-center py-5">
                    <img src="{{ url_for('static', filename='icons/location-management.svg') }}" alt="Gestión de Locales" class="mb-4" style="width: 80px; height: 80px;">
                    <h3 class="card-title">Gestión de Locales</h3>
                    <p class="card-text">Configura locales y usuarios con acceso por PIN</p>
                    <a href="#locations-section" class="btn btn-success btn-lg mt-3 stretched-link">
                        <i class="bi bi-building"></i> Ir a Locales
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN DE GESTIÓN DE TAREAS -->
    <section id="tasks-section" class="mb-5">
        <div class="card shadow">
            <div class="card-header bg-primary text-white py-3">
                <h3 class="m-0"><i class="bi bi-list-check"></i> Gestión de Tareas</h3>
            </div>
            <div class="card-body p-4">
                <!-- Estadísticas de tareas -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="fw-bold text-primary">Total Tareas Activas</h6>
                                <h2 class="display-4">{{ stats.total_tasks }}</h2>
                                <a href="{{ url_for('tasks.list_tasks', location_id=locations[0].id) if locations else '#' }}" class="btn btn-sm btn-primary mt-3">
                                    Ver Tareas
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="fw-bold text-success">Tareas Completadas Hoy</h6>
                                <h2 class="display-4">{{ stats.tasks_completed_today }}</h2>
                                <span class="text-muted">de {{ stats.tasks_today }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center p-3">
                                <h6 class="fw-bold text-warning">Tareas Pendientes</h6>
                                <canvas id="taskStatusChart" height="120"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones rápidas para tareas -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">Acciones Rápidas</h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% if locations %}
                                {% for location in locations %}
                                <a href="{{ url_for('tasks.create_task', location_id=location.id) }}" class="btn btn-outline-primary">
                                    <i class="bi bi-plus-circle"></i> Nueva Tarea en {{ location.name }}
                                </a>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">Primero debes crear un local para poder añadir tareas.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Tareas pendientes hoy -->
                <div class="row">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">Tareas Pendientes Hoy</h5>
                        {% if pending_tasks %}
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>Tarea</th>
                                        <th>Local</th>
                                        <th>Prioridad</th>
                                        <th>Frecuencia</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in pending_tasks %}
                                    <tr>
                                        <td>{{ task.title }}</td>
                                        <td>{{ task.location.name }}</td>
                                        <td>
                                            {% if task.priority.value == 'baja' %}
                                            <span class="badge bg-info">Baja</span>
                                            {% elif task.priority.value == 'media' %}
                                            <span class="badge bg-primary">Media</span>
                                            {% elif task.priority.value == 'alta' %}
                                            <span class="badge bg-warning">Alta</span>
                                            {% else %}
                                            <span class="badge bg-danger">Urgente</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ task.frequency.name.capitalize() }}</td>
                                        <td>
                                            <a href="{{ url_for('tasks.view_task', task_id=task.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> Ver
                                            </a>
                                            <a href="{{ url_for('tasks.edit_task', task_id=task.id) }}" class="btn btn-sm btn-outline-secondary">
                                                <i class="bi bi-pencil"></i> Editar
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4 bg-light rounded">
                            <i class="bi bi-check-circle-fill text-success fs-1"></i>
                            <p class="mt-3">No hay tareas pendientes para hoy.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SECCIÓN DE GESTIÓN DE LOCALES -->
    <section id="locations-section" class="mb-5">
        <div class="card shadow">
            <div class="card-header bg-success text-white py-3">
                <h3 class="m-0"><i class="bi bi-building"></i> Gestión de Locales</h3>
            </div>
            <div class="card-body p-4">
                <!-- Estadísticas de locales -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="fw-bold text-success">Locales Activos</h6>
                                <h2 class="display-4">{{ stats.total_locations }}</h2>
                                <a href="{{ url_for('tasks.list_locations') }}" class="btn btn-sm btn-success mt-3">
                                    Gestionar Locales
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="fw-bold text-info">Usuarios Locales</h6>
                                <h2 class="display-4">{{ stats.total_local_users }}</h2>
                                <a href="{{ url_for('tasks.list_local_users', location_id=locations[0].id) if locations else '#' }}" class="btn btn-sm btn-info mt-3 {% if not locations %}disabled{% endif %}">
                                    Gestionar Usuarios
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones rápidas para locales -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">Acciones Rápidas</h5>
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{{ url_for('tasks.create_location') }}" class="btn btn-outline-success">
                                <i class="bi bi-plus-circle"></i> Nuevo Local
                            </a>
                            {% if locations %}
                                {% for location in locations %}
                                <a href="{{ url_for('tasks.create_local_user', location_id=location.id) }}" class="btn btn-outline-info">
                                    <i class="bi bi-person-plus"></i> Nuevo Usuario en {{ location.name }}
                                </a>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Lista de portales locales -->
                <div class="row">
                    <div class="col-12">
                        <h5 class="border-bottom pb-2 mb-3">Acceso a Portales Locales</h5>
                        {% if locations %}
                        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
                            {% for location in locations %}
                            <div class="col">
                                <div class="card h-100 location-card">
                                    <div class="card-header bg-light text-center">
                                        <h5 class="card-title mb-0">{{ location.name }}</h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="card-text text-muted small mb-3">
                                            {{ location.city if location.city else "" }} 
                                            {{ "- " + location.postal_code if location.postal_code else "" }}
                                        </p>
                                        <div class="d-grid gap-2">
                                            <a href="{{ url_for('tasks.local_portal', location_id=location.id) }}" 
                                            class="btn btn-primary">
                                                <i class="bi bi-door-open"></i> Acceder al Portal
                                            </a>
                                            <a href="{{ url_for('tasks.list_local_users', location_id=location.id) }}" 
                                            class="btn btn-outline-secondary">
                                                <i class="bi bi-people"></i> Usuarios ({{ location.local_users|length }})
                                            </a>
                                            <a href="{{ url_for('tasks.list_tasks', location_id=location.id) }}" 
                                            class="btn btn-outline-secondary">
                                                <i class="bi bi-list-check"></i> Tareas ({{ location.tasks|length }})
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4 bg-light rounded">
                            <i class="bi bi-building-add text-muted fs-1"></i>
                            <p class="mt-3">No hay locales disponibles. Primero debes crear un local.</p>
                            <a href="{{ url_for('tasks.create_location') }}" class="btn btn-success">
                                <i class="bi bi-plus-circle"></i> Crear Nuevo Local
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<style>
    .location-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0,0,0,0.125);
    }
    
    .location-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        border-color: var(--bs-primary);
    }
    
    .hover-card {
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: pointer;
    }
    
    .hover-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.2);
    }
    
    #tasks-section .card-header,
    #locations-section .card-header {
        border-radius: 0.5rem 0.5rem 0 0;
    }
    
    .section-link:target {
        scroll-margin-top: 80px;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Estado de tareas (gráfico de dona)
    const ctxStatus = document.getElementById('taskStatusChart');
    if (ctxStatus) {
        new Chart(ctxStatus, {
            type: 'doughnut',
            data: {
                labels: ['Pendientes', 'Completadas', 'Vencidas'],
                datasets: [{
                    data: [{{ stats.tasks_pending }}, {{ stats.tasks_completed_today }}, {{ stats.tasks_expired }}],
                    backgroundColor: [
                        'rgba(255, 193, 7, 0.6)',
                        'rgba(40, 167, 69, 0.6)',
                        'rgba(220, 53, 69, 0.6)'
                    ],
                    borderColor: [
                        'rgba(255, 193, 7, 1)',
                        'rgba(40, 167, 69, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Suave scroll a secciones
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth'
                });
            }
        });
    });
});
</script>
{% endblock %}