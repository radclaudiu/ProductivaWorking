{% extends "tasks/portal_layout.html" %}
{% block content %}
<div class="container mb-5 mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="fas fa-cogs me-2"></i>Configuración del Portal</h4>
        </div>
        <div class="card-body">
            <h5 class="mb-4">Configuración de Impresoras</h5>

            <!-- Lista de impresoras configuradas -->
            <div class="mb-4">
                <h6>Impresoras Disponibles</h6>
                {% if printers %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Nombre</th>
                                <th>Estado</th>
                                <th>Predeterminada</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for printer in printers %}
                            <tr>
                                <td>{{ printer.printer_name }}</td>
                                <td>
                                    {% if printer.is_active %}
                                    <span class="badge bg-success">Activa</span>
                                    {% else %}
                                    <span class="badge bg-danger">Inactiva</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if printer.is_default %}
                                    <span class="badge bg-primary">Predeterminada</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('tasks.local_user_config', printer_id=printer.id) }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-edit"></i> Editar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>No hay impresoras configuradas. Añade una impresora para generar etiquetas.
                </div>
                {% endif %}
            </div>

            <!-- Formulario para añadir/editar impresora -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    {% if printer_to_edit %}
                    <h6 class="mb-0">Editar Impresora</h6>
                    {% else %}
                    <h6 class="mb-0">Añadir Nueva Impresora</h6>
                    {% endif %}
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('tasks.local_user_config') }}">
                        {{ form.hidden_tag() }}
                        
                        {% if printer_to_edit %}
                        <input type="hidden" name="printer_id" value="{{ printer_to_edit.id }}">
                        {% endif %}
                        
                        <div class="mb-3">
                            <label for="printer_name" class="form-label">{{ form.printer_name.label }}</label>
                            {{ form.printer_name(class="form-control form-control-lg", placeholder="Nombre de la impresora") }}
                            {% if form.printer_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.printer_name.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text text-muted">
                                Ingresa el nombre exacto de la impresora como aparece en el sistema
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.is_default(class="form-check-input") }}
                                <label class="form-check-label" for="is_default">{{ form.is_default.label }}</label>
                            </div>
                            <div class="form-text text-muted">
                                Marca esta opción para usar esta impresora como predeterminada para las etiquetas
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.is_active(class="form-check-input") }}
                                <label class="form-check-label" for="is_active">{{ form.is_active.label }}</label>
                            </div>
                            <div class="form-text text-muted">
                                Desactiva temporalmente una impresora sin eliminarla
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                {% if printer_to_edit %}
                                Actualizar Impresora
                                {% else %}
                                Guardar Impresora
                                {% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Información sobre la detección de impresoras -->
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle me-2"></i>Información sobre las impresoras</h6>
                <p class="mb-0">
                    Para imprimir etiquetas correctamente, debe configurar al menos una impresora.
                    El nombre de la impresora debe coincidir exactamente con el nombre que aparece en el sistema.
                    La aplicación intentará usar la impresora predeterminada al generar etiquetas.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Activar automáticamente el teclado en pantalla al hacer clic en el campo de nombre de impresora
    document.addEventListener('DOMContentLoaded', function() {
        var printerInput = document.getElementById('printer_name');
        if (printerInput) {
            printerInput.addEventListener('focus', function() {
                if ('virtualKeyboard' in navigator) {
                    navigator.virtualKeyboard.show();
                }
            });
        }
    });
</script>
{% endblock %}