{% extends "tasks/portal_layout.html" %}

{% block content %}
<!-- Modal de Configuración de Impresora Brother Bluetooth -->
<div id="printerSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; overflow-y: auto;">
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040;"></div>
    <div style="position: relative; width: 80%; max-width: 800px; margin: 30px auto; margin-bottom: 50px; z-index: 1050;">
        <div class="card">
            <div class="card-header bg-earth-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bluetooth me-2"></i>Brother TD-4550DNWB</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeModal()" aria-label="Close"></button>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-bluetooth me-2"></i>Impresora Brother TD-4550DNWB conectada vía Bluetooth. Esta función solo está disponible en la aplicación Android con el SDK Brother integrado.
                        </div>
                    </div>
                </div>
                
                <!-- Estado de Conexión Brother -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">Estado de Conexión</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="bi bi-bluetooth display-4 text-primary mb-2"></i>
                                    <h6>Estado de Impresora</h6>
                                    <p id="printerStatus" class="mb-2">No disponible (ejecutar en app Android)</p>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="verificarEstadoImpresora()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Verificar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="bi bi-search display-4 text-success mb-2"></i>
                                    <h6>Buscar Impresoras</h6>
                                    <p class="mb-2">Buscar impresoras Brother disponibles</p>
                                    <button type="button" class="btn btn-success btn-sm" onclick="buscarImpresoras()">
                                        <i class="bi bi-search me-1"></i>Buscar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista Previa de Etiqueta -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">Vista Previa de Etiqueta (520x449px)</h6>
                    <div class="text-center">
                        <canvas id="labelCanvas" width="520" height="449" style="border: 2px solid #ddd; max-width: 100%; height: auto;"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="productName" class="form-label">Producto</label>
                                <input type="text" class="form-control" id="productName" value="POLLO EMPANADO" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-6">
                                <label for="conservationType" class="form-label">Conservación</label>
                                <select class="form-select" id="conservationType" onchange="generarVistaPrevia()">
                                    <option value="REFRIGERACIÓN" selected>REFRIGERACIÓN</option>
                                    <option value="DESCONGELACIÓN">DESCONGELACIÓN</option>
                                    <option value="GASTRO">GASTRO</option>
                                    <option value="CALIENTE">CALIENTE</option>
                                    <option value="SECO">SECO</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <label for="employee" class="form-label">Empleado</label>
                                <input type="text" class="form-control" id="employee" value="Juan Pérez" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-4">
                                <label for="startDateTime" class="form-label">Fecha/Hora Inicio</label>
                                <input type="datetime-local" class="form-control" id="startDateTime" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-4">
                                <label for="shelfLife" class="form-label">Vida Útil (días)</label>
                                <input type="number" class="form-control" id="shelfLife" value="3" min="1" max="30" onchange="generarVistaPrevia()">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label for="quantity" class="form-label">Cantidad</label>
                                <input type="number" class="form-control" id="quantity" value="1" min="1" max="10" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" onclick="imprimirEtiquetas()">
                                    <i class="bi bi-printer me-1"></i>Imprimir Etiquetas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mensajes de Estado -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="bi bi-info-circle me-2"></i>Mensajes del Sistema</h6>
                                <div id="statusMessage" class="status" style="display: none;"></div>
                                <div class="alert alert-info">
                                    <i class="bi bi-bluetooth me-2"></i>La impresora Brother TD-4550DNWB se conecta automáticamente vía Bluetooth cuando se ejecuta desde la aplicación Android.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
                <button type="button" class="btn btn-success" onclick="buscarImpresoras()">
                    <i class="bi bi-search me-1"></i>Buscar Impresoras
                </button>
                <button type="button" class="btn btn-primary" onclick="generarVistaPrevia()">
                    <i class="bi bi-eye me-1"></i>Actualizar Vista Previa
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-earth-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-tag-fill me-2"></i>Etiquetas de Productos - {{ location.name }}</h5>
                    <div>
                        <button type="button" class="btn btn-primary btn-sm me-2" id="openPrinterModal">
                            <i class="bi bi-bluetooth me-1"></i> Brother TD-4550DNWB
                        </button>
                        <a href="{{ url_for('tasks.local_user_tasks') }}" class="btn btn-light btn-sm">
                            <i class="bi bi-list-check me-1"></i> Volver a Tareas
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Barra de Estado de Impresora Brother TD-4550DNWB -->
                    <div class="alert alert-light border mb-4" style="border-left: 4px solid #007bff !important;">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-bluetooth fs-4 text-primary me-3"></i>
                                    <div>
                                        <h6 class="mb-1">Brother TD-4550DNWB</h6>
                                        <p id="printer-status-bar" class="mb-0 text-muted">Verificando estado...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <span id="printer-badge-bar" class="badge bg-secondary me-2">
                                    <i class="bi bi-bluetooth me-1"></i>Verificando...
                                </span>
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="verificarEstadoImpresora()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Verificar
                                </button>
                                <button type="button" class="btn btn-success btn-sm" onclick="enviarEtiquetaPrueba()">
                                    <i class="bi bi-printer me-1"></i>Prueba
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mensaje de confirmación de impresión (oculto por defecto) -->
                    <div id="print-success-message" class="alert alert-success mb-3" style="display: none;">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>¡Etiqueta impresa correctamente!</strong> La impresión se ha enviado a la impresora Brother TD-4550DNWB.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <p>
                                Seleccione un producto de la lista para generar etiquetas, o utilice el buscador para encontrar rápidamente.
                            </p>
                        </div>
                        <div class="col-md-6">
                            <div class="text-md-end">
                                <div class="printer-status d-inline-block">
                                    <span class="badge bg-secondary me-1" id="printerStatusBadge">
                                        <i class="bi bi-bluetooth me-1"></i> Brother TD-4550DNWB
                                    </span>
                                    <button type="button" class="btn btn-sm btn-info" onclick="verificarEstadoImpresora()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not products %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>No hay productos disponibles. Contacte con un administrador.
        </div>
    {% else %}
        <!-- Buscador -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <form action="{{ url_for('tasks.local_user_labels') }}" method="get">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" name="q" class="form-control form-control-lg" 
                                    placeholder="Buscar producto..." 
                                    value="{{ search_query }}" 
                                    autocomplete="off" 
                                    autofocus>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search me-1"></i>Buscar
                                </button>
                                {% if search_query %}
                                <a href="{{ url_for('tasks.local_user_labels') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle me-1"></i>Limpiar
                                </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de productos -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
            {% for product in products %}
            <div class="col">
                <div class="card h-100 shadow-sm product-card">
                    <div class="card-body d-flex flex-column">
                        <div class="product-icon text-center mb-2">
                            <i class="bi bi-box-seam display-1"></i>
                        </div>
                        <h5 class="card-title text-center mb-3">{{ product.name }}</h5>
                        <div class="conservation-types small mb-3">
                            <div class="d-flex flex-wrap justify-content-center gap-1">
                                {% if product.conservation_types %}
                                    {% for ct in product.conservation_types %}
                                        <span class="badge rounded-pill {% if ct.conservation_type.value == 'descongelacion' %}bg-primary{% elif ct.conservation_type.value == 'refrigeracion' %}bg-info{% elif ct.conservation_type.value == 'gastro' %}bg-success{% elif ct.conservation_type.value == 'caliente' %}bg-danger{% else %}bg-warning{% endif %}">
                                            {% if ct.conservation_type.value == 'descongelacion' %}
                                                <i class="bi bi-snow me-1"></i>
                                            {% elif ct.conservation_type.value == 'refrigeracion' %}
                                                <i class="bi bi-thermometer-snow me-1"></i>
                                            {% elif ct.conservation_type.value == 'gastro' %}
                                                <i class="bi bi-cup-hot me-1"></i>
                                            {% elif ct.conservation_type.value == 'caliente' %}
                                                <i class="bi bi-fire me-1"></i>
                                            {% else %}
                                                <i class="bi bi-droplet me-1"></i>
                                            {% endif %}
                                            {{ ct.conservation_type.value|capitalize }}
                                        </span>
                                    {% endfor %}
                                {% else %}
                                    <span class="badge bg-secondary">Sin tipos de conservación</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Área de botones de etiquetas -->
                        <div class="mt-auto">
                            {% if product.conservation_types %}
                                {% for ct in product.conservation_types %}
                                <div class="mb-2">
                                    <a href="{{ url_for('tasks.product_conservation_selection', product_id=product.id) }}?conservation_type_id={{ ct.conservation_type.id }}" 
                                       class="btn btn-olive btn-sm w-100">
                                        <i class="bi bi-tag-fill me-1"></i>
                                        Etiqueta {{ ct.conservation_type.value|capitalize }}
                                    </a>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-warning small">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    No hay tipos de conservación configurados para este producto.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if search_query and not products %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle-fill me-2"></i>No se encontraron productos que coincidan con la búsqueda "{{ search_query }}".
            <a href="{{ url_for('tasks.local_user_labels') }}" class="btn btn-outline-primary btn-sm ms-2">
                <i class="bi bi-x-circle me-1"></i>Ver todos los productos
            </a>
        </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Función para forzar solicitud de permisos de impresora
    function forzarSolicitudPermisos() {
        if (typeof AndroidBridge !== 'undefined') {
            console.log('Forzando solicitud de permisos Bluetooth...');
            // Esto forzará la solicitud de permisos si no están otorgados
            AndroidBridge.searchPrinters();
        } else {
            console.log('AndroidBridge no disponible');
        }
    }
    
    // Configurar callbacks globales para Brother Print - Exactamente como especificado
    window.BrotherPrint = {
        onPrintersFound: function(data) {
            console.log('Callback onPrintersFound recibido:', data);
            mostrarEstado('Impresoras encontradas, procesando...', 'info');
            
            try {
                const printers = JSON.parse(data);
                console.log('Impresoras parseadas:', printers.length);
                
                if (printers.length === 0) {
                    mostrarEstado('No se encontraron impresoras Brother TD-4550DNWB', 'error');
                    return;
                }
                
                // Auto-conectar con la primera impresora TD-4550DNWB encontrada
                const brotherPrinter = printers.find(p => p.name && p.name.includes('TD-4550')) || printers[0];
                if (brotherPrinter) {
                    console.log('Conectando automáticamente con:', brotherPrinter.name);
                    mostrarEstado('Conectando con ' + brotherPrinter.name + '...', 'info');
                    AndroidBridge.connectPrinter(brotherPrinter.address);
                }
            } catch (e) {
                console.error('Error parseando impresoras:', e);
                mostrarEstado('Error al procesar lista de impresoras: ' + e.message, 'error');
            }
        },
        
        onPrinterConnected: function(data) {
            console.log('Callback onPrinterConnected recibido:', data);
            
            try {
                const result = JSON.parse(data);
                mostrarEstado('Conectado exitosamente: ' + result.mac, 'success');
                console.log('Impresora conectada - MAC:', result.mac);
            } catch (e) {
                mostrarEstado('Impresora Brother TD-4550DNWB conectada correctamente', 'success');
            }
            
            // Actualizar estado después de conexión exitosa
            setTimeout(() => {
                verificarEstadoImpresora();
            }, 500);
        },
        
        onPrintSuccess: function(data) {
            console.log('Callback onPrintSuccess recibido:', data);
            
            try {
                const result = JSON.parse(data);
                mostrarEstado('Impresión completada: ' + result.message, 'success');
                console.log('Impresión exitosa - Mensaje:', result.message);
            } catch (e) {
                mostrarEstado('Etiqueta Brother TD-4550DNWB impresa correctamente', 'success');
            }
            
            // Si hay más etiquetas pendientes, continuar
            if (etiquetasPendientes > 1) {
                etiquetasPendientes--;
                setTimeout(() => {
                    imprimirSiguienteEtiqueta();
                }, 1000);
            }
        },
        
        onPrintError: function(data) {
            console.log('Callback onPrintError recibido:', data);
            
            try {
                const error = JSON.parse(data);
                mostrarEstado('Error de impresión: ' + error.error, 'error');
                console.log('Error detallado:', error.error);
                
                if (error.error.includes('No hay impresora conectada')) {
                    setTimeout(() => {
                        verificarEstadoImpresora();
                    }, 500);
                }
            } catch (e) {
                mostrarEstado('Error de impresión: ' + data, 'error');
            }
            etiquetasPendientes = 0;
        }
    };

    let etiquetasPendientes = 0;
    let datosEtiqueta = null;

    // Función para cerrar el modal
    function closeModal() {
        const modalElement = document.getElementById('printerSettingsModal');
        if (modalElement) {
            modalElement.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    
    // Establecer fecha y hora actual
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const startDateTimeInput = document.getElementById('startDateTime');
        if (startDateTimeInput) {
            startDateTimeInput.value = now.toISOString().slice(0, 16);
        }
        
        // Generar vista previa inicial
        generarVistaPrevia();
        
        // Verificar estado de la impresora
        verificarEstadoImpresora();
        
        // Forzar solicitud de permisos Bluetooth al cargar la página
        setTimeout(forzarSolicitudPermisos, 1500);
        
        // Configurar evento para abrir modal
        const openPrinterModalBtn = document.getElementById('openPrinterModal');
        if (openPrinterModalBtn) {
            openPrinterModalBtn.addEventListener('click', function() {
                const modalElement = document.getElementById('printerSettingsModal');
                if (modalElement) {
                    modalElement.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                }
            });
        }
    });

    function verificarEstadoImpresora() {
        const statusElement = document.getElementById('printerStatus');
        const badgeElement = document.getElementById('printerStatusBadge');
        const statusBarElement = document.getElementById('printer-status-bar');
        const badgeBarElement = document.getElementById('printer-badge-bar');
        
        if (typeof AndroidBridge === 'undefined') {
            const mensaje = 'No disponible (ejecutar en app Android)';
            if (statusElement) statusElement.textContent = mensaje;
            if (statusBarElement) statusBarElement.textContent = mensaje;
            if (badgeElement) {
                badgeElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> No disponible';
                badgeElement.className = 'badge bg-secondary me-1';
            }
            if (badgeBarElement) {
                badgeBarElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> No disponible';
                badgeBarElement.className = 'badge bg-secondary me-2';
            }
            return;
        }
        
        try {
            // Usar AndroidBridge.getPrinterStatus() exactamente como especificado
            console.log('Llamando AndroidBridge.getPrinterStatus()');
            AndroidBridge.getPrinterStatus();
            
            // Intentar obtener estado sincrónico si está disponible
            try {
                const status = JSON.parse(AndroidBridge.getPrinterStatus());
                if (status.connected) {
                    const mensaje = `Conectada: ${status.printerName} (${status.printerAddress})`;
                    if (statusElement) {
                        statusElement.textContent = mensaje;
                        statusElement.style.color = '#28a745';
                    }
                    if (statusBarElement) {
                        statusBarElement.textContent = `Conectada: ${status.printerName}`;
                        statusBarElement.style.color = '#28a745';
                    }
                    if (badgeElement) {
                        badgeElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> Conectada';
                        badgeElement.className = 'badge bg-success me-1';
                    }
                    if (badgeBarElement) {
                        badgeBarElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> Conectada';
                        badgeBarElement.className = 'badge bg-success me-2';
                    }
                } else if (status.configured) {
                    const mensaje = `Configurada pero desconectada: ${status.savedPrinterName}`;
                    if (statusElement) {
                        statusElement.textContent = mensaje;
                        statusElement.style.color = '#ffc107';
                    }
                    if (statusBarElement) {
                        statusBarElement.textContent = `Desconectada: ${status.savedPrinterName}`;
                        statusBarElement.style.color = '#ffc107';
                    }
                    if (badgeElement) {
                        badgeElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> Configurada';
                        badgeElement.className = 'badge bg-warning me-1';
                    }
                    if (badgeBarElement) {
                        badgeBarElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> Desconectada';
                        badgeBarElement.className = 'badge bg-warning me-2';
                    }
                } else {
                    const mensaje = 'No configurada (pulsa "Buscar Impresoras")';
                    if (statusElement) {
                        statusElement.textContent = mensaje;
                        statusElement.style.color = '#dc3545';
                    }
                    if (statusBarElement) {
                        statusBarElement.textContent = 'No configurada';
                        statusBarElement.style.color = '#dc3545';
                    }
                    if (badgeElement) {
                        badgeElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> No configurada';
                        badgeElement.className = 'badge bg-danger me-1';
                    }
                    if (badgeBarElement) {
                        badgeBarElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> No configurada';
                        badgeBarElement.className = 'badge bg-danger me-2';
                    }
                }
        } catch (e) {
            const mensaje = 'Error al verificar estado';
            if (statusElement) statusElement.textContent = mensaje;
            if (badgeElement) {
                badgeElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> Error';
                badgeElement.className = 'badge bg-danger me-1';
            }
        }
    }

    function buscarImpresoras() {
        if (typeof AndroidBridge === 'undefined') {
            mostrarEstado('AndroidBridge no disponible - Ejecutar en aplicación Android', 'error');
            return;
        }
        
        console.log('Llamando AndroidBridge.searchPrinters()');
        mostrarEstado('Buscando impresoras Brother TD-4550DNWB...', 'info');
        AndroidBridge.searchPrinters();
    }

    function desconectarImpresora() {
        if (typeof AndroidBridge === 'undefined') {
            mostrarEstado('AndroidBridge no disponible', 'error');
            return;
        }

        console.log('Llamando AndroidBridge.disconnectPrinter()');
        mostrarEstado('Desconectando impresora Brother...', 'info');
        AndroidBridge.disconnectPrinter();
    }

    function enviarEtiquetaPrueba() {
        if (typeof AndroidBridge === 'undefined') {
            mostrarEstado('Esta función solo está disponible en la aplicación Android', 'error');
            return;
        }

        if (typeof AndroidBridge.printImage !== 'function') {
            mostrarEstado('Método de impresión no disponible', 'error');
            return;
        }

        // Datos de etiqueta de prueba
        const datosEtiquetaPrueba = {
            productName: 'ETIQUETA DE PRUEBA',
            conservationType: 'Brother TD-4550DNWB',
            preparedBy: 'Preparado por: Sistema',
            startDate: 'Fecha: ' + new Date().toLocaleDateString('es-ES'),
            expiryDate: 'Hora: ' + new Date().toLocaleTimeString('es-ES')
        };

        try {
            // Generar canvas de prueba usando el script brother-simple-print.js
            const canvas = createLabelCanvas(datosEtiquetaPrueba);
            const base64 = canvas.toDataURL('image/png').replace(/^data:image\/png;base64,/, '');
            
            console.log('Llamando AndroidBridge.printImage() con etiqueta de prueba');
            console.log('Base64 generado, longitud:', base64.length);
            mostrarEstado('Enviando etiqueta de prueba a Brother TD-4550DNWB...', 'info');
            
            AndroidBridge.printImage(base64);
            
        } catch (error) {
            console.error('Error enviando etiqueta de prueba:', error);
            mostrarEstado('Error al enviar etiqueta de prueba: ' + error.message, 'error');
        }
    }

    function calcularFechaCaducidad(fechaInicio, diasVidaUtil) {
        const fecha = new Date(fechaInicio);
        fecha.setDate(fecha.getDate() + parseInt(diasVidaUtil));
        return fecha;
    }

    function formatearFecha(fecha) {
        const opciones = { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return fecha.toLocaleString('es-ES', opciones);
    }

    function generarVistaPrevia() {
        const productNameElement = document.getElementById('productName');
        const conservationTypeElement = document.getElementById('conservationType');
        const employeeElement = document.getElementById('employee');
        const startDateTimeElement = document.getElementById('startDateTime');
        const shelfLifeElement = document.getElementById('shelfLife');
        const quantityElement = document.getElementById('quantity');
        
        if (!productNameElement || !conservationTypeElement || !employeeElement || 
            !startDateTimeElement || !shelfLifeElement || !quantityElement) {
            console.log('Algunos elementos del formulario no están disponibles');
            return;
        }
        
        const productName = productNameElement.value;
        const conservationType = conservationTypeElement.value;
        const employee = employeeElement.value;
        const startDateTime = new Date(startDateTimeElement.value);
        const shelfLife = shelfLifeElement.value;
        
        const fechaCaducidad = calcularFechaCaducidad(startDateTime, shelfLife);
        
        datosEtiqueta = {
            productName: productName,
            conservationType: conservationType,
            preparedBy: `EMP: ${employee}`,
            startDate: `INICIO: ${formatearFecha(startDateTime)}`,
            expiryDate: `Caducidad: ${formatearFecha(fechaCaducidad)}`,
            quantity: parseInt(quantityElement.value)
        };
        
        dibujarEtiqueta(datosEtiqueta);
    }

    function dibujarEtiqueta(datos) {
        const canvas = document.getElementById('labelCanvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Limpiar canvas con fondo blanco
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Configurar estilos base
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        
        // NOMBRE DEL PRODUCTO (más grande y centrado)
        ctx.font = 'bold 36px Arial';
        const nombreProducto = datos.productName.toUpperCase();
        
        // Si el texto es muy largo, reducir tamaño de fuente
        if (nombreProducto.length > 15) {
            ctx.font = 'bold 28px Arial';
        }
        ctx.fillText(nombreProducto, canvas.width / 2, 60);
        
        // TIPO DE CONSERVACIÓN
        ctx.font = 'bold 26px Arial';
        ctx.fillText(datos.conservationType, canvas.width / 2, 110);
        
        // Línea divisoria
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(30, 140);
        ctx.lineTo(canvas.width - 30, 140);
        ctx.stroke();
        
        // Información adicional (alineada a la izquierda)
        ctx.textAlign = 'left';
        const leftMargin = 35;
        
        // Empleado
        ctx.font = '20px Arial';
        ctx.fillText(datos.preparedBy, leftMargin, 185);
        
        // Fecha de inicio
        ctx.font = '20px Arial';
        ctx.fillText(datos.startDate, leftMargin, 225);
        
        // Línea divisoria antes de caducidad
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(30, 250);
        ctx.lineTo(canvas.width - 30, 250);
        ctx.stroke();
        
        // FECHA DE CADUCIDAD (más prominente)
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = '#d32f2f'; // Rojo para destacar
        
        // Dividir la fecha de caducidad si es muy larga
        const caducidadTexto = datos.expiryDate;
        if (caducidadTexto.length > 30) {
            const partes = caducidadTexto.split(' ');
            ctx.fillText(partes.slice(0, 2).join(' '), leftMargin, 290);
            ctx.fillText(partes.slice(2).join(' '), leftMargin, 320);
        } else {
            ctx.fillText(caducidadTexto, leftMargin, 300);
        }
        
        // Código QR o identificador (opcional)
        ctx.fillStyle = 'black';
        ctx.font = '14px monospace';
        ctx.textAlign = 'right';
        const codigoLote = `LOT${Date.now().toString().slice(-6)}`;
        ctx.fillText(codigoLote, canvas.width - 35, canvas.height - 20);
        
        // Borde de la etiqueta
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 3;
        ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
    }

    function imprimirEtiquetas() {
        if (typeof AndroidBridge === 'undefined') {
            alert('Esta función solo está disponible en la aplicación Android');
            return;
        }
        
        if (!datosEtiqueta) {
            generarVistaPrevia();
        }
        
        etiquetasPendientes = datosEtiqueta.quantity;
        mostrarEstado(`Imprimiendo ${etiquetasPendientes} etiqueta(s)...`, 'info');
        
        imprimirSiguienteEtiqueta();
    }

    function imprimirSiguienteEtiqueta() {
        if (etiquetasPendientes <= 0) {
            return;
        }
        
        const canvas = document.getElementById('labelCanvas');
        if (!canvas) return;
        
        const base64 = canvas.toDataURL('image/png').replace('data:image/png;base64,', '');
        
        // Actualizar estado
        if (etiquetasPendientes > 1) {
            mostrarEstado(`Imprimiendo etiqueta ${datosEtiqueta.quantity - etiquetasPendientes + 1} de ${datosEtiqueta.quantity}...`, 'info');
        }
        
        // Enviar a imprimir
        AndroidBridge.printImage(base64);
    }

    function mostrarEstado(mensaje, tipo) {
        const statusDiv = document.getElementById('statusMessage');
        if (!statusDiv) return;
        
        statusDiv.textContent = mensaje;
        statusDiv.className = 'status ' + tipo;
        statusDiv.style.display = 'block';
        
        // Ocultar después de 5 segundos si es éxito
        if (tipo === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    }

    // Agregar estilos CSS para los estados de mensaje
    const style = document.createElement('style');
    style.textContent = `
        .status.info { color: #0c7cd5; background-color: #d7edff; padding: 8px; border-radius: 4px; }
        .status.success { color: #28a745; background-color: #d4edda; padding: 8px; border-radius: 4px; }
        .status.error { color: #dc3545; background-color: #f8d7da; padding: 8px; border-radius: 4px; }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}