{% extends "tasks/portal_layout.html" %}

{% block content %}
<!-- Modal de Configuraci√≥n de Impresora Brother Bluetooth -->
<div id="printerSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; overflow-y: auto;">
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040;"></div>
    <div style="position: relative; width: 80%; max-width: 800px; margin: 30px auto; margin-bottom: 50px; z-index: 1050;">
        <div class="card">
            <div class="card-header bg-earth-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bluetooth me-2"></i>Brother TD-4550DNWB</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeModal()" aria-label="Close"></button>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-bluetooth me-2"></i>Impresora Brother TD-4550DNWB conectada v√≠a Bluetooth. Esta funci√≥n solo est√° disponible en la aplicaci√≥n Android con el SDK Brother integrado.
                        </div>
                    </div>
                </div>
                
                <!-- Estado de Conexi√≥n Brother -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">Estado de Conexi√≥n</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="bi bi-bluetooth display-4 text-primary mb-2"></i>
                                    <h6>Estado de Impresora</h6>
                                    <p id="printerStatus" class="mb-2">No disponible (ejecutar en app Android)</p>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="verificarEstadoImpresora()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Verificar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="bi bi-search display-4 text-success mb-2"></i>
                                    <h6>Buscar Impresoras</h6>
                                    <p class="mb-2">Buscar impresoras Brother disponibles</p>
                                    <button type="button" class="btn btn-success btn-sm" onclick="buscarImpresoras()">
                                        <i class="bi bi-search me-1"></i>Buscar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista Previa de Etiqueta -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">Vista Previa de Etiqueta (520x449px)</h6>
                    <div class="text-center">
                        <canvas id="labelCanvas" width="520" height="449" style="border: 2px solid #ddd; max-width: 100%; height: auto;"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="productName" class="form-label">Producto</label>
                                <input type="text" class="form-control" id="productName" value="POLLO EMPANADO" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-6">
                                <label for="conservationType" class="form-label">Conservaci√≥n</label>
                                <select class="form-select" id="conservationType" onchange="generarVistaPrevia()">
                                    <option value="REFRIGERACI√ìN" selected>REFRIGERACI√ìN</option>
                                    <option value="DESCONGELACI√ìN">DESCONGELACI√ìN</option>
                                    <option value="GASTRO">GASTRO</option>
                                    <option value="CALIENTE">CALIENTE</option>
                                    <option value="SECO">SECO</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <label for="employee" class="form-label">Empleado</label>
                                <input type="text" class="form-control" id="employee" value="Juan P√©rez" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-4">
                                <label for="startDateTime" class="form-label">Fecha/Hora Inicio</label>
                                <input type="datetime-local" class="form-control" id="startDateTime" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-4">
                                <label for="shelfLife" class="form-label">Vida √ötil (d√≠as)</label>
                                <input type="number" class="form-control" id="shelfLife" value="3" min="1" max="30" onchange="generarVistaPrevia()">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label for="quantity" class="form-label">Cantidad</label>
                                <input type="number" class="form-control" id="quantity" value="1" min="1" max="10" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" onclick="imprimirEtiquetas()">
                                    <i class="bi bi-printer me-1"></i>Imprimir Etiquetas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mensajes de Estado -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="bi bi-info-circle me-2"></i>Mensajes del Sistema</h6>
                                <div id="statusMessage" class="status" style="display: none;"></div>
                                <div class="alert alert-info">
                                    <i class="bi bi-bluetooth me-2"></i>La impresora Brother TD-4550DNWB se conecta autom√°ticamente v√≠a Bluetooth cuando se ejecuta desde la aplicaci√≥n Android.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
                <button type="button" class="btn btn-success" onclick="buscarImpresoras()">
                    <i class="bi bi-search me-1"></i>Buscar Impresoras
                </button>
                <button type="button" class="btn btn-primary" onclick="generarVistaPrevia()">
                    <i class="bi bi-eye me-1"></i>Actualizar Vista Previa
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-earth-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-tag-fill me-2"></i>Etiquetas de Productos - {{ location.name }}</h5>
                    <div>
                        <button type="button" class="btn btn-primary btn-sm me-2" id="openPrinterModal">
                            <i class="bi bi-bluetooth me-1"></i> Brother TD-4550DNWB
                        </button>
                        <a href="{{ url_for('tasks.local_user_tasks') }}" class="btn btn-light btn-sm">
                            <i class="bi bi-list-check me-1"></i> Volver a Tareas
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Barra de Estado de Impresora Brother TD-4550DNWB -->
                    <div class="alert alert-light border mb-4" style="border-left: 4px solid #007bff !important;">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-bluetooth fs-4 text-primary me-3"></i>
                                    <div>
                                        <h6 class="mb-1">Brother TD-4550DNWB</h6>
                                        <p id="printer-status-bar" class="mb-0 text-muted">Verificando estado...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <span id="printer-badge-bar" class="badge bg-secondary me-2">
                                    <i class="bi bi-bluetooth me-1"></i>Verificando...
                                </span>
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="verificarEstadoImpresora()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Verificar
                                </button>
                                <button type="button" class="btn btn-success btn-sm" onclick="enviarEtiquetaPrueba()">
                                    <i class="bi bi-printer me-1"></i>Prueba
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mensaje de confirmaci√≥n de impresi√≥n (oculto por defecto) -->
                    <div id="print-success-message" class="alert alert-success mb-3" style="display: none;">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>¬°Etiqueta impresa correctamente!</strong> La impresi√≥n se ha enviado a la impresora Brother TD-4550DNWB.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <p>
                                Seleccione un producto de la lista para generar etiquetas, o utilice el buscador para encontrar r√°pidamente.
                            </p>
                        </div>
                        <div class="col-md-6">
                            <div class="text-md-end">
                                <div class="printer-status d-inline-block">
                                    <span class="badge bg-secondary me-1" id="printerStatusBadge">
                                        <i class="bi bi-bluetooth me-1"></i> Brother TD-4550DNWB
                                    </span>
                                    <button type="button" class="btn btn-sm btn-info" onclick="verificarEstadoImpresora()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not products %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>No hay productos disponibles. Contacte con un administrador.
        </div>
    {% else %}
        <!-- Buscador -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <form action="{{ url_for('tasks.local_user_labels') }}" method="get">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" name="q" class="form-control form-control-lg" 
                                    placeholder="Buscar producto..." 
                                    value="{{ search_query }}" 
                                    autocomplete="off" 
                                    autofocus>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search me-1"></i>Buscar
                                </button>
                                {% if search_query %}
                                <a href="{{ url_for('tasks.local_user_labels') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle me-1"></i>Limpiar
                                </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de productos -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
            {% for product in products %}
            <div class="col">
                <div class="card h-100 shadow-sm product-card">
                    <div class="card-body d-flex flex-column">
                        <div class="product-icon text-center mb-2">
                            <i class="bi bi-box-seam display-1"></i>
                        </div>
                        <h5 class="card-title text-center mb-3">{{ product.name }}</h5>
                        <div class="conservation-types small mb-3">
                            <div class="d-flex flex-wrap justify-content-center gap-1">
                                {% if product.conservation_types %}
                                    {% for ct in product.conservation_types %}
                                        <span class="badge rounded-pill {% if ct.conservation_type.value == 'descongelacion' %}bg-primary{% elif ct.conservation_type.value == 'refrigeracion' %}bg-info{% elif ct.conservation_type.value == 'gastro' %}bg-success{% elif ct.conservation_type.value == 'caliente' %}bg-danger{% else %}bg-warning{% endif %}">
                                            {% if ct.conservation_type.value == 'descongelacion' %}
                                                <i class="bi bi-snow me-1"></i>
                                            {% elif ct.conservation_type.value == 'refrigeracion' %}
                                                <i class="bi bi-thermometer-snow me-1"></i>
                                            {% elif ct.conservation_type.value == 'gastro' %}
                                                <i class="bi bi-cup-hot me-1"></i>
                                            {% elif ct.conservation_type.value == 'caliente' %}
                                                <i class="bi bi-fire me-1"></i>
                                            {% else %}
                                                <i class="bi bi-droplet me-1"></i>
                                            {% endif %}
                                            {{ ct.conservation_type.value|capitalize }}
                                        </span>
                                    {% endfor %}
                                {% else %}
                                    <span class="badge bg-secondary">Sin tipos de conservaci√≥n</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- √Årea de botones de etiquetas -->
                        <div class="mt-auto">
                            {% if product.conservation_types %}
                                {% for ct in product.conservation_types %}
                                <div class="mb-2">
                                    <a href="{{ url_for('tasks.product_conservation_selection', product_id=product.id) }}?conservation_type_id={{ ct.conservation_type.id }}" 
                                       class="btn btn-olive btn-sm w-100">
                                        <i class="bi bi-tag-fill me-1"></i>
                                        Etiqueta {{ ct.conservation_type.value|capitalize }}
                                    </a>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-warning small">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    No hay tipos de conservaci√≥n configurados para este producto.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if search_query and not products %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle-fill me-2"></i>No se encontraron productos que coincidan con la b√∫squeda "{{ search_query }}".
            <a href="{{ url_for('tasks.local_user_labels') }}" class="btn btn-outline-primary btn-sm ms-2">
                <i class="bi bi-x-circle me-1"></i>Ver todos los productos
            </a>
        </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Funci√≥n para forzar solicitud de permisos de impresora
    function forzarSolicitudPermisos() {
        if (typeof AndroidBridge !== 'undefined') {
            console.log('Forzando solicitud de permisos Bluetooth...');
            // Esto forzar√° la solicitud de permisos si no est√°n otorgados
            AndroidBridge.searchPrinters();
        } else {
            console.log('AndroidBridge no disponible');
        }
    }
    
    // Variables globales para estado
    let printerConnected = false;
    let printerName = '';
    let printerAddress = '';
    
    console.log('üöÄ INICIANDO SISTEMA DE IMPRESORA BROTHER TD-4550DNWB');
    console.log('üìä Estado inicial:');
    console.log('- printerConnected:', printerConnected);
    console.log('- AndroidBridge disponible:', typeof AndroidBridge !== 'undefined');
    
    // Configurar callbacks globales para Brother Print - Exactamente como especificado
    console.log('‚öôÔ∏è Configurando callbacks window.BrotherPrint...');
    window.BrotherPrint = {
        onPrintersFound: function(data) {
            console.log('=== CALLBACK onPrintersFound ===');
            console.log('Data recibida:', data);
            console.log('Tipo de data:', typeof data);
            mostrarEstado('Impresoras encontradas, procesando...', 'info');
            
            try {
                let printers;
                
                // Manejar tanto objetos como cadenas JSON
                if (typeof data === 'object' && data !== null) {
                    printers = Array.isArray(data) ? data : [data];
                    console.log('Data es array/objeto directo:', printers);
                } else {
                    printers = JSON.parse(data);
                    console.log('Data parseada como JSON:', printers);
                }
                
                console.log('Impresoras encontradas:', printers.length);
                console.log('Lista completa:', printers);
                
                if (printers.length === 0) {
                    console.log('‚ùå No se encontraron impresoras');
                    mostrarEstado('No se encontraron impresoras. Encienda la impresora TD-4550DNWB.', 'error');
                    actualizarEstadoUI(false, '', '');
                    return;
                }
                
                // Buscar espec√≠ficamente TD-4550DNWB o conectar a la primera disponible
                const brotherPrinter = printers.find(p => 
                    p.name && (p.name.includes('TD-4550') || p.name.includes('Brother'))
                ) || printers[0];
                
                if (brotherPrinter) {
                    console.log('üîÑ Conectando autom√°ticamente con:', brotherPrinter);
                    console.log('- Nombre:', brotherPrinter.name);
                    console.log('- Direcci√≥n:', brotherPrinter.address);
                    
                    mostrarEstado('Reconectando con ' + brotherPrinter.name + '...', 'info');
                    AndroidBridge.connectPrinter(brotherPrinter.address);
                } else {
                    console.log('‚ùå No se encontr√≥ impresora compatible');
                    mostrarEstado('No se encontr√≥ impresora TD-4550DNWB compatible', 'error');
                    actualizarEstadoUI(false, '', '');
                }
            } catch (e) {
                console.error('Error procesando impresoras:', e);
                console.log('Data original que fall√≥:', data);
                console.log('Tipo de data que fall√≥:', typeof data);
                mostrarEstado('Error al procesar lista de impresoras: ' + e.message, 'error');
                actualizarEstadoUI(false, '', '');
            }
        },
        
        onPrinterConnected: function(data) {
            console.log('=== CALLBACK onPrinterConnected ===');
            console.log('Data recibida:', data);
            console.log('Tipo de data:', typeof data);
            
            try {
                let result;
                
                // Manejar tanto objetos como cadenas JSON
                if (typeof data === 'object' && data !== null) {
                    result = data;
                    console.log('Data es objeto directo:', result);
                } else {
                    result = JSON.parse(data);
                    console.log('Data parseada como JSON:', result);
                }
                
                printerConnected = true;
                printerAddress = result.mac || result.address || '';
                printerName = result.name || 'TD-4550DNWB_5707';
                
                console.log('‚úÖ Reconectado autom√°ticamente');
                console.log('Estado actualizado:');
                console.log('- printerConnected:', printerConnected);
                console.log('- printerName:', printerName);
                console.log('- printerAddress:', printerAddress);
                
                const mensaje = printerAddress ? 
                    `Reconectada exitosamente: ${printerName} (${printerAddress})` :
                    `Reconectada exitosamente: ${printerName}`;
                    
                mostrarEstado(mensaje, 'success');
                actualizarEstadoUI(true, printerName, printerAddress);
                
            } catch (e) {
                console.log('Error parseando, usando datos por defecto');
                console.log('Data original:', data);
                console.log('Tipo de data que fall√≥:', typeof data);
                
                // Fallback para reconexi√≥n exitosa
                printerConnected = true;
                printerName = 'TD-4550DNWB_5707';
                printerAddress = '';
                
                console.log('‚úÖ Reconectado autom√°ticamente (modo fallback)');
                mostrarEstado('Impresora TD-4550DNWB reconectada correctamente', 'success');
                actualizarEstadoUI(true, printerName, '');
            }
        },
        
        onStatusUpdate: function(data) {
            console.log('=== CALLBACK onStatusUpdate ===');
            console.log('Data recibida:', data);
            console.log('Tipo de data:', typeof data);
            console.log('Data como string:', String(data));
            
            try {
                let status;
                
                // Si ya es un objeto, usarlo directamente
                if (typeof data === 'object' && data !== null) {
                    status = data;
                    console.log('Data es objeto directo:', status);
                } else {
                    // Si es string, intentar parsearlo como JSON
                    status = JSON.parse(data);
                    console.log('Data parseada como JSON:', status);
                }
                
                console.log('Status final a procesar:', status);
                console.log('Status.connected:', status.connected);
                console.log('Status.connected === true:', status.connected === true);
                console.log('Status properties:');
                Object.keys(status).forEach(key => {
                    console.log(`- ${key}: ${status[key]} (tipo: ${typeof status[key]})`);
                });
                
                // Verificar conexi√≥n de forma m√°s flexible
                const isConnected = status.connected === true || status.connected === 'true' || status.connected === 1;
                const isReady = status.ready === true || status.ready === 'true' || status.ready === 1;
                
                console.log('Evaluaci√≥n de conexi√≥n:');
                console.log('- isConnected:', isConnected);
                console.log('- isReady:', isReady);
                
                if (isConnected) {
                    printerConnected = true;
                    printerName = status.printerName || status.name || 'TD-4550DNWB_5707';
                    printerAddress = status.printerAddress || status.mac || status.address || '';
                    
                    console.log('‚úÖ IMPRESORA DETECTADA COMO CONECTADA');
                    console.log('- Nombre:', printerName);
                    console.log('- Direcci√≥n:', printerAddress);
                    console.log('- Ready:', isReady);
                    
                    actualizarEstadoUI(true, printerName, printerAddress);
                    
                    if (isReady) {
                        mostrarEstado('Estado verificado: Conectada y lista para imprimir', 'success');
                    } else {
                        mostrarEstado('Estado verificado: Conectada pero no lista', 'info');
                    }
                } else {
                    printerConnected = false;
                    printerName = '';
                    printerAddress = '';
                    
                    console.log('‚ùå IMPRESORA DETECTADA COMO DESCONECTADA');
                    console.log('- Valor de connected:', status.connected);
                    actualizarEstadoUI(false, '', '');
                    mostrarEstado('No conectada - Intentando reconexi√≥n autom√°tica...', 'info');
                    
                    // Reconexi√≥n autom√°tica cuando no est√° conectada
                    console.log('Iniciando b√∫squeda autom√°tica de impresoras...');
                    setTimeout(() => {
                        if (typeof AndroidBridge !== 'undefined' && typeof AndroidBridge.searchPrinters === 'function') {
                            AndroidBridge.searchPrinters();
                        }
                    }, 1000);
                }
            } catch (e) {
                console.error('Error procesando status:', e);
                console.log('Data original que fall√≥:', data);
                console.log('Tipo de data que fall√≥:', typeof data);
                
                // Intentar acceso directo si es un objeto con propiedades conocidas
                if (typeof data === 'object' && data !== null && data.hasOwnProperty('connected')) {
                    console.log('Intentando acceso directo a propiedades');
                    const isConnected = data.connected === true || data.connected === 'true' || data.connected === 1;
                    if (isConnected) {
                        printerConnected = true;
                        printerName = 'TD-4550DNWB_5707';
                        actualizarEstadoUI(true, printerName, '');
                        mostrarEstado('Estado verificado: Conectada', 'success');
                    } else {
                        printerConnected = false;
                        actualizarEstadoUI(false, '', '');
                        mostrarEstado('Estado verificado: No conectada', 'info');
                    }
                } else {
                    mostrarEstado('Error verificando estado: Formato no reconocido', 'error');
                }
            }
        },
        
        onPrintSuccess: function(data) {
            console.log('=== CALLBACK onPrintSuccess ===');
            console.log('Data recibida:', data);
            console.log('Tipo de data:', typeof data);
            
            try {
                let result;
                
                // Si ya es un objeto, usarlo directamente
                if (typeof data === 'object' && data !== null) {
                    result = data;
                    console.log('Data es objeto directo:', result);
                } else {
                    // Si es string, intentar parsearlo como JSON
                    result = JSON.parse(data);
                    console.log('Data parseada como JSON:', result);
                }
                
                const mensaje = result.message || result.success || 'Impresi√≥n completada';
                mostrarEstado('Impresi√≥n completada: ' + mensaje, 'success');
                console.log('Impresi√≥n exitosa - Mensaje:', mensaje);
            } catch (e) {
                console.log('Error procesando respuesta de √©xito, usando mensaje por defecto');
                mostrarEstado('Etiqueta Brother TD-4550DNWB impresa correctamente', 'success');
            }
            
            // Si hay m√°s etiquetas pendientes, continuar
            if (etiquetasPendientes > 1) {
                etiquetasPendientes--;
                setTimeout(() => {
                    imprimirSiguienteEtiqueta();
                }, 1000);
            }
        },
        
        onPrintError: function(data) {
            console.log('=== CALLBACK onPrintError ===');
            console.log('Data recibida:', data);
            console.log('Tipo de data:', typeof data);
            
            try {
                let error;
                
                // Si ya es un objeto, usarlo directamente
                if (typeof data === 'object' && data !== null) {
                    error = data;
                    console.log('Data es objeto directo:', error);
                } else {
                    // Si es string, intentar parsearlo como JSON
                    error = JSON.parse(data);
                    console.log('Data parseada como JSON:', error);
                }
                
                const mensaje = error.error || error.message || 'Error desconocido';
                mostrarEstado('Error de impresi√≥n: ' + mensaje, 'error');
                console.log('Error detallado:', mensaje);
                
                if (mensaje.includes('No hay impresora conectada') || mensaje.includes('not connected')) {
                    console.log('Detectado error de conexi√≥n, actualizando estado');
                    printerConnected = false;
                    printerName = '';
                    printerAddress = '';
                    actualizarEstadoUI(false, '', '');
                }
            } catch (e) {
                console.log('Error procesando error, data original:', data);
                console.log('Tipo de data que fall√≥:', typeof data);
                
                // Intentar acceso directo si es un objeto
                if (typeof data === 'object' && data !== null) {
                    const mensaje = data.error || data.message || 'Error de impresi√≥n';
                    mostrarEstado('Error de impresi√≥n: ' + mensaje, 'error');
                } else {
                    mostrarEstado('Error de impresi√≥n: ' + data, 'error');
                }
            }
            etiquetasPendientes = 0;
        }
    };

    let etiquetasPendientes = 0;
    let datosEtiqueta = null;

    // Funci√≥n para cerrar el modal
    function closeModal() {
        const modalElement = document.getElementById('printerSettingsModal');
        if (modalElement) {
            modalElement.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    
    // Establecer fecha y hora actual
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const startDateTimeInput = document.getElementById('startDateTime');
        if (startDateTimeInput) {
            startDateTimeInput.value = now.toISOString().slice(0, 16);
        }
        
        // Generar vista previa inicial
        generarVistaPrevia();
        
        // Verificar estado de la impresora
        verificarEstadoImpresora();
        
        // Forzar solicitud de permisos Bluetooth al cargar la p√°gina
        setTimeout(forzarSolicitudPermisos, 1500);
        
        // Configurar evento para abrir modal
        const openPrinterModalBtn = document.getElementById('openPrinterModal');
        if (openPrinterModalBtn) {
            openPrinterModalBtn.addEventListener('click', function() {
                const modalElement = document.getElementById('printerSettingsModal');
                if (modalElement) {
                    modalElement.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                }
            });
        }
    });

    // Funci√≥n para actualizar la UI con el estado de la impresora
    function actualizarEstadoUI(conectada, nombre, direccion) {
        const statusElement = document.getElementById('printerStatus');
        const badgeElement = document.getElementById('printerStatusBadge');
        const statusBarElement = document.getElementById('printer-status-bar');
        const badgeBarElement = document.getElementById('printer-badge-bar');
        
        if (conectada) {
            const mensaje = `Conectada: ${nombre}${direccion ? ' (' + direccion + ')' : ''}`;
            const mensajeCorto = `Conectada: ${nombre}`;
            
            if (statusElement) {
                statusElement.textContent = mensaje;
                statusElement.style.color = '#28a745';
            }
            if (statusBarElement) {
                statusBarElement.textContent = mensajeCorto;
                statusBarElement.style.color = '#28a745';
            }
            if (badgeElement) {
                badgeElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> Conectada';
                badgeElement.className = 'badge bg-success me-1';
            }
            if (badgeBarElement) {
                badgeBarElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> Conectada';
                badgeBarElement.className = 'badge bg-success me-2';
            }
        } else {
            const mensaje = 'No conectada (buscar impresoras)';
            
            if (statusElement) {
                statusElement.textContent = mensaje;
                statusElement.style.color = '#dc3545';
            }
            if (statusBarElement) {
                statusBarElement.textContent = 'No conectada';
                statusBarElement.style.color = '#dc3545';
            }
            if (badgeElement) {
                badgeElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> No conectada';
                badgeElement.className = 'badge bg-danger me-1';
            }
            if (badgeBarElement) {
                badgeBarElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> No conectada';
                badgeBarElement.className = 'badge bg-danger me-2';
            }
        }
    }

    function verificarEstadoImpresora() {
        console.log('üîç FUNCI√ìN verificarEstadoImpresora() INICIADA');
        
        if (typeof AndroidBridge === 'undefined') {
            console.log('‚ùå AndroidBridge no est√° disponible');
            const mensaje = 'No disponible (ejecutar en app Android)';
            const statusElement = document.getElementById('printerStatus');
            const badgeElement = document.getElementById('printerStatusBadge');
            const statusBarElement = document.getElementById('printer-status-bar');
            const badgeBarElement = document.getElementById('printer-badge-bar');
            
            if (statusElement) statusElement.textContent = mensaje;
            if (statusBarElement) statusBarElement.textContent = mensaje;
            if (badgeElement) {
                badgeElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> No disponible';
                badgeElement.className = 'badge bg-secondary me-1';
            }
            if (badgeBarElement) {
                badgeBarElement.innerHTML = '<i class="bi bi-bluetooth me-1"></i> No disponible';
                badgeBarElement.className = 'badge bg-secondary me-2';
            }
            return;
        }
        
        console.log('‚úÖ AndroidBridge est√° disponible');
        console.log('üìã M√©todos AndroidBridge disponibles:');
        console.log('- getPrinterStatus:', typeof AndroidBridge.getPrinterStatus);
        console.log('- searchPrinters:', typeof AndroidBridge.searchPrinters);
        console.log('- connectPrinter:', typeof AndroidBridge.connectPrinter);
        console.log('- printImage:', typeof AndroidBridge.printImage);
        
        // Mostrar estado actual desde variables globales
        console.log('üìä Estado actual en variables web:');
        console.log('- printerConnected:', printerConnected);
        console.log('- printerName:', printerName);
        console.log('- printerAddress:', printerAddress);
        
        actualizarEstadoUI(printerConnected, printerName, printerAddress);
        
        // Llamar a AndroidBridge.getPrinterStatus() para obtener estado actualizado v√≠a callback
        console.log('=== VERIFICANDO ESTADO DE IMPRESORA ===');
        console.log('üîß Llamando AndroidBridge.getPrinterStatus()...');
        
        try {
            AndroidBridge.getPrinterStatus();
            console.log('‚úÖ Llamada a getPrinterStatus() ejecutada correctamente');
            console.log('‚è≥ Esperando callback window.BrotherPrint.onStatusUpdate...');
            console.log('üí° El resultado deber√≠a aparecer en onStatusUpdate callback');
        } catch (e) {
            console.error('‚ùå Error llamando getPrinterStatus:', e);
            console.log('üìù Detalles del error:', e.message);
            mostrarEstado('Error verificando estado de impresora: ' + e.message, 'error');
        }
    }

    function buscarImpresoras() {
        console.log('üîç FUNCI√ìN buscarImpresoras() INICIADA');
        
        if (typeof AndroidBridge === 'undefined') {
            console.log('‚ùå AndroidBridge no disponible');
            mostrarEstado('AndroidBridge no disponible - Ejecutar en aplicaci√≥n Android', 'error');
            return;
        }
        
        console.log('‚úÖ AndroidBridge disponible');
        console.log('üîß Llamando AndroidBridge.searchPrinters()...');
        mostrarEstado('Buscando impresoras Brother TD-4550DNWB...', 'info');
        
        try {
            AndroidBridge.searchPrinters();
            console.log('‚úÖ Llamada a searchPrinters() ejecutada correctamente');
            console.log('‚è≥ Esperando callback window.BrotherPrint.onPrintersFound...');
        } catch (e) {
            console.error('‚ùå Error llamando searchPrinters:', e);
            mostrarEstado('Error buscando impresoras: ' + e.message, 'error');
        }
    }

    function desconectarImpresora() {
        if (typeof AndroidBridge === 'undefined') {
            mostrarEstado('AndroidBridge no disponible', 'error');
            return;
        }

        console.log('Llamando AndroidBridge.disconnectPrinter()');
        mostrarEstado('Desconectando impresora Brother...', 'info');
        AndroidBridge.disconnectPrinter();
    }

    function enviarEtiquetaPrueba() {
        console.log('üñ®Ô∏è FUNCI√ìN enviarEtiquetaPrueba() INICIADA');
        
        if (typeof AndroidBridge === 'undefined') {
            console.log('‚ùå AndroidBridge no disponible');
            mostrarEstado('Esta funci√≥n solo est√° disponible en la aplicaci√≥n Android', 'error');
            return;
        }

        console.log('‚úÖ AndroidBridge disponible');
        console.log('üîß Verificando m√©todo printImage...');
        console.log('- printImage disponible:', typeof AndroidBridge.printImage);

        if (typeof AndroidBridge.printImage !== 'function') {
            console.log('‚ùå M√©todo printImage no disponible');
            mostrarEstado('M√©todo de impresi√≥n no disponible', 'error');
            return;
        }

        console.log('üìä Estado actual de conexi√≥n:');
        console.log('- printerConnected:', printerConnected);
        console.log('- printerName:', printerName);
        console.log('- printerAddress:', printerAddress);

        try {
            // Verificar que la impresora est√© conectada
            if (!printerConnected) {
                console.log('‚ùå Impresora no conectada');
                mostrarEstado('Error: No hay impresora conectada. Busque impresoras primero.', 'error');
                return;
            }
            
            console.log('‚úÖ Impresora conectada, generando etiqueta de prueba...');
            
            // Generar canvas de prueba
            const canvas = document.createElement('canvas');
            canvas.width = 520;   // 44mm a 300 DPI
            canvas.height = 449;  // 38mm a 300 DPI
            const ctx = canvas.getContext('2d');
            
            console.log('üé® Canvas creado:');
            console.log('- Ancho:', canvas.width);
            console.log('- Alto:', canvas.height);
            
            // Fondo blanco
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Configuraci√≥n de texto
            ctx.fillStyle = 'black';
            ctx.textAlign = 'center';
            
            // T√≠tulo
            ctx.font = 'bold 32px Arial';
            ctx.fillText('ETIQUETA DE PRUEBA', canvas.width / 2, 80);
            
            // Subt√≠tulo
            ctx.font = 'bold 24px Arial';
            ctx.fillText('Brother TD-4550DNWB', canvas.width / 2, 130);
            
            // Informaci√≥n adicional
            ctx.textAlign = 'left';
            const margin = 35;
            ctx.font = '18px Arial';
            ctx.fillText('Preparado por: Sistema', margin, 200);
            ctx.fillText('Fecha: ' + new Date().toLocaleDateString('es-ES'), margin, 240);
            ctx.fillText('Hora: ' + new Date().toLocaleTimeString('es-ES'), margin, 280);
            
            // Borde
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 3;
            ctx.strokeRect(10, 10, 500, 429);
            
            console.log('üé® Etiqueta dibujada en canvas');
            
            const base64 = canvas.toDataURL('image/png').replace(/^data:image\/png;base64,/, '');
            
            console.log('üì∑ Base64 generado:');
            console.log('- Longitud:', base64.length);
            console.log('- Primeros 50 caracteres:', base64.substring(0, 50));
            console.log('üîß Llamando AndroidBridge.printImage()...');
            
            mostrarEstado('Enviando etiqueta de prueba a Brother TD-4550DNWB...', 'info');
            
            AndroidBridge.printImage(base64);
            
            console.log('‚úÖ Llamada a printImage() ejecutada correctamente');
            console.log('‚è≥ Esperando callback onPrintSuccess o onPrintError...');
            
        } catch (error) {
            console.error('‚ùå Error enviando etiqueta de prueba:', error);
            console.log('üìù Detalles del error:', error.message);
            console.log('üìù Stack trace:', error.stack);
            mostrarEstado('Error al enviar etiqueta de prueba: ' + error.message, 'error');
        }
    }

    function calcularFechaCaducidad(fechaInicio, diasVidaUtil) {
        const fecha = new Date(fechaInicio);
        fecha.setDate(fecha.getDate() + parseInt(diasVidaUtil));
        return fecha;
    }

    function formatearFecha(fecha) {
        const opciones = { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return fecha.toLocaleString('es-ES', opciones);
    }

    function generarVistaPrevia() {
        const productNameElement = document.getElementById('productName');
        const conservationTypeElement = document.getElementById('conservationType');
        const employeeElement = document.getElementById('employee');
        const startDateTimeElement = document.getElementById('startDateTime');
        const shelfLifeElement = document.getElementById('shelfLife');
        const quantityElement = document.getElementById('quantity');
        
        if (!productNameElement || !conservationTypeElement || !employeeElement || 
            !startDateTimeElement || !shelfLifeElement || !quantityElement) {
            console.log('Algunos elementos del formulario no est√°n disponibles');
            return;
        }
        
        const productName = productNameElement.value;
        const conservationType = conservationTypeElement.value;
        const employee = employeeElement.value;
        const startDateTime = new Date(startDateTimeElement.value);
        const shelfLife = shelfLifeElement.value;
        
        const fechaCaducidad = calcularFechaCaducidad(startDateTime, shelfLife);
        
        datosEtiqueta = {
            productName: productName,
            conservationType: conservationType,
            preparedBy: `EMP: ${employee}`,
            startDate: `INICIO: ${formatearFecha(startDateTime)}`,
            expiryDate: `Caducidad: ${formatearFecha(fechaCaducidad)}`,
            quantity: parseInt(quantityElement.value)
        };
        
        dibujarEtiqueta(datosEtiqueta);
    }

    function dibujarEtiqueta(datos) {
        const canvas = document.getElementById('labelCanvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Limpiar canvas con fondo blanco
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Configurar estilos base
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        
        // NOMBRE DEL PRODUCTO (m√°s grande y centrado)
        ctx.font = 'bold 36px Arial';
        const nombreProducto = datos.productName.toUpperCase();
        
        // Si el texto es muy largo, reducir tama√±o de fuente
        if (nombreProducto.length > 15) {
            ctx.font = 'bold 28px Arial';
        }
        ctx.fillText(nombreProducto, canvas.width / 2, 60);
        
        // TIPO DE CONSERVACI√ìN
        ctx.font = 'bold 26px Arial';
        ctx.fillText(datos.conservationType, canvas.width / 2, 110);
        
        // L√≠nea divisoria
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(30, 140);
        ctx.lineTo(canvas.width - 30, 140);
        ctx.stroke();
        
        // Informaci√≥n adicional (alineada a la izquierda)
        ctx.textAlign = 'left';
        const leftMargin = 35;
        
        // Empleado
        ctx.font = '20px Arial';
        ctx.fillText(datos.preparedBy, leftMargin, 185);
        
        // Fecha de inicio
        ctx.font = '20px Arial';
        ctx.fillText(datos.startDate, leftMargin, 225);
        
        // L√≠nea divisoria antes de caducidad
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(30, 250);
        ctx.lineTo(canvas.width - 30, 250);
        ctx.stroke();
        
        // FECHA DE CADUCIDAD (m√°s prominente)
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = '#d32f2f'; // Rojo para destacar
        
        // Dividir la fecha de caducidad si es muy larga
        const caducidadTexto = datos.expiryDate;
        if (caducidadTexto.length > 30) {
            const partes = caducidadTexto.split(' ');
            ctx.fillText(partes.slice(0, 2).join(' '), leftMargin, 290);
            ctx.fillText(partes.slice(2).join(' '), leftMargin, 320);
        } else {
            ctx.fillText(caducidadTexto, leftMargin, 300);
        }
        
        // C√≥digo QR o identificador (opcional)
        ctx.fillStyle = 'black';
        ctx.font = '14px monospace';
        ctx.textAlign = 'right';
        const codigoLote = `LOT${Date.now().toString().slice(-6)}`;
        ctx.fillText(codigoLote, canvas.width - 35, canvas.height - 20);
        
        // Borde de la etiqueta
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 3;
        ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
    }

    function imprimirEtiquetas() {
        if (typeof AndroidBridge === 'undefined') {
            alert('Esta funci√≥n solo est√° disponible en la aplicaci√≥n Android');
            return;
        }
        
        if (!datosEtiqueta) {
            generarVistaPrevia();
        }
        
        etiquetasPendientes = datosEtiqueta.quantity;
        mostrarEstado(`Imprimiendo ${etiquetasPendientes} etiqueta(s)...`, 'info');
        
        imprimirSiguienteEtiqueta();
    }

    function imprimirSiguienteEtiqueta() {
        if (etiquetasPendientes <= 0) {
            return;
        }
        
        const canvas = document.getElementById('labelCanvas');
        if (!canvas) return;
        
        const base64 = canvas.toDataURL('image/png').replace('data:image/png;base64,', '');
        
        // Actualizar estado
        if (etiquetasPendientes > 1) {
            mostrarEstado(`Imprimiendo etiqueta ${datosEtiqueta.quantity - etiquetasPendientes + 1} de ${datosEtiqueta.quantity}...`, 'info');
        }
        
        // Enviar a imprimir
        AndroidBridge.printImage(base64);
    }

    function mostrarEstado(mensaje, tipo) {
        const statusDiv = document.getElementById('statusMessage');
        if (!statusDiv) return;
        
        statusDiv.textContent = mensaje;
        statusDiv.className = 'status ' + tipo;
        statusDiv.style.display = 'block';
        
        // Ocultar despu√©s de 5 segundos si es √©xito
        if (tipo === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    }

    // Agregar estilos CSS para los estados de mensaje
    const style = document.createElement('style');
    style.textContent = `
        .status.info { color: #0c7cd5; background-color: #d7edff; padding: 8px; border-radius: 4px; }
        .status.success { color: #28a745; background-color: #d4edda; padding: 8px; border-radius: 4px; }
        .status.error { color: #dc3545; background-color: #f8d7da; padding: 8px; border-radius: 4px; }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}