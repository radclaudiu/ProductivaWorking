{% extends "tasks/portal_layout.html" %}

{% block content %}
<!-- Modal de Configuración de Impresora Brother Bluetooth -->
<div id="printerSettingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050; overflow-y: auto;">
    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1040;"></div>
    <div style="position: relative; width: 80%; max-width: 800px; margin: 30px auto; margin-bottom: 50px; z-index: 1050;">
        <div class="card">
            <div class="card-header bg-earth-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bluetooth me-2"></i>Brother TD-4550DNWB</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeModal()" aria-label="Close"></button>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-bluetooth me-2"></i>Impresora Brother TD-4550DNWB conectada vía Bluetooth. Esta función solo está disponible en la aplicación Android con el SDK Brother integrado.
                        </div>
                    </div>
                </div>
                
                <!-- Estado de Conexión Brother -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">Estado de Conexión</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="bi bi-bluetooth display-4 text-primary mb-2"></i>
                                    <h6>Estado de Impresora</h6>
                                    <p id="printerStatus" class="mb-2">No disponible (ejecutar en app Android)</p>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="verificarEstadoImpresora()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Verificar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="bi bi-search display-4 text-success mb-2"></i>
                                    <h6>Buscar Impresoras</h6>
                                    <p class="mb-2">Buscar impresoras Brother disponibles</p>
                                    <button type="button" class="btn btn-success btn-sm" onclick="buscarImpresoras()">
                                        <i class="bi bi-search me-1"></i>Buscar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Vista Previa de Etiqueta -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">Vista Previa de Etiqueta (520x449px)</h6>
                    <div class="text-center">
                        <canvas id="labelCanvas" width="520" height="449" style="border: 2px solid #ddd; max-width: 100%; height: auto;"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="productName" class="form-label">Producto</label>
                                <input type="text" class="form-control" id="productName" value="POLLO EMPANADO" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-6">
                                <label for="conservationType" class="form-label">Conservación</label>
                                <select class="form-select" id="conservationType" onchange="generarVistaPrevia()">
                                    <option value="REFRIGERACIÓN" selected>REFRIGERACIÓN</option>
                                    <option value="DESCONGELACIÓN">DESCONGELACIÓN</option>
                                    <option value="GASTRO">GASTRO</option>
                                    <option value="CALIENTE">CALIENTE</option>
                                    <option value="SECO">SECO</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <label for="employee" class="form-label">Empleado</label>
                                <input type="text" class="form-control" id="employee" value="Juan Pérez" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-4">
                                <label for="startDateTime" class="form-label">Fecha/Hora Inicio</label>
                                <input type="datetime-local" class="form-control" id="startDateTime" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-4">
                                <label for="shelfLife" class="form-label">Vida Útil (días)</label>
                                <input type="number" class="form-control" id="shelfLife" value="3" min="1" max="30" onchange="generarVistaPrevia()">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label for="quantity" class="form-label">Cantidad</label>
                                <input type="number" class="form-control" id="quantity" value="1" min="1" max="10" onchange="generarVistaPrevia()">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="button" class="btn btn-primary w-100" onclick="imprimirEtiquetas()">
                                    <i class="bi bi-printer me-1"></i>Imprimir Etiquetas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mensajes de Estado -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="bi bi-info-circle me-2"></i>Mensajes del Sistema</h6>
                                <div id="statusMessage" class="status" style="display: none;"></div>
                                <div class="alert alert-info">
                                    <i class="bi bi-bluetooth me-2"></i>La impresora Brother TD-4550DNWB se conecta automáticamente vía Bluetooth cuando se ejecuta desde la aplicación Android.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
                <button type="button" class="btn btn-success" onclick="buscarImpresoras()">
                    <i class="bi bi-search me-1"></i>Buscar Impresoras
                </button>
                <button type="button" class="btn btn-primary" onclick="generarVistaPrevia()">
                    <i class="bi bi-eye me-1"></i>Actualizar Vista Previa
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-earth-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-tag-fill me-2"></i>Etiquetas de Productos - {{ location.name }}</h5>
                    <div>
                        <button type="button" class="btn btn-primary btn-sm me-2" id="openPrinterModal">
                            <i class="bi bi-bluetooth me-1"></i> Brother TD-4550DNWB
                        </button>
                        <a href="{{ url_for('tasks.local_user_tasks') }}" class="btn btn-light btn-sm">
                            <i class="bi bi-list-check me-1"></i> Volver a Tareas
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Mensaje de confirmación de impresión (oculto por defecto) -->
                    <div id="print-success-message" class="alert alert-success mb-3" style="display: none;">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>¡Etiqueta impresa correctamente!</strong> La impresión se ha enviado a la impresora Brother TD-4550DNWB.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <p>
                                Seleccione un producto de la lista para generar etiquetas, o utilice el buscador para encontrar rápidamente.
                            </p>
                        </div>
                        <div class="col-md-6">
                            <div class="text-md-end">
                                <div class="printer-status d-inline-block">
                                    <span class="badge bg-secondary me-1" id="printerStatusBadge">
                                        <i class="bi bi-printer me-1"></i> No configurado
                                    </span>
                                    <button type="button" class="btn btn-sm btn-info" id="checkPrinterBtn">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not products %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>No hay productos disponibles. Contacte con un administrador.
        </div>
    {% else %}
        <!-- Buscador -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <form action="{{ url_for('tasks.local_user_labels') }}" method="get">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" name="q" class="form-control form-control-lg" 
                                    placeholder="Buscar producto..." 
                                    value="{{ search_query }}" 
                                    autocomplete="off" 
                                    autofocus>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search me-1"></i>Buscar
                                </button>
                                {% if search_query %}
                                <a href="{{ url_for('tasks.local_user_labels') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle me-1"></i>Limpiar
                                </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de productos -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-4">
            {% for product in products %}
            <div class="col">
                <div class="card h-100 shadow-sm product-card">
                    <div class="card-body d-flex flex-column">
                        <div class="product-icon text-center mb-2">
                            <i class="bi bi-box-seam display-1"></i>
                        </div>
                        <h5 class="card-title text-center mb-3">{{ product.name }}</h5>
                        <div class="conservation-types small mb-3">
                            <div class="d-flex flex-wrap justify-content-center gap-1">
                                {% if product.conservation_types %}
                                    {% for ct in product.conservation_types %}
                                        <span class="badge rounded-pill {% if ct.conservation_type.value == 'descongelacion' %}bg-primary{% elif ct.conservation_type.value == 'refrigeracion' %}bg-info{% elif ct.conservation_type.value == 'gastro' %}bg-success{% elif ct.conservation_type.value == 'caliente' %}bg-danger{% else %}bg-warning{% endif %}">
                                            {% if ct.conservation_type.value == 'descongelacion' %}
                                                <i class="bi bi-snow me-1"></i>
                                            {% elif ct.conservation_type.value == 'refrigeracion' %}
                                                <i class="bi bi-thermometer-snow me-1"></i>
                                            {% elif ct.conservation_type.value == 'gastro' %}
                                                <i class="bi bi-cup-hot me-1"></i>
                                            {% elif ct.conservation_type.value == 'caliente' %}
                                                <i class="bi bi-fire me-1"></i>
                                            {% else %}
                                                <i class="bi bi-droplet me-1"></i>
                                            {% endif %}
                                            {{ ct.conservation_type.value|capitalize }}
                                        </span>
                                    {% endfor %}
                                {% else %}
                                    <span class="badge bg-secondary">Sin tipos de conservación</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mt-auto">
                            <a href="{{ url_for('tasks.product_conservation_selection', product_id=product.id) }}" class="btn btn-primary w-100">
                                <i class="bi bi-tag-fill me-2"></i>Generar Etiqueta
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Paginación (para futura implementación) -->
        <div class="row">
            <div class="col-12 d-flex justify-content-center">
                <nav>
                    <ul class="pagination">
                        <li class="page-item disabled">
                            <span class="page-link">Anterior</span>
                        </li>
                        <li class="page-item active">
                            <span class="page-link">1</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">Siguiente</span>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}



{% block styles %}
<style>
    .product-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
    }
    
    .product-icon {
        color: #6c757d;
        transition: color 0.3s ease;
    }
    
    .product-card:hover .product-icon {
        color: #0d6efd;
    }
    
    .conservation-types {
        min-height: 40px;
    }
    
    /* Estilos para la sección de impresora */
    .printer-status {
        padding: 5px 10px;
        border-radius: 5px;
    }
    
    .bg-earth-dark {
        background-color: #8B4513; /* Marrón chocolate */
        color: white;
    }
    
    .btn-olive {
        background-color: #556B2F; /* Verde oliva */
        color: white;
    }
    
    .btn-olive:hover {
        background-color: #6B8E23;
        color: white;
    }
    
    /* Estilos adicionales para el modal personalizado */
    .modal.show {
        display: block;
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
    }
</style>
{% endblock %}

{% block scripts %}
<!-- Script para mostrar mensaje de confirmación después de imprimir -->
<script src="/static/js/label-success-message.js"></script>
<script>
    // Configurar callbacks globales para Brother Print
    window.BrotherPrint = {
        onPrintersFound: function(printersJsonString) {
            console.log('Impresoras encontradas:', printersJsonString);
            try {
                const printers = JSON.parse(printersJsonString);
                if (printers.length === 0) {
                    mostrarEstado('No se encontraron impresoras Brother', 'error');
                    return;
                }
                
                // Mostrar lista de impresoras
                let mensaje = 'Impresoras encontradas:\n';
                printers.forEach((printer, index) => {
                    mensaje += `${index + 1}. ${printer.name} (${printer.address})\n`;
                });
                
                // Preguntar al usuario cuál conectar
                if (confirm(mensaje + '\n¿Conectar con la primera impresora?')) {
                    AndroidBridge.connectPrinter(printers[0].address);
                    mostrarEstado('Conectando con ' + printers[0].name + '...', 'info');
                }
            } catch (e) {
                console.error('Error parseando impresoras:', e);
                mostrarEstado('Error al procesar lista de impresoras', 'error');
            }
        },
        
        onPrinterConnected: function() {
            console.log('Impresora conectada exitosamente');
            mostrarEstado('Impresora conectada correctamente', 'success');
            verificarEstadoImpresora();
        },
        
        onPrintSuccess: function() {
            console.log('Impresión exitosa');
            mostrarEstado('Etiqueta impresa correctamente', 'success');
            
            // Si hay más etiquetas pendientes, continuar
            if (etiquetasPendientes > 1) {
                etiquetasPendientes--;
                setTimeout(() => {
                    imprimirSiguienteEtiqueta();
                }, 1000);
            }
        },
        
        onPrintError: function(errorMessage) {
            console.error('Error de impresión:', errorMessage);
            mostrarEstado('Error: ' + errorMessage, 'error');
            etiquetasPendientes = 0;
        }
    };

    let etiquetasPendientes = 0;
    let datosEtiqueta = null;

    // Función para cerrar el modal
    function closeModal() {
        const modalElement = document.getElementById('printerSettingsModal');
        if (modalElement) {
            modalElement.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    
    // Añadir la función closeModal al objeto global window
    window.closeModal = closeModal;
    // Establecer fecha y hora actual
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('startDateTime').value = now.toISOString().slice(0, 16);
        
        // Generar vista previa inicial
        generarVistaPrevia();
        
        // Verificar estado de la impresora
        verificarEstadoImpresora();
    });

    function verificarEstadoImpresora() {
        if (typeof AndroidBridge === 'undefined') {
            document.getElementById('printerStatus').textContent = 'No disponible (ejecutar en app Android)';
            return;
        }
        
        try {
            const status = JSON.parse(AndroidBridge.getPrinterStatus());
            if (status.connected) {
                document.getElementById('printerStatus').textContent = 
                    `Conectada: ${status.printerName} (${status.printerAddress})`;
                document.getElementById('printerStatus').style.color = '#28a745';
            } else if (status.configured) {
                document.getElementById('printerStatus').textContent = 
                    `Configurada pero desconectada: ${status.savedPrinterName}`;
                document.getElementById('printerStatus').style.color = '#ffc107';
            } else {
                document.getElementById('printerStatus').textContent = 
                    'No configurada (pulsa "Buscar Impresoras")';
                document.getElementById('printerStatus').style.color = '#dc3545';
            }
        } catch (e) {
            document.getElementById('printerStatus').textContent = 'Error al verificar estado';
        }
    }

    function buscarImpresoras() {
        if (typeof AndroidBridge === 'undefined') {
            alert('Esta función solo está disponible en la aplicación Android');
            return;
        }
        
        mostrarEstado('Buscando impresoras Brother...', 'info');
        AndroidBridge.searchPrinters();
    }

    function calcularFechaCaducidad(fechaInicio, diasVidaUtil) {
        const fecha = new Date(fechaInicio);
        fecha.setDate(fecha.getDate() + parseInt(diasVidaUtil));
        return fecha;
    }

    function formatearFecha(fecha) {
        const opciones = { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return fecha.toLocaleString('es-ES', opciones);
    }

    function generarVistaPrevia() {
        const productName = document.getElementById('productName').value;
        const conservationType = document.getElementById('conservationType').value;
        const employee = document.getElementById('employee').value;
        const startDateTime = new Date(document.getElementById('startDateTime').value);
        const shelfLife = document.getElementById('shelfLife').value;
        
        const fechaCaducidad = calcularFechaCaducidad(startDateTime, shelfLife);
        
        datosEtiqueta = {
            productName: productName,
            conservationType: conservationType,
            preparedBy: `EMP: ${employee}`,
            startDate: `INICIO: ${formatearFecha(startDateTime)}`,
            expiryDate: `Caducidad: ${formatearFecha(fechaCaducidad)}`,
            quantity: parseInt(document.getElementById('quantity').value)
        };
        
        dibujarEtiqueta(datosEtiqueta);
    }

    function dibujarEtiqueta(datos) {
        const canvas = document.getElementById('labelCanvas');
        const ctx = canvas.getContext('2d');
        
        // Limpiar canvas con fondo blanco
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Configurar estilos base
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        
        // NOMBRE DEL PRODUCTO (más grande y centrado)
        ctx.font = 'bold 36px Arial';
        const nombreProducto = datos.productName.toUpperCase();
        
        // Si el texto es muy largo, reducir tamaño de fuente
        if (nombreProducto.length > 15) {
            ctx.font = 'bold 28px Arial';
        }
        ctx.fillText(nombreProducto, canvas.width / 2, 60);
        
        // TIPO DE CONSERVACIÓN
        ctx.font = 'bold 26px Arial';
        ctx.fillText(datos.conservationType, canvas.width / 2, 110);
        
        // Línea divisoria
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(30, 140);
        ctx.lineTo(canvas.width - 30, 140);
        ctx.stroke();
        
        // Información adicional (alineada a la izquierda)
        ctx.textAlign = 'left';
        const leftMargin = 35;
        
        // Empleado
        ctx.font = '20px Arial';
        ctx.fillText(datos.preparedBy, leftMargin, 185);
        
        // Fecha de inicio
        ctx.font = '20px Arial';
        ctx.fillText(datos.startDate, leftMargin, 225);
        
        // Línea divisoria antes de caducidad
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(30, 250);
        ctx.lineTo(canvas.width - 30, 250);
        ctx.stroke();
        
        // FECHA DE CADUCIDAD (más prominente)
        ctx.font = 'bold 24px Arial';
        ctx.fillStyle = '#d32f2f'; // Rojo para destacar
        
        // Dividir la fecha de caducidad si es muy larga
        const caducidadTexto = datos.expiryDate;
        if (caducidadTexto.length > 30) {
            const partes = caducidadTexto.split(' ');
            ctx.fillText(partes.slice(0, 2).join(' '), leftMargin, 290);
            ctx.fillText(partes.slice(2).join(' '), leftMargin, 320);
        } else {
            ctx.fillText(caducidadTexto, leftMargin, 300);
        }
        
        // Código QR o identificador (opcional)
        ctx.fillStyle = 'black';
        ctx.font = '14px monospace';
        ctx.textAlign = 'right';
        const codigoLote = `LOT${Date.now().toString().slice(-6)}`;
        ctx.fillText(codigoLote, canvas.width - 35, canvas.height - 20);
        
        // Borde de la etiqueta
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 3;
        ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
        
        // Agregar esquinas redondeadas simuladas
        ctx.lineWidth = 2;
        const cornerSize = 15;
        
        // Esquina superior izquierda
        ctx.beginPath();
        ctx.moveTo(5 + cornerSize, 5);
        ctx.arcTo(5, 5, 5, 5 + cornerSize, cornerSize);
        ctx.stroke();
        
        // Esquina superior derecha
        ctx.beginPath();
        ctx.moveTo(canvas.width - 5 - cornerSize, 5);
        ctx.arcTo(canvas.width - 5, 5, canvas.width - 5, 5 + cornerSize, cornerSize);
        ctx.stroke();
    }

    function imprimirEtiquetas() {
        if (typeof AndroidBridge === 'undefined') {
            alert('Esta función solo está disponible en la aplicación Android');
            return;
        }
        
        if (!datosEtiqueta) {
            generarVistaPrevia();
        }
        
        etiquetasPendientes = datosEtiqueta.quantity;
        mostrarEstado(`Imprimiendo ${etiquetasPendientes} etiqueta(s)...`, 'info');
        
        imprimirSiguienteEtiqueta();
    }

    function imprimirSiguienteEtiqueta() {
        if (etiquetasPendientes <= 0) {
            return;
        }
        
        const canvas = document.getElementById('labelCanvas');
        const base64 = canvas.toDataURL('image/png').replace('data:image/png;base64,', '');
        
        // Actualizar estado
        if (etiquetasPendientes > 1) {
            mostrarEstado(`Imprimiendo etiqueta ${datosEtiqueta.quantity - etiquetasPendientes + 1} de ${datosEtiqueta.quantity}...`, 'info');
        }
        
        // Enviar a imprimir
        AndroidBridge.printImage(base64);
    }

    function mostrarEstado(mensaje, tipo) {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.textContent = mensaje;
        statusDiv.className = 'status ' + tipo;
        statusDiv.style.display = 'block';
        
        // Ocultar después de 5 segundos si es éxito
        if (tipo === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    }

    // Configurar evento para abrir modal
    document.addEventListener('DOMContentLoaded', function() {
        const openPrinterModalBtn = document.getElementById('openPrinterModal');
        if (openPrinterModalBtn) {
            openPrinterModalBtn.addEventListener('click', function() {
                const modalElement = document.getElementById('printerSettingsModal');
                if (modalElement) {
                    modalElement.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                }
            });
        }
    });

    // Agregar estilos CSS para los estados de mensaje
    const style = document.createElement('style');
    style.textContent = `
        .status.info { color: #0c7cd5; background-color: #d7edff; padding: 8px; border-radius: 4px; }
        .status.success { color: #28a745; background-color: #d4edda; padding: 8px; border-radius: 4px; }
        .status.error { color: #dc3545; background-color: #f8d7da; padding: 8px; border-radius: 4px; }
    `;
    document.head.appendChild(style);
            })
            .catch(error => {
                console.error('Error al cargar la configuración de impresora:', error);
                updatePrinterConfigStatus(false);
            });
    }
    
    // Función para comprobar el estado de la impresora
    function checkPrinterStatus() {
        const statusBadge = document.getElementById('printerStatusBadge');
        
        // Verificar que el elemento exista
        if (!statusBadge) {
            console.error('Elemento printerStatusBadge no encontrado en el DOM');
            return;
        }
        
        statusBadge.className = 'badge bg-warning me-1';
        statusBadge.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Comprobando...';
        
        // Capturar errores en la respuesta
        fetch('/tasks/api/printers/check/{{ location.id }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (data.online) {
                        statusBadge.className = 'badge bg-success me-1';
                        statusBadge.innerHTML = '<i class="bi bi-printer-fill me-1"></i> Impresora conectada';
                    } else {
                        statusBadge.className = 'badge bg-danger me-1';
                        statusBadge.innerHTML = '<i class="bi bi-printer me-1"></i> Impresora sin conexión';
                    }
                } else if (data.error === 'no_printer') {
                    statusBadge.className = 'badge bg-secondary me-1';
                    statusBadge.innerHTML = '<i class="bi bi-printer me-1"></i> No configurado';
                } else {
                    statusBadge.className = 'badge bg-danger me-1';
                    statusBadge.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-1"></i> Error: ' + data.message;
                }
            })
            .catch(error => {
                console.error('Error al comprobar el estado de la impresora:', error);
                if (statusBadge) {
                    statusBadge.className = 'badge bg-danger me-1';
                    statusBadge.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-1"></i> Error de conexión';
                }
            });
    }
    
    // Función para probar la conexión con la impresora
    function testPrinterConnection() {
        const ipAddressElement = document.getElementById('printerIp');
        const portElement = document.getElementById('printerPort');
        
        if (!ipAddressElement) {
            console.error('Elemento printerIp no encontrado en el DOM');
            return;
        }
        
        const ipAddress = ipAddressElement.value;
        const port = portElement ? portElement.value : '5000';
        
        if (!ipAddress) {
            alert('Por favor, introduzca una dirección IP válida.');
            return;
        }
        
        fetch('/tasks/api/printers/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ip_address: ipAddress,
                port: parseInt(port) || 5000
            }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Conexión exitosa: La impresora está en línea.');
            } else {
                alert('Error de conexión: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error al probar la conexión:', error);
            alert('Error de sistema al intentar conectar con la impresora.');
        });
    }
    
    // Función para guardar la configuración de la impresora
    function savePrinterConfig() {
        const form = document.getElementById('printerSettingsForm');
        
        if (!form) {
            console.error('Elemento printerSettingsForm no encontrado en el DOM');
            return;
        }
        
        // Validación básica del formulario
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Lista de elementos a obtener
        const elements = {
            'printerName': '',
            'printerIp': '',
            'printerPort': 5000,
            'printerModel': '',
            'apiPath': '/print',
            'usbPort': '/dev/usb/lp0',
            'requiresAuth': false,
            'printerUsername': '',
            'printerPassword': '',
            'isDefault': true
        };
        
        // Obtener valores de los elementos verificando primero que existan
        for (const id in elements) {
            const element = document.getElementById(id);
            if (element) {
                if (id === 'requiresAuth' || id === 'isDefault') {
                    elements[id] = element.checked;
                } else {
                    elements[id] = element.value;
                }
            }
        }
        
        // Recopilar datos del formulario
        const printerData = {
            name: elements.printerName,
            ip_address: elements.printerIp,
            port: parseInt(elements.printerPort) || 5000,
            model: elements.printerModel,
            printer_type: 'raspberry_pi', // Siempre usar Raspberry Pi
            api_path: elements.apiPath,
            usb_port: elements.usbPort,
            requires_auth: elements.requiresAuth,
            username: elements.printerUsername,
            password: elements.printerPassword,
            is_default: elements.isDefault,
            location_id: {{ location.id }}
        };
        
        fetch('/tasks/api/printers/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(printerData),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Configuración guardada correctamente.');
                
                // Actualizar el estado
                updatePrinterConfigStatus(true, data.printer);
                
                // Actualizar el estado en la interfaz principal
                checkPrinterStatus();
                
                // Cerrar el modal
                closeModal();
            } else {
                alert('Error al guardar la configuración: ' + (data.message || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error al guardar la configuración:', error);
            alert('Error de sistema al guardar la configuración.');
        });
    }
    
    // Función para cerrar el modal (implementación personalizada)
    function closeModal() {
        const modalElement = document.getElementById('printerSettingsModal');
        if (modalElement) {
            // Cerrar manualmente
            modalElement.style.display = 'none';
            
            // Quitar restricciones del scroll del body si es necesario
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
    }
    
    // Función para actualizar el estado de la configuración
    function updatePrinterConfigStatus(configured, printer = null) {
        const statusDiv = document.getElementById('printerConfigStatus');
        
        // Verificar que el elemento exista
        if (!statusDiv) {
            console.error('Elemento printerConfigStatus no encontrado en el DOM');
            return;
        }
        
        if (configured && printer) {
            let statusClass = 'secondary';
            let statusText = 'Desconocido';
            
            if (printer.last_status === 'online') {
                statusClass = 'success';
                statusText = 'En línea';
            } else if (printer.last_status === 'offline') {
                statusClass = 'danger';
                statusText = 'Sin conexión';
            } else if (printer.last_status && printer.last_status.startsWith('error')) {
                statusClass = 'danger';
                statusText = printer.last_status;
            }
            
            const lastCheck = printer.last_status_check ? new Date(printer.last_status_check).toLocaleString() : 'Nunca';
            
            statusDiv.innerHTML = `
                <div class="alert alert-${statusClass} mb-2">
                    <strong><i class="bi bi-printer-fill me-1"></i> Impresora configurada:</strong> ${printer.name}
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 30%">Tipo:</th>
                            <td>Raspberry Pi</td>
                        </tr>
                        <tr>
                            <th style="width: 30%">Dirección IP:</th>
                            <td>${printer.ip_address}:${printer.port}</td>
                        </tr>
                        <tr>
                            <th>Modelo:</th>
                            <td>${printer.model || 'No especificado'}</td>
                        </tr>
                        <tr>
                            <th>Puerto USB:</th>
                            <td>${printer.usb_port || '/dev/usb/lp0'}</td>
                        </tr>
                        <tr>
                            <th>Estado:</th>
                            <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                        </tr>
                        <tr>
                            <th>Última verificación:</th>
                            <td>${lastCheck}</td>
                        </tr>
                    </table>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-secondary">
                    No hay impresora configurada. Complete el formulario y haga clic en Guardar.
                </div>
            `;
        }
    }
</script>
{% endblock %}