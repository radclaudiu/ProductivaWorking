{% extends 'layout.html' %}

{% block styles %}
<style>
    /* Estilos generales */
    body {
        background-color: #f0f0f0;
        font-family: Arial, sans-serif;
    }
    
    /* Barra de navegación superior */
    .top-navbar {
        background-color: #fff;
        padding: 10px 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 50px;
    }
    
    /* Barra lateral */
    .side-navbar {
        background-color: #f9f9f9;
        width: 60px;
        position: fixed;
        top: 50px;
        left: 0;
        bottom: 0;
        z-index: 900;
        border-right: 1px solid #e0e0e0;
    }
    
    .side-nav-item {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 60px;
        color: #666;
        transition: all 0.3s;
    }
    
    .side-nav-item.active {
        background-color: #4A90E2;
        color: white;
    }
    
    /* Área de contenido principal */
    .main-content {
        margin-left: 60px;
        margin-top: 50px;
        padding: 0;
    }
    
    /* Carrusel de fechas */
    .date-carousel {
        display: flex;
        background-color: #fff;
        padding: 10px 0;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .date-item {
        flex: 1;
        text-align: center;
        padding: 5px 0;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }
    
    .date-item.active {
        border-bottom-color: #4A90E2;
        background-color: #f0f7ff;
    }
    
    .date-day {
        font-size: 11px;
        text-transform: uppercase;
        color: #666;
    }
    
    .date-number {
        font-size: 18px;
        font-weight: bold;
    }
    
    /* Grupos de tareas */
    .task-group {
        display: flex;
        align-items: center;
        padding: 15px;
        border-left: 5px solid #4A90E2;
        margin-bottom: 2px;
        background-color: #fff;
        cursor: pointer;
    }
    
    .task-group:hover {
        background-color: #f5f5f5;
    }
    
    .group-info {
        flex-grow: 1;
    }
    
    .group-name {
        font-weight: bold;
        margin-bottom: 0;
    }
    
    .group-time {
        font-size: 12px;
        color: #999;
    }
    
    .task-counter {
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 10px;
        background-color: #eee;
    }
    
    /* Tareas */
    .task-card {
        padding: 15px;
        border-left: 5px solid #4A90E2;
        background-color: #fff;
        margin-bottom: 1px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .task-title {
        font-weight: bold;
        margin-bottom: 0;
        flex-grow: 1;
    }
    
    .task-badge {
        margin-left: 10px;
        display: inline-block;
        min-width: 35px;
        text-align: center;
    }
    
    /* Círculo de progreso */
    .circle-progress {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid #4caf50;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        color: #4caf50;
        margin-right: 10px;
    }
    
    /* Contenedores para la estructura principal */
    .left-side {
        border-right: 1px solid #e0e0e0;
        background-color: #f5f5f5;
        height: calc(100vh - 50px);
        overflow-y: auto;
    }
    
    .right-side {
        background-color: #f9f9f9;
        height: calc(100vh - 50px);
        overflow-y: auto;
    }
    
    /* Chevron/arrow icon */
    .chevron-right {
        color: #ccc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Top navbar con título de la app -->
    <div class="d-flex justify-content-between align-items-center p-3 bg-white mb-0 border-bottom">
        <h5 class="m-0">Tareas</h5>
        <div class="d-flex align-items-center">
            <span class="me-2">{{ local_user.name }}</span>
            <span class="badge rounded-pill bg-primary">{{ location.name }}</span>
            <a href="{{ url_for('tasks.local_logout') }}" class="btn btn-link text-secondary">
                <i class="bi bi-box-arrow-right"></i>
            </a>
        </div>
    </div>
    
    <!-- Carrusel de fechas -->
    <div class="container-fluid p-0 border-bottom bg-white">
        <div class="row g-0">
            {% for date_item in date_carousel %}
            <div class="col-4">
                <a href="{{ date_item.url }}" class="text-decoration-none">
                    <div class="date-item text-center p-2 {% if date_item.active %}active{% endif %}">
                        <div class="date-day">{{ date_item.day_name }}</div>
                        <div class="date-number">{{ date_item.day }}</div>
                        {% if date_item.date == today %}
                        <small class="text-primary">Hoy</small>
                        {% endif %}
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="row g-0">
        <!-- Barra lateral con grupos de tareas -->
        <div class="col-md-3 left-side border-end">
            <!-- Grupo Todo el día -->
            <div class="task-group active" data-group-id="all">
                <div class="circle-progress">77%</div>
                <div class="group-info">
                    <div class="group-name">Todo el día</div>
                    <div class="group-time">De 00:00h</div>
                </div>
            </div>
            
            <!-- Grupos de tareas -->
            {% for group_id, group_data in grouped_tasks.items() %}
            <div class="task-group" data-group-id="{{ group_id }}" style="border-left-color: {{ group_data.group.color }};">
                <div class="group-info">
                    <div class="group-name">{{ group_data.group.name }}</div>
                    <div class="group-time">{{ group_data.tasks|length }} tareas</div>
                </div>
                <div class="task-counter {% if group_data.completed_count == group_data.tasks|length %}bg-success text-white{% endif %}">
                    {{ group_data.completed_count or 0 }}/{{ group_data.tasks|length }}
                </div>
                <i class="bi bi-chevron-right chevron-right ms-2"></i>
            </div>
            {% endfor %}
            
            {% if ungrouped_tasks %}
            <div class="task-group" data-group-id="ungrouped">
                <div class="group-info">
                    <div class="group-name">Tareas Generales</div>
                    <div class="group-time">{{ ungrouped_tasks|length }} tareas</div>
                </div>
                <div class="task-counter">
                    {{ completed_ungrouped_count or 0 }}/{{ ungrouped_tasks|length }}
                </div>
                <i class="bi bi-chevron-right chevron-right ms-2"></i>
            </div>
            {% endif %}
        </div>
        
        <!-- Panel principal con las tareas -->
        <div class="col-md-9 right-side pt-0">
            <!-- Lista de tareas -->
            <div id="tasks-container">
                {% for group_id, group_data in grouped_tasks.items() %}
                <div class="task-group-content" id="group-{{ group_id }}">
                    {% for task in group_data.tasks %}
                    <div class="task-card" style="border-left-color: {{ group_data.group.color }};">
                        <div class="task-title">{{ task.title }}</div>
                        <div class="d-flex align-items-center">
                            {% if task.priority.value == 'baja' %}
                            <span class="badge bg-info task-badge">Baja</span>
                            {% elif task.priority.value == 'media' %}
                            <span class="badge bg-primary task-badge">Media</span>
                            {% elif task.priority.value == 'alta' %}
                            <span class="badge bg-warning task-badge">Alta</span>
                            {% else %}
                            <span class="badge bg-danger task-badge">Urgente</span>
                            {% endif %}
                            
                            {% if task.completed_today %}
                            <span class="badge bg-success task-badge">
                                <i class="bi bi-check-lg"></i>
                            </span>
                            {% else %}
                            <button type="button" onclick="completeTask({{ task.id }}, '{{ local_user.name }} {{ local_user.last_name }}')" class="btn btn-sm btn-outline-success complete-task-btn" data-task-id="{{ task.id }}">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            {% endif %}
                            
                            <span class="task-badge">
                                {% if task.completed_today %}
                                {{ task.completion_info.time }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                
                {% if ungrouped_tasks %}
                <div class="task-group-content" id="group-ungrouped">
                    {% for task in ungrouped_tasks %}
                    <div class="task-card">
                        <div class="task-title">{{ task.title }}</div>
                        <div class="d-flex align-items-center">
                            {% if task.priority.value == 'baja' %}
                            <span class="badge bg-info task-badge">Baja</span>
                            {% elif task.priority.value == 'media' %}
                            <span class="badge bg-primary task-badge">Media</span>
                            {% elif task.priority.value == 'alta' %}
                            <span class="badge bg-warning task-badge">Alta</span>
                            {% else %}
                            <span class="badge bg-danger task-badge">Urgente</span>
                            {% endif %}
                            
                            {% if task.completed_today %}
                            <span class="badge bg-success task-badge">
                                <i class="bi bi-check-lg"></i>
                            </span>
                            {% else %}
                            <button type="button" onclick="completeTask({{ task.id }}, '{{ local_user.name }} {{ local_user.last_name }}')" class="btn btn-sm btn-outline-success complete-task-btn" data-task-id="{{ task.id }}">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            {% endif %}
                            
                            <span class="task-badge">
                                {% if task.completed_today %}
                                {{ task.completion_info.time }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if not active_tasks %}
                <div class="text-center py-5">
                    <i class="bi bi-check-circle-fill text-success fs-1"></i>
                    <h5 class="mt-3">¡No hay tareas pendientes para hoy!</h5>
                    <p class="text-muted">Todas las tareas han sido completadas.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Inicialización - Mostrar solo el grupo activo al cargar
    document.addEventListener('DOMContentLoaded', function() {
        // Ocultar todos los grupos de tareas excepto el activo
        document.querySelectorAll('.task-group-content').forEach(function(group) {
            group.style.display = 'none';
        });
        
        // Por defecto, mostrar el grupo 'all' (todas las tareas)
        showAllTasks();
        
        // Agregar manejadores de eventos a los elementos de grupo
        document.querySelectorAll('.task-group').forEach(function(groupItem) {
            groupItem.addEventListener('click', function() {
                // Desactivar cualquier grupo activo
                document.querySelectorAll('.task-group').forEach(function(item) {
                    item.classList.remove('active');
                });
                
                // Activar este grupo
                this.classList.add('active');
                
                // Mostrar las tareas correspondientes
                const groupId = this.getAttribute('data-group-id');
                showTasksForGroup(groupId);
            });
        });
    });
    
    // Mostrar todas las tareas
    function showAllTasks() {
        document.querySelectorAll('.task-group-content').forEach(function(group) {
            group.style.display = 'block';
        });
        
        // Activar el elemento "Todo el día"
        document.querySelectorAll('.task-group').forEach(function(item) {
            item.classList.remove('active');
        });
        document.querySelector('.task-group[data-group-id="all"]').classList.add('active');
    }
    
    // Mostrar tareas para un grupo específico
    function showTasksForGroup(groupId) {
        // Ocultar todos los grupos
        document.querySelectorAll('.task-group-content').forEach(function(group) {
            group.style.display = 'none';
        });
        
        // Caso especial: "all" muestra todas las tareas
        if (groupId === 'all') {
            showAllTasks();
            return;
        }
        
        // Mostrar el grupo seleccionado
        const selectedGroup = document.getElementById('group-' + groupId);
        if (selectedGroup) {
            selectedGroup.style.display = 'block';
        }
    }

    function completeTask(taskId, userName) {
        // Deshabilitar el botón para evitar múltiples clics
        const button = document.querySelector(`.complete-task-btn[data-task-id="${taskId}"]`);
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Procesando...';
        }
        
        // Obtener la hora actual en formato HH:MM
        const now = new Date();
        const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
        
        // Realizar petición AJAX
        fetch(`/tasks/local-user/tasks/${taskId}/ajax-complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ notes: '' })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al completar la tarea');
            }
            return response.json();
        })
        .then(data => {
            // Actualizar la interfaz para mostrar que la tarea ha sido completada
            const cell = button.parentNode;
            cell.innerHTML = `
                <span class="badge bg-success">
                    <i class="bi bi-check-lg"></i> Completada
                    por ${userName} a las ${currentTime}
                </span>
            `;
            
            // Añadir la tarea a la lista de tareas completadas
            const completedTasksContainer = document.querySelector('.list-group');
            if (completedTasksContainer) {
                const newTaskItem = document.createElement('div');
                newTaskItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                newTaskItem.innerHTML = `
                    <div>
                        <h6 class="mb-1">${data.taskTitle}</h6>
                        <small class="text-muted">
                            Completada por <strong>${userName}</strong> a las ${currentTime}
                        </small>
                    </div>
                    <span class="badge bg-success rounded-pill">
                        <i class="bi bi-check-lg"></i>
                    </span>
                `;
                
                // Insertar al principio de la lista
                const firstChild = completedTasksContainer.firstChild;
                if (firstChild) {
                    completedTasksContainer.insertBefore(newTaskItem, firstChild);
                } else {
                    completedTasksContainer.appendChild(newTaskItem);
                }
                
                // Si estaba vacío, quitar el mensaje "No has completado ninguna tarea hoy"
                const emptyMessage = document.querySelector('.card-body .text-center');
                if (emptyMessage) {
                    emptyMessage.parentNode.removeChild(emptyMessage);
                }
            }
            
            // Opcionalmente mostrar un mensaje de éxito
            const alertContainer = document.createElement('div');
            alertContainer.className = 'alert alert-success alert-dismissible fade show';
            alertContainer.innerHTML = `
                <i class="bi bi-check-circle-fill"></i> Tarea "${data.taskTitle}" completada correctamente.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insertar el mensaje al principio de la página
            const mainContainer = document.querySelector('.container-fluid');
            mainContainer.insertBefore(alertContainer, mainContainer.firstChild);
            
            // Auto-cerrar el mensaje después de 3 segundos
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.classList.remove('show');
                    setTimeout(() => {
                        if (alertContainer.parentNode) {
                            alertContainer.parentNode.removeChild(alertContainer);
                        }
                    }, 150);
                }
            }, 3000);
        })
        .catch(error => {
            console.error('Error:', error);
            // Restaurar el botón en caso de error
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-check-lg"></i> Completar';
            }
            
            // Mostrar mensaje de error
            const alertContainer = document.createElement('div');
            alertContainer.className = 'alert alert-danger alert-dismissible fade show';
            alertContainer.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill"></i> Error al completar la tarea: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const mainContainer = document.querySelector('.container-fluid');
            mainContainer.insertBefore(alertContainer, mainContainer.firstChild);
        });
    }
</script>
{% endblock %}