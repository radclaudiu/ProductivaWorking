{% extends 'layout.html' %}

{% block styles %}
<style>
    /* Estilos generales */
    body {
        background-color: #f8f9fa;
    }
    
    /* Estilos para el carrusel de fechas */
    .date-selector {
        display: flex;
        justify-content: space-between;
        background-color: #fff;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .day-selector {
        flex: 1;
        text-align: center;
        padding: 10px 5px;
        border-radius: 0;
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
    }
    
    .day-selector.active {
        background-color: rgba(13, 110, 253, 0.1);
        border-bottom: 3px solid var(--bs-primary);
        font-weight: bold;
    }
    
    .day-selector:not(.active):hover {
        background-color: rgba(0,0,0,0.03);
        cursor: pointer;
    }
    
    .day-name {
        font-size: 0.9rem;
        margin-bottom: 0.2rem;
    }
    
    .day-number {
        font-size: 1.3rem;
        font-weight: bold;
    }
    
    /* Estilos para la barra lateral de grupos */
    .task-groups-sidebar {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        height: calc(100vh - 160px);
        overflow-y: auto;
    }
    
    .task-group-item {
        padding: 15px 20px;
        border-left: 5px solid transparent;
        transition: all 0.2s;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .task-group-item:hover {
        background-color: rgba(0,0,0,0.03);
    }
    
    .task-group-item.active {
        background-color: rgba(13, 110, 253, 0.1);
        border-left-color: var(--bs-primary);
    }
    
    /* Estilos para las tarjetas de tareas */
    .task-card {
        margin-bottom: 15px;
        border-radius: 8px;
        transition: all 0.2s;
        border-left: 5px solid #17a2b8;
    }
    
    .task-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .task-card .card-header {
        background-color: rgba(23, 162, 184, 0.1);
        font-weight: bold;
    }
    
    .task-card.completed {
        border-left-color: #28a745;
        opacity: 0.8;
    }
    
    .task-card.completed .card-header {
        background-color: rgba(40, 167, 69, 0.1);
    }
    
    /* Para simular el contenido de la captura de pantalla */
    .completion-progress {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid #28a745;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #28a745;
    }
    
    .task-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        margin-bottom: 15px;
        border-radius: 8px;
    }
    
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #6f42c1;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 10px;
    }
    
    .sidebar-icon {
        font-size: 1.5rem;
        margin-right: 15px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-2">
    <div class="row mb-2">
        <div class="col-12">
            <!-- Cabecera con nombre del usuario -->
            <div class="d-flex justify-content-between align-items-center">
                <h2>Tareas</h2>
                <div class="d-flex align-items-center">
                    <span class="mr-2">{{ local_user.name }} {{ local_user.last_name }}</span>
                    <a href="{{ url_for('tasks.local_logout') }}" class="btn btn-link text-secondary">
                        <i class="bi bi-box-arrow-right fs-4"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Carrusel de Fechas -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="date-selector">
                {% for date_item in date_carousel %}
                    <a href="{{ date_item.url }}" class="text-decoration-none">
                        <div class="day-selector {% if date_item.active %}active{% endif %}">
                            <div class="day-name">{{ date_item.day_name }}</div>
                            <div class="day-number">{{ date_item.day }}</div>
                            {% if date_item.date == today %}
                                <small class="text-primary">Hoy</small>
                            {% endif %}
                        </div>
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Barra lateral con grupos de tareas -->
        <div class="col-md-3 mb-3">
            <div class="task-groups-sidebar">
                <div class="p-3 mb-2 border-bottom">
                    <h5 class="mb-0">Grupos de Tareas</h5>
                </div>
                
                <!-- Elemento "Todo el día" con progreso -->
                <div class="task-group-item active" data-group-id="all">
                    <div class="d-flex align-items-center">
                        <div class="completion-progress">77%</div>
                        <div class="ms-3">
                            <div class="fw-bold">Todo el día</div>
                            <small class="text-muted">De 00:00h</small>
                        </div>
                    </div>
                </div>
                
                <!-- Grupos de tareas -->
                {% for group_id, group_data in grouped_tasks.items() %}
                <div class="task-group-item" data-group-id="{{ group_id }}" style="border-left-color: {{ group_data.group.color }};">
                    <div>
                        <div class="fw-bold">{{ group_data.group.name }}</div>
                        <small class="text-muted">{{ group_data.tasks|length }} tareas</small>
                    </div>
                    <div class="badge {% if group_data.completed_count == group_data.tasks|length %}bg-success{% else %}bg-secondary{% endif %}">
                        {{ group_data.completed_count or 0 }}/{{ group_data.tasks|length }}
                    </div>
                </div>
                {% endfor %}
                
                {% if ungrouped_tasks %}
                <div class="task-group-item" data-group-id="ungrouped">
                    <div>
                        <div class="fw-bold">Tareas Generales</div>
                        <small class="text-muted">{{ ungrouped_tasks|length }} tareas</small>
                    </div>
                    <div class="badge bg-secondary">
                        {{ completed_ungrouped_count or 0 }}/{{ ungrouped_tasks|length }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Contenido principal con tareas -->
        <div class="col-md-9">
            <div class="p-3 bg-white rounded shadow-sm mb-3">
                <h5 class="mb-0">
                    {% if selected_date == today %}
                        Tareas para hoy
                    {% else %}
                        Tareas para {{ selected_date.strftime('%d/%m/%Y') }}
                    {% endif %}
                    <span class="badge bg-info float-end">{{ active_tasks|length }} tareas</span>
                </h5>
            </div>
            
            <!-- Lista de tareas -->
            <div id="tasks-container">
                {% for group_id, group_data in grouped_tasks.items() %}
                <div class="task-group-content" id="group-{{ group_id }}">
                    {% for task in group_data.tasks %}
                    <div class="card task-card mb-3 {% if task.completed_today %}completed{% endif %}" style="border-left-color: {{ group_data.group.color }};">
                        <div class="card-header d-flex justify-content-between align-items-center" style="background-color: {{ group_data.group.color }}10;">
                            <h6 class="mb-0">{{ task.title }}</h6>
                            <div>
                                {% if task.priority.value == 'baja' %}
                                <span class="badge bg-info">Baja</span>
                                {% elif task.priority.value == 'media' %}
                                <span class="badge bg-primary">Media</span>
                                {% elif task.priority.value == 'alta' %}
                                <span class="badge bg-warning">Alta</span>
                                {% else %}
                                <span class="badge bg-danger">Urgente</span>
                                {% endif %}
                                
                                {% if task.completed_today %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-lg"></i> Completada
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">{{ task.description or 'Sin descripción' }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                {% if task.completed_today %}
                                <small class="text-muted">
                                    Completada por {{ task.completion_info.user }} a las {{ task.completion_info.time }}
                                </small>
                                {% else %}
                                <button type="button" onclick="completeTask({{ task.id }}, '{{ local_user.name }} {{ local_user.last_name }}')" class="btn btn-sm btn-success complete-task-btn" data-task-id="{{ task.id }}">
                                    <i class="bi bi-check-lg"></i> Completar
                                </button>
                                {% endif %}
                                
                                {% if task.completion_info %}
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-person"></i> {{ task.completion_info.user }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
                
                {% if ungrouped_tasks %}
                <div class="task-group-content" id="group-ungrouped">
                    {% for task in ungrouped_tasks %}
                    <div class="card task-card mb-3 {% if task.completed_today %}completed{% endif %}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">{{ task.title }}</h6>
                            <div>
                                {% if task.priority.value == 'baja' %}
                                <span class="badge bg-info">Baja</span>
                                {% elif task.priority.value == 'media' %}
                                <span class="badge bg-primary">Media</span>
                                {% elif task.priority.value == 'alta' %}
                                <span class="badge bg-warning">Alta</span>
                                {% else %}
                                <span class="badge bg-danger">Urgente</span>
                                {% endif %}
                                
                                {% if task.completed_today %}
                                <span class="badge bg-success">
                                    <i class="bi bi-check-lg"></i> Completada
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">{{ task.description or 'Sin descripción' }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                {% if task.completed_today %}
                                <small class="text-muted">
                                    Completada por {{ task.completion_info.user }} a las {{ task.completion_info.time }}
                                </small>
                                {% else %}
                                <button type="button" onclick="completeTask({{ task.id }}, '{{ local_user.name }} {{ local_user.last_name }}')" class="btn btn-sm btn-success complete-task-btn" data-task-id="{{ task.id }}">
                                    <i class="bi bi-check-lg"></i> Completar
                                </button>
                                {% endif %}
                                
                                {% if task.completion_info %}
                                <span class="badge bg-light text-dark">
                                    <i class="bi bi-person"></i> {{ task.completion_info.user }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if not active_tasks %}
                <div class="text-center py-5">
                    <i class="bi bi-check-circle-fill text-success fs-1"></i>
                    <h5 class="mt-3">¡No hay tareas pendientes para hoy!</h5>
                    <p class="text-muted">Todas las tareas han sido completadas.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Inicialización - Mostrar solo el grupo activo al cargar
    document.addEventListener('DOMContentLoaded', function() {
        // Ocultar todos los grupos de tareas excepto el activo
        document.querySelectorAll('.task-group-content').forEach(function(group) {
            group.style.display = 'none';
        });
        
        // Por defecto, mostrar el grupo 'all' (todas las tareas)
        showAllTasks();
        
        // Agregar manejadores de eventos a los elementos de grupo
        document.querySelectorAll('.task-group-item').forEach(function(groupItem) {
            groupItem.addEventListener('click', function() {
                // Desactivar cualquier grupo activo
                document.querySelectorAll('.task-group-item').forEach(function(item) {
                    item.classList.remove('active');
                });
                
                // Activar este grupo
                this.classList.add('active');
                
                // Mostrar las tareas correspondientes
                const groupId = this.getAttribute('data-group-id');
                showTasksForGroup(groupId);
            });
        });
    });
    
    // Mostrar todas las tareas
    function showAllTasks() {
        document.querySelectorAll('.task-group-content').forEach(function(group) {
            group.style.display = 'block';
        });
        
        // Activar el elemento "Todo el día"
        document.querySelectorAll('.task-group-item').forEach(function(item) {
            item.classList.remove('active');
        });
        document.querySelector('.task-group-item[data-group-id="all"]').classList.add('active');
    }
    
    // Mostrar tareas para un grupo específico
    function showTasksForGroup(groupId) {
        // Ocultar todos los grupos
        document.querySelectorAll('.task-group-content').forEach(function(group) {
            group.style.display = 'none';
        });
        
        // Caso especial: "all" muestra todas las tareas
        if (groupId === 'all') {
            showAllTasks();
            return;
        }
        
        // Mostrar el grupo seleccionado
        const selectedGroup = document.getElementById('group-' + groupId);
        if (selectedGroup) {
            selectedGroup.style.display = 'block';
        }
    }

    function completeTask(taskId, userName) {
        // Deshabilitar el botón para evitar múltiples clics
        const button = document.querySelector(`.complete-task-btn[data-task-id="${taskId}"]`);
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Procesando...';
        }
        
        // Obtener la hora actual en formato HH:MM
        const now = new Date();
        const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
        
        // Realizar petición AJAX
        fetch(`/tasks/local-user/tasks/${taskId}/ajax-complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ notes: '' })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al completar la tarea');
            }
            return response.json();
        })
        .then(data => {
            // Actualizar la interfaz para mostrar que la tarea ha sido completada
            const cell = button.parentNode;
            cell.innerHTML = `
                <span class="badge bg-success">
                    <i class="bi bi-check-lg"></i> Completada
                    por ${userName} a las ${currentTime}
                </span>
            `;
            
            // Añadir la tarea a la lista de tareas completadas
            const completedTasksContainer = document.querySelector('.list-group');
            if (completedTasksContainer) {
                const newTaskItem = document.createElement('div');
                newTaskItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                newTaskItem.innerHTML = `
                    <div>
                        <h6 class="mb-1">${data.taskTitle}</h6>
                        <small class="text-muted">
                            Completada por <strong>${userName}</strong> a las ${currentTime}
                        </small>
                    </div>
                    <span class="badge bg-success rounded-pill">
                        <i class="bi bi-check-lg"></i>
                    </span>
                `;
                
                // Insertar al principio de la lista
                const firstChild = completedTasksContainer.firstChild;
                if (firstChild) {
                    completedTasksContainer.insertBefore(newTaskItem, firstChild);
                } else {
                    completedTasksContainer.appendChild(newTaskItem);
                }
                
                // Si estaba vacío, quitar el mensaje "No has completado ninguna tarea hoy"
                const emptyMessage = document.querySelector('.card-body .text-center');
                if (emptyMessage) {
                    emptyMessage.parentNode.removeChild(emptyMessage);
                }
            }
            
            // Opcionalmente mostrar un mensaje de éxito
            const alertContainer = document.createElement('div');
            alertContainer.className = 'alert alert-success alert-dismissible fade show';
            alertContainer.innerHTML = `
                <i class="bi bi-check-circle-fill"></i> Tarea "${data.taskTitle}" completada correctamente.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insertar el mensaje al principio de la página
            const mainContainer = document.querySelector('.container-fluid');
            mainContainer.insertBefore(alertContainer, mainContainer.firstChild);
            
            // Auto-cerrar el mensaje después de 3 segundos
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.classList.remove('show');
                    setTimeout(() => {
                        if (alertContainer.parentNode) {
                            alertContainer.parentNode.removeChild(alertContainer);
                        }
                    }, 150);
                }
            }, 3000);
        })
        .catch(error => {
            console.error('Error:', error);
            // Restaurar el botón en caso de error
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-check-lg"></i> Completar';
            }
            
            // Mostrar mensaje de error
            const alertContainer = document.createElement('div');
            alertContainer.className = 'alert alert-danger alert-dismissible fade show';
            alertContainer.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill"></i> Error al completar la tarea: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const mainContainer = document.querySelector('.container-fluid');
            mainContainer.insertBefore(alertContainer, mainContainer.firstChild);
        });
    }
</script>
{% endblock %}