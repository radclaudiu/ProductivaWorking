<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etiqueta: {{ product.name }}</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <style>
        :root {
            --olive-green: #4a5d23;
            --terracotta: #cd5a34;
            --chocolate-brown: #5c3213;
            --burnt-orange: #b7521e;
            --beige-bg: #f7f3e9;
        }
        
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: var(--beige-bg);
            touch-action: manipulation; /* Mejora para tablets táctiles */
        }
        
        /* Estilos para la etiqueta */
        .etiqueta {
            width: 35mm;   /* Ancho exacto para impresora de etiquetas - ACTUALIZADO */
            height: 40mm;  /* Alto exacto para impresora de etiquetas - ACTUALIZADO */
            padding: 2mm;
            text-align: center;
            box-sizing: border-box;
            margin: 0;
            page-break-inside: avoid;
            display: block; /* Cambiado de inline-block a block para mejor impresión */
            vertical-align: top;
            border: 0.5pt dotted #ccc; /* Borde sutil para ayudar en el corte */
            position: relative;
            overflow: hidden; /* Evitar desbordamiento */
        }
        
        /* Estilos dinámicos según la plantilla */
        {% set t = template %}
        
        .producto {
            font-weight: {{ 'bold' if t.titulo_bold else 'normal' }};
            font-size: {{ t.titulo_size }}pt;
            margin-bottom: 3mm;
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            position: absolute;
            top: {{ t.titulo_y }}%;
            left: {{ t.titulo_x }}%;
            transform: translate(-50%, -50%);
            width: 95%;
        }
        
        .conservacion {
            font-weight: {{ 'bold' if t.conservacion_bold else 'normal' }};
            font-size: {{ t.conservacion_size }}pt;
            padding: 1mm;
            background-color: #f8f9fa;
            border-radius: 2mm;
            position: absolute;
            top: {{ t.conservacion_y }}%;
            left: {{ t.conservacion_x }}%;
            transform: translate(-50%, -50%);
            width: 90%;
        }
        
        .preparado {
            font-weight: {{ 'bold' if t.preparador_bold else 'normal' }};
            font-size: {{ t.preparador_size }}pt;
            position: absolute;
            top: {{ t.preparador_y }}%;
            left: {{ t.preparador_x }}%;
            transform: translate(-50%, -50%);
            width: 90%;
        }
        
        .fecha {
            font-weight: {{ 'bold' if t.fecha_bold else 'normal' }};
            font-size: {{ t.fecha_size }}pt;
            position: absolute;
            top: {{ t.fecha_y }}%;
            left: {{ t.fecha_x }}%;
            transform: translate(-50%, -50%);
            width: 90%;
        }
        
        .caducidad {
            font-weight: {{ 'bold' if t.caducidad_bold else 'normal' }};
            font-size: {{ t.caducidad_size }}pt;
            /* Quitados los bordes para la vista en pantalla también */
            padding: 1.5mm;
            display: inline-block;
            background-color: #fff;
            position: absolute;
            top: calc({{ t.caducidad_y }}% + 2mm); /* Bajado 2mm */
            left: {{ t.caducidad_x }}%;
            transform: translate(-50%, -50%);
            width: auto;
            min-width: 80%;
        }
        
        .caducidad-secundaria {
            font-weight: {{ 'bold' if t.caducidad2_bold else 'normal' }};
            font-size: {{ t.caducidad2_size }}pt;
            /* Sin bordes */
            background-color: #f8f9fa;
            position: absolute;
            top: calc({{ t.caducidad2_y }}% + 1mm); /* Añadimos 1mm de ajuste vertical adicional */
            left: {{ t.caducidad2_x }}%;
            transform: translate(-50%, -50%);
            width: auto;
            min-width: 80%;
            margin-top: 2mm; /* Establecemos la separación a 2mm */
            padding: 1mm;
        }
        
        /* Todos los tipos de conservación en negro para impresora térmica */
        .conservacion-descongelacion, 
        .conservacion-refrigeracion,
        .conservacion-gastro,
        .conservacion-caliente,
        .conservacion-seco { 
            color: #000000; /* Negro para impresora térmica */
            font-weight: bold; /* Hacemos bold para mayor claridad */
        }
        
        /* Estilos para controles de impresión (solo visibles en pantalla) */
        .print-controls {
            text-align: center;
            margin: 20px auto;
            padding: 15px;
            max-width: 600px;
            background-color: var(--bs-dark);
            border-radius: 8px;
            color: white;
        }
        
        /* Para asegurar que la impresión sea correcta */
        @media print {
            body {
                margin: 0;
                padding: 0;
            }
            @page {
                margin: 0;
                size: 35mm 40mm; /* Forzar el tamaño exacto de la etiqueta - ACTUALIZADO */
            }
            .etiqueta {
                page-break-after: always; /* Forzar salto de página después de cada etiqueta */
                width: 35mm;
                height: 40mm;
                /* Quitar bordes en la impresión */
                border: none;
            }
            .caducidad, .caducidad-secundaria {
                border: none !important; /* Asegurar que no haya bordes en las caducidades al imprimir */
                box-shadow: none !important; /* Quitar cualquier sombra */
                background-color: transparent !important; /* Fondo transparente */
            }
            .nueva-pagina {
                display: none; /* No necesitamos este elemento en la impresión */
            }
            .print-controls {
                display: none; /* Ocultar controles en la impresión */
            }
        }
    </style>
</head>
<body>
    <!-- Controles de impresión simplificados -->
    <div class="print-controls" style="background-color: var(--olive-green); border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 90%; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
        <h5 class="text-white mb-2">Impresión de Etiqueta</h5>
        
        <!-- Contador de cantidad con botones - y + -->
        <div class="row g-2 justify-content-center align-items-center mb-3">
            <div class="col-auto">
                <div class="d-flex align-items-center" style="background-color: rgba(255,255,255,0.2); border-radius: 8px; padding: 5px;">
                    <button type="button" id="decrease-quantity" class="btn btn-outline-light btn-sm" style="width: 40px; height: 40px; font-size: 20px; font-weight: bold;">
                        -
                    </button>
                    <span id="quantity-display" class="mx-3 text-white" style="font-size: 24px; font-weight: bold; min-width: 40px; text-align: center;">1</span>
                    <button type="button" id="increase-quantity" class="btn btn-outline-light btn-sm" style="width: 40px; height: 40px; font-size: 20px; font-weight: bold;">
                        +
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Botón único de impresión directa -->
        <div class="row g-2 justify-content-center align-items-center mb-2">
            <div class="col-auto">
                <button type="button" id="brother-print-btn" class="btn btn-warning btn-lg" style="min-width: 280px; min-height: 54px; font-weight: bold;">
                    <i class="bi bi-printer-fill me-2"></i>IMPRIMIR
                </button>
            </div>
        </div>
        
        <!-- Botón para volver a la página de etiquetas -->
        <div class="row g-2 justify-content-center align-items-center mb-2">
            <div class="col-auto">
                <a href="/tasks/local-user/labels" class="btn btn-outline-light btn-lg" style="min-width: 220px;">
                    <i class="bi bi-arrow-left me-2"></i>Volver a productos
                </a>
            </div>
        </div>
        
        <div id="print-message" class="alert alert-info mt-2 mb-0" style="font-size: 14px; display: block;">Selecciona la cantidad de etiquetas y toca en "Imprimir en TD-4550DNWB"</div>
        
        <!-- Botones ocultos para mantener compatibilidad -->
        <button type="button" id="raspberry-print-btn" style="display: none;">Raspberry Pi</button>
        <button type="button" id="bluetooth-print-btn" style="display: none;">Bluetooth</button>
        <button type="button" id="android-print-btn" style="display: none;">Android</button>
        
        <!-- Contenedor oculto para la funcionalidad de impresión -->
        <div id="raspberry-printers-container" style="display: none;">
            <select id="raspberry-printer-select" class="form-select">
                <option value="">Buscando impresora...</option>
            </select>
        </div>
    </div>
    
    <!-- Script para adaptar según dispositivo -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Adaptar tamaños si estamos en tablet/móvil
            if (isMobile) {
                const printBtn = document.getElementById('bluetooth-print-btn');
                const quantitySelector = document.getElementById('quantity-selector');
                const printMessage = document.getElementById('print-message');
                
                if (printBtn) {
                    printBtn.classList.add('btn-lg');
                    printBtn.style.minHeight = '54px';
                    printBtn.style.minWidth = '220px';
                }
                
                if (quantitySelector) {
                    quantitySelector.classList.add('form-select-lg');
                    quantitySelector.style.fontSize = '1.2rem';
                }
                
                if (printMessage) {
                    printMessage.style.fontSize = '16px';
                }
            }
        });
    </script>
    
    <!-- Script para actualizar la cantidad -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const quantitySelector = document.getElementById('quantity-selector');
            const hiddenQuantity = document.getElementById('quantity');
            
            if (quantitySelector && hiddenQuantity) {
                quantitySelector.addEventListener('change', function() {
                    hiddenQuantity.value = this.value;
                    console.log("Cantidad actualizada:", this.value);
                });
                
                // Establecer valor inicial
                quantitySelector.value = hiddenQuantity.value || "1";
            }
        });
    </script>

    <!-- Etiquetas para imprimir -->
    {% for i in range(quantity) %}
        <div class="etiqueta">
            <div id="product-name" class="producto">{{ product.name|upper }}</div>
            <div id="conservation-type" class="conservacion conservacion-{{ conservation_type.value }}">{{ conservation_type.name }}</div>
            <div id="prepared-by" class="preparado">EMP: {{ user.name }} {{ user.last_name }}</div>
            <div id="start-date" class="fecha">INICIO: {{ now.strftime('%d/%m/%Y %H:%M') }}</div>
            <div id="expiry-date" class="caducidad">Caducidad: {{ expiry_datetime.strftime('%d/%m/%Y %H:%M') }}</div>
            {% if secondary_expiry_date %}
            <div id="secondary-expiry-date" class="caducidad caducidad-secundaria">Caducidad primaria: {{ secondary_expiry_date.strftime('%d/%m/%Y') }}</div>
            {% endif %}
        </div>
    {% endfor %}
    
    <!-- Etiquetas de refrigeración automáticas (cuando se genera una etiqueta de descongelación) -->
    {% if auto_generate_refrigeration and refrigeration_conservation_type %}
        {% for i in range(quantity) %}
            <div class="etiqueta">
                <div id="product-name" class="producto">{{ product.name|upper }}</div>
                <div id="conservation-type" class="conservacion conservacion-{{ refrigeration_conservation_type.value }}">{{ refrigeration_conservation_type.name }}</div>
                <div id="prepared-by" class="preparado">EMP: {{ user.name }} {{ user.last_name }}</div>
                <div id="start-date" class="fecha">INICIO: {{ refrigeration_start_time.strftime('%d/%m/%Y %H:%M') }}</div>
                <div id="expiry-date" class="caducidad">Caducidad: {{ refrigeration_expiry_datetime.strftime('%d/%m/%Y %H:%M') }}</div>
                {% if secondary_expiry_date %}
                <div id="secondary-expiry-date" class="caducidad caducidad-secundaria">Caducidad primaria: {{ secondary_expiry_date.strftime('%d/%m/%Y') }}</div>
                {% endif %}
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- Datos ocultos para la impresión con Brother -->
    <input type="hidden" id="quantity" value="{{ quantity }}">
    
    <!-- Scripts para Bootstrap y las impresoras -->
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- Cargar en orden: primero la biblioteca base, luego los scripts específicos -->
    <script src="/static/js/brother-printer.js"></script>
    <script src="/static/js/brother-bluetooth.js"></script>
    <!-- Script optimizado para tablets/PWA con Web Bluetooth API mejorado -->
    <script src="/static/js/brother-label-pwa.js"></script>
    <!-- Script para Raspberry Pi Print Server -->
    <script src="/static/js/raspberry-print-server.js"></script>
    <!-- Script para la app Android nativa con Brother -->
    <script src="/static/js/brother-simple-print.js"></script>
    
    <!-- Script para mejorar rendimiento táctil en tablets -->
    <script>
        // Implementar respuesta táctil más rápida en Safari iOS/iPadOS
        document.addEventListener('DOMContentLoaded', function() {
            // Evitar delay de 300ms en Safari
            document.documentElement.style.touchAction = "manipulation";
            
            // Mejorar respuesta del botón de impresión
            const printBtn = document.getElementById('bluetooth-print-btn');
            if (printBtn) {
                // Feedback visual al tocar
                printBtn.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.97)';
                    this.style.opacity = '0.9';
                });
                
                ['touchend', 'touchcancel'].forEach(event => {
                    printBtn.addEventListener(event, function() {
                        this.style.transform = 'scale(1)';
                        this.style.opacity = '1';
                    });
                });
                
                // También hacer que el selector tenga mejor respuesta táctil
                const quantitySelector = document.getElementById('quantity-selector');
                if (quantitySelector) {
                    quantitySelector.style.fontWeight = 'bold';
                    // Hacer que la fuente sea más grande para mejor selección en táctil
                    quantitySelector.style.fontSize = '1.2rem';
                }
            }
        });
    </script>
    
    <script>
        // Variables globales para cantidad y control de impresión
        let currentQuantity = 1;
        let isAndroidApp = typeof AndroidBridge !== 'undefined';
        
        // Callbacks globales simplificados para Brother Print
        window.BrotherPrint = {
            onPrintSuccess: function() {
                console.log('Impresión exitosa');
                showMessage('Etiquetas enviadas correctamente a la impresora', false);
            },
            
            onPrintError: function(errorMessage) {
                console.error('Error de impresión:', errorMessage);
                showMessage('Error de impresión: ' + errorMessage, true);
            }
        };
        
        // Inicializar controles
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Inicializando interfaz de impresión de etiquetas");
            
            // Configurar botones del contador
            setupQuantityControls();
            
            // Configurar botón de impresión
            setupPrintButton();
            
            // Función para mostrar mensajes
            function showMessage(message, isError = false) {
                const messageArea = document.getElementById('print-message');
                if (messageArea) {
                    messageArea.style.display = "block";
                    messageArea.textContent = message;
                    messageArea.className = isError ? "alert alert-danger mt-3" : "alert alert-info mt-3";
                    
                    // Ocultar después de 5 segundos solo si no es error
                    if (!isError) {
                        setTimeout(() => {
                            messageArea.style.display = "none";
                        }, 5000);
                    }
                }
            };
            
            // Función para configurar los controles de cantidad
            function setupQuantityControls() {
                const decreaseBtn = document.getElementById('decrease-quantity');
                const increaseBtn = document.getElementById('increase-quantity');
                const quantityDisplay = document.getElementById('quantity-display');
                
                if (decreaseBtn && increaseBtn && quantityDisplay) {
                    decreaseBtn.addEventListener('click', function() {
                        if (currentQuantity > 1) {
                            currentQuantity--;
                            quantityDisplay.textContent = currentQuantity;
                        }
                    });
                    
                    increaseBtn.addEventListener('click', function() {
                        if (currentQuantity < 10) {
                            currentQuantity++;
                            quantityDisplay.textContent = currentQuantity;
                        }
                    });
                }
            }
            
            // Función para configurar el botón de impresión
            function setupPrintButton() {
                const printBtn = document.getElementById('brother-print-btn');
                if (printBtn) {
                    printBtn.addEventListener('click', function() {
                        // Verificar si estamos en Android
                        if (typeof AndroidBridge === 'undefined') {
                            showMessage('Esta función solo está disponible en la aplicación Android', true);
                            return;
                        }
                        
                        // Verificar que el método printImage existe
                        if (typeof AndroidBridge.printImage !== 'function') {
                            showMessage('Método de impresión no disponible', true);
                            return;
                        }
                        
                        showMessage('Preparando impresión de ' + currentQuantity + ' etiqueta(s)...', false);
                        
                        // Imprimir directamente
                        imprimirEtiquetas();
                    });
                }
            }
            
            // Función para imprimir las etiquetas
            function imprimirEtiquetas() {
                const labelData = getLabelData();
                const success = printBrotherLabel(labelData, currentQuantity);
                
                if (success) {
                    showMessage(`${currentQuantity} etiqueta(s) enviada(s) a la impresora Brother`, false);
                } else {
                    showMessage('Error al enviar etiquetas a la impresora', true);
                }
            }
            
            // Función para obtener datos de la etiqueta desde el DOM
            function getLabelData() {
                return {
                    productName: document.getElementById("product-name")?.textContent?.trim() || "PRODUCTO",
                    conservationType: document.getElementById("conservation-type")?.textContent?.trim() || "CONSERVACIÓN",
                    preparedBy: document.getElementById("prepared-by")?.textContent?.trim() || "EMPLEADO",
                    startDate: document.getElementById("start-date")?.textContent?.trim() || "FECHA INICIO",
                    expiryDate: document.getElementById("expiry-date")?.textContent?.trim() || "FECHA CADUCIDAD"
                };
            }
            
            // Función para generar canvas de etiqueta (520x449px para 44x38mm)
            function generateLabelCanvas(datos) {
                const canvas = document.createElement('canvas');
                canvas.width = 520;   // 44mm a 300 DPI
                canvas.height = 449;  // 38mm a 300 DPI
                const ctx = canvas.getContext('2d');
                
                // Fondo blanco
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Configurar estilos base
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                
                // Nombre del producto
                ctx.font = 'bold 32px Arial';
                ctx.fillText(datos.productName, canvas.width / 2, 80);
                
                // Tipo de conservación
                ctx.font = 'bold 24px Arial';
                ctx.fillText(datos.conservationType, canvas.width / 2, 130);
                
                // Información adicional (alineada a la izquierda)
                ctx.textAlign = 'left';
                const leftMargin = 35;
                
                ctx.font = '18px Arial';
                ctx.fillText(datos.preparedBy, leftMargin, 200);
                ctx.fillText(datos.startDate, leftMargin, 240);
                
                // Fecha de caducidad destacada
                ctx.font = 'bold 20px Arial';
                ctx.fillText(datos.expiryDate, leftMargin, 290);
                
                // Borde de la etiqueta
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.strokeRect(10, 10, 500, 429);
                
                return canvas;
            }
        });
    </script>
</body>
</html>
