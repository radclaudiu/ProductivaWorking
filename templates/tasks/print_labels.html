<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etiqueta: {{ product.name }}</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <style>
        :root {
            --olive-green: #4a5d23;
            --terracotta: #cd5a34;
            --chocolate-brown: #5c3213;
            --burnt-orange: #b7521e;
            --beige-bg: #f7f3e9;
        }
        
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: var(--beige-bg);
            touch-action: manipulation; /* Mejora para tablets táctiles */
        }
        
        /* Estilos para la etiqueta */
        .etiqueta {
            width: 35mm;   /* Ancho exacto para impresora de etiquetas - ACTUALIZADO */
            height: 40mm;  /* Alto exacto para impresora de etiquetas - ACTUALIZADO */
            padding: 2mm;
            text-align: center;
            box-sizing: border-box;
            margin: 0;
            page-break-inside: avoid;
            display: block; /* Cambiado de inline-block a block para mejor impresión */
            vertical-align: top;
            border: 0.5pt dotted #ccc; /* Borde sutil para ayudar en el corte */
            position: relative;
            overflow: hidden; /* Evitar desbordamiento */
        }
        
        /* Estilos dinámicos según la plantilla */
        {% set t = template %}
        
        .producto {
            font-weight: {{ 'bold' if t.titulo_bold else 'normal' }};
            font-size: {{ t.titulo_size }}pt;
            margin-bottom: 3mm;
            text-transform: uppercase;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            position: absolute;
            top: {{ t.titulo_y }}%;
            left: {{ t.titulo_x }}%;
            transform: translate(-50%, -50%);
            width: 95%;
        }
        
        .conservacion {
            font-weight: {{ 'bold' if t.conservacion_bold else 'normal' }};
            font-size: {{ t.conservacion_size }}pt;
            padding: 1mm;
            background-color: #f8f9fa;
            border-radius: 2mm;
            position: absolute;
            top: {{ t.conservacion_y }}%;
            left: {{ t.conservacion_x }}%;
            transform: translate(-50%, -50%);
            width: 90%;
        }
        
        .preparado {
            font-weight: {{ 'bold' if t.preparador_bold else 'normal' }};
            font-size: {{ t.preparador_size }}pt;
            position: absolute;
            top: {{ t.preparador_y }}%;
            left: {{ t.preparador_x }}%;
            transform: translate(-50%, -50%);
            width: 90%;
        }
        
        .fecha {
            font-weight: {{ 'bold' if t.fecha_bold else 'normal' }};
            font-size: {{ t.fecha_size }}pt;
            position: absolute;
            top: {{ t.fecha_y }}%;
            left: {{ t.fecha_x }}%;
            transform: translate(-50%, -50%);
            width: 90%;
        }
        
        .caducidad {
            font-weight: {{ 'bold' if t.caducidad_bold else 'normal' }};
            font-size: {{ t.caducidad_size }}pt;
            /* Quitados los bordes para la vista en pantalla también */
            padding: 1.5mm;
            display: inline-block;
            background-color: #fff;
            position: absolute;
            top: calc({{ t.caducidad_y }}% + 2mm); /* Bajado 2mm */
            left: {{ t.caducidad_x }}%;
            transform: translate(-50%, -50%);
            width: auto;
            min-width: 80%;
        }
        
        .caducidad-secundaria {
            font-weight: {{ 'bold' if t.caducidad2_bold else 'normal' }};
            font-size: {{ t.caducidad2_size }}pt;
            /* Sin bordes */
            background-color: #f8f9fa;
            position: absolute;
            top: calc({{ t.caducidad2_y }}% + 1mm); /* Añadimos 1mm de ajuste vertical adicional */
            left: {{ t.caducidad2_x }}%;
            transform: translate(-50%, -50%);
            width: auto;
            min-width: 80%;
            margin-top: 2mm; /* Establecemos la separación a 2mm */
            padding: 1mm;
        }
        
        /* Todos los tipos de conservación en negro para impresora térmica */
        .conservacion-descongelacion, 
        .conservacion-refrigeracion,
        .conservacion-gastro,
        .conservacion-caliente,
        .conservacion-seco { 
            color: #000000; /* Negro para impresora térmica */
            font-weight: bold; /* Hacemos bold para mayor claridad */
        }
        
        /* Estilos para controles de impresión (solo visibles en pantalla) */
        .print-controls {
            text-align: center;
            margin: 20px auto;
            padding: 15px;
            max-width: 600px;
            background-color: var(--bs-dark);
            border-radius: 8px;
            color: white;
        }
        
        /* Para asegurar que la impresión sea correcta */
        @media print {
            body {
                margin: 0;
                padding: 0;
            }
            @page {
                margin: 0;
                size: 35mm 40mm; /* Forzar el tamaño exacto de la etiqueta - ACTUALIZADO */
            }
            .etiqueta {
                page-break-after: always; /* Forzar salto de página después de cada etiqueta */
                width: 35mm;
                height: 40mm;
                /* Quitar bordes en la impresión */
                border: none;
            }
            .caducidad, .caducidad-secundaria {
                border: none !important; /* Asegurar que no haya bordes en las caducidades al imprimir */
                box-shadow: none !important; /* Quitar cualquier sombra */
                background-color: transparent !important; /* Fondo transparente */
            }
            .nueva-pagina {
                display: none; /* No necesitamos este elemento en la impresión */
            }
            .print-controls {
                display: none; /* Ocultar controles en la impresión */
            }
        }
    </style>
</head>
<body>
    <!-- Controles de impresión simplificados -->
    <div class="print-controls" style="background-color: var(--olive-green); border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 90%; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
        <h5 class="text-white mb-2">Impresión de Etiqueta</h5>
        
        <div class="row g-2 justify-content-center align-items-center mb-2">
            <div class="col-auto">
                <select id="quantity-selector" class="form-select me-2" style="min-width: 60px; font-weight: bold;">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="10">10</option>
                </select>
            </div>
        </div>
        
        <!-- Contenedor oculto para la funcionalidad de impresión -->
        <div id="raspberry-printers-container" style="display: none;">
            <select id="raspberry-printer-select" class="form-select">
                <option value="">Buscando impresora...</option>
            </select>
        </div>
        
        <div id="print-message" class="alert alert-info mt-2 mb-0" style="font-size: 14px; display: block;">Imprimiendo automáticamente...</div>
        
        <!-- Botón oculto para funcionamiento interno -->
        <button type="button" id="raspberry-print-btn" style="display: none;">Raspberry Pi</button>
        <button type="button" id="bluetooth-print-btn" style="display: none;">Bluetooth</button>
    </div>
    
    <!-- Script para adaptar según dispositivo -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Adaptar tamaños si estamos en tablet/móvil
            if (isMobile) {
                const printBtn = document.getElementById('bluetooth-print-btn');
                const quantitySelector = document.getElementById('quantity-selector');
                const printMessage = document.getElementById('print-message');
                
                if (printBtn) {
                    printBtn.classList.add('btn-lg');
                    printBtn.style.minHeight = '54px';
                    printBtn.style.minWidth = '220px';
                }
                
                if (quantitySelector) {
                    quantitySelector.classList.add('form-select-lg');
                    quantitySelector.style.fontSize = '1.2rem';
                }
                
                if (printMessage) {
                    printMessage.style.fontSize = '16px';
                }
            }
        });
    </script>
    
    <!-- Script para actualizar la cantidad -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const quantitySelector = document.getElementById('quantity-selector');
            const hiddenQuantity = document.getElementById('quantity');
            
            if (quantitySelector && hiddenQuantity) {
                quantitySelector.addEventListener('change', function() {
                    hiddenQuantity.value = this.value;
                    console.log("Cantidad actualizada:", this.value);
                });
                
                // Establecer valor inicial
                quantitySelector.value = hiddenQuantity.value || "1";
            }
        });
    </script>

    <!-- Etiquetas para imprimir -->
    {% for i in range(quantity) %}
        <div class="etiqueta">
            <div id="product-name" class="producto">{{ product.name|upper }}</div>
            <div id="conservation-type" class="conservacion conservacion-{{ conservation_type.value }}">{{ conservation_type.name }}</div>
            <div id="prepared-by" class="preparado">EMP: {{ user.name }} {{ user.last_name }}</div>
            <div id="start-date" class="fecha">INICIO: {{ now.strftime('%d/%m/%Y %H:%M') }}</div>
            <div id="expiry-date" class="caducidad">Caducidad: {{ expiry_datetime.strftime('%d/%m/%Y %H:%M') }}</div>
            {% if secondary_expiry_date %}
            <div id="secondary-expiry-date" class="caducidad caducidad-secundaria">Caducidad primaria: {{ secondary_expiry_date.strftime('%d/%m/%Y') }}</div>
            {% endif %}
        </div>
    {% endfor %}
    
    <!-- Etiquetas de refrigeración automáticas (cuando se genera una etiqueta de descongelación) -->
    {% if auto_generate_refrigeration and refrigeration_conservation_type %}
        {% for i in range(quantity) %}
            <div class="etiqueta">
                <div id="product-name" class="producto">{{ product.name|upper }}</div>
                <div id="conservation-type" class="conservacion conservacion-{{ refrigeration_conservation_type.value }}">{{ refrigeration_conservation_type.name }}</div>
                <div id="prepared-by" class="preparado">EMP: {{ user.name }} {{ user.last_name }}</div>
                <div id="start-date" class="fecha">INICIO: {{ refrigeration_start_time.strftime('%d/%m/%Y %H:%M') }}</div>
                <div id="expiry-date" class="caducidad">Caducidad: {{ refrigeration_expiry_datetime.strftime('%d/%m/%Y %H:%M') }}</div>
                {% if secondary_expiry_date %}
                <div id="secondary-expiry-date" class="caducidad caducidad-secundaria">Caducidad primaria: {{ secondary_expiry_date.strftime('%d/%m/%Y') }}</div>
                {% endif %}
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- Datos ocultos para la impresión con Brother -->
    <input type="hidden" id="quantity" value="{{ quantity }}">
    
    <!-- Scripts para Bootstrap y las impresoras -->
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- Cargar en orden: primero la biblioteca base, luego los scripts específicos -->
    <script src="/static/js/brother-printer.js"></script>
    <script src="/static/js/brother-bluetooth.js"></script>
    <!-- Script optimizado para tablets/PWA con Web Bluetooth API mejorado -->
    <script src="/static/js/brother-label-pwa.js"></script>
    <!-- Script para Raspberry Pi Print Server -->
    <script src="/static/js/raspberry-print-server.js"></script>
    
    <!-- Script para mejorar rendimiento táctil en tablets -->
    <script>
        // Implementar respuesta táctil más rápida en Safari iOS/iPadOS
        document.addEventListener('DOMContentLoaded', function() {
            // Evitar delay de 300ms en Safari
            document.documentElement.style.touchAction = "manipulation";
            
            // Mejorar respuesta del botón de impresión
            const printBtn = document.getElementById('bluetooth-print-btn');
            if (printBtn) {
                // Feedback visual al tocar
                printBtn.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.97)';
                    this.style.opacity = '0.9';
                });
                
                ['touchend', 'touchcancel'].forEach(event => {
                    printBtn.addEventListener(event, function() {
                        this.style.transform = 'scale(1)';
                        this.style.opacity = '1';
                    });
                });
                
                // También hacer que el selector tenga mejor respuesta táctil
                const quantitySelector = document.getElementById('quantity-selector');
                if (quantitySelector) {
                    quantitySelector.style.fontWeight = 'bold';
                    // Hacer que la fuente sea más grande para mejor selección en táctil
                    quantitySelector.style.fontSize = '1.2rem';
                }
            }
        });
    </script>
    
    <script>
        // Inicializar controles
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Inicializando interfaz de impresión de etiquetas");
            
            // Función para mostrar mensajes
            const showMessage = (message, isError = false) => {
                const messageArea = document.getElementById('print-message');
                if (messageArea) {
                    messageArea.style.display = "block";
                    messageArea.textContent = message;
                    messageArea.className = isError ? "alert alert-danger mt-3" : "alert alert-info mt-3";
                    
                    // Ocultar después de 5 segundos solo si no es error
                    if (!isError) {
                        setTimeout(() => {
                            messageArea.style.display = "none";
                        }, 5000);
                    }
                }
            };
            
            // Obtener datos de la etiqueta para imprimir
            const getPrintData = () => {
                return {
                    productName: document.getElementById("product-name").textContent || "",
                    conservationType: document.getElementById("conservation-type").textContent || "",
                    preparedBy: document.getElementById("prepared-by").textContent || "",
                    startDate: document.getElementById("start-date").textContent || "",
                    expiryDate: document.getElementById("expiry-date").textContent || "",
                    secondaryExpiryDate: document.getElementById("secondary-expiry-date") ? 
                        document.getElementById("secondary-expiry-date").textContent : "",
                    quantity: parseInt(document.getElementById("quantity").value || "1")
                };
            };
            
            // Generar comandos para la impresora Brother
            const generateBrotherCommand = (data) => {
                // Inicio de comandos ESC/POS
                const ESC = 0x1B;
                const GS = 0x1D;
                const INIT = [ESC, 0x40]; // Inicializar impresora
                const FONT_B = [ESC, 0x4D, 0x01]; // Fuente B (más pequeña)
                const FONT_A = [ESC, 0x4D, 0x00]; // Fuente A (normal)
                const ALIGN_CENTER = [ESC, 0x61, 0x01]; // Centrar texto
                const ALIGN_LEFT = [ESC, 0x61, 0x00]; // Alinear a la izquierda
                const BOLD_ON = [ESC, 0x45, 0x01]; // Activar negrita
                const BOLD_OFF = [ESC, 0x45, 0x00]; // Desactivar negrita
                const FONT_SIZE_NORMAL = [GS, 0x21, 0x00]; // Tamaño normal
                const FONT_SIZE_DOUBLE = [GS, 0x21, 0x11]; // Doble alto y ancho
                const LINE_FEED = [0x0A]; // Salto de línea
                const CUT_PAPER = [GS, 0x56, 0x41, 0x10]; // Cortar papel
                
                // Construir el comando completo
                let command = [];
                
                // Inicializar impresora
                command = command.concat(INIT);
                
                // Configurar título (Nombre del producto)
                command = command.concat(ALIGN_CENTER, FONT_SIZE_DOUBLE, BOLD_ON);
                command = command.concat(Array.from(new TextEncoder().encode(data.productName)));
                command = command.concat(LINE_FEED, LINE_FEED);
                
                // Configurar tipo de conservación
                command = command.concat(FONT_SIZE_NORMAL, BOLD_ON);
                command = command.concat(Array.from(new TextEncoder().encode(data.conservationType)));
                command = command.concat(LINE_FEED, LINE_FEED);
                
                // Configurar información de preparación
                command = command.concat(ALIGN_LEFT, BOLD_OFF);
                command = command.concat(Array.from(new TextEncoder().encode(data.preparedBy)));
                command = command.concat(LINE_FEED);
                
                // Configurar fecha de inicio
                command = command.concat(Array.from(new TextEncoder().encode(data.startDate)));
                command = command.concat(LINE_FEED);
                
                // Configurar fecha de caducidad (en negrita)
                command = command.concat(BOLD_ON);
                command = command.concat(Array.from(new TextEncoder().encode(data.expiryDate)));
                command = command.concat(LINE_FEED);
                
                // Agregar fecha de caducidad secundaria si existe
                if (data.secondaryExpiryDate) {
                    command = command.concat(BOLD_OFF);
                    command = command.concat(Array.from(new TextEncoder().encode(data.secondaryExpiryDate)));
                    command = command.concat(LINE_FEED);
                }
                
                // Agregar espacio al final y cortar papel
                command = command.concat(LINE_FEED, LINE_FEED, LINE_FEED, CUT_PAPER);
                
                return new Uint8Array(command);
            };
            
            // Enviar datos a la impresora Bluetooth
            const sendToPrinter = async (device, printData) => {
                try {
                    // Guardar la impresora para futuros usos
                    localStorage.setItem('lastPrinterName', device.name || 'Unknown Printer');
                    
                    // Conectar al dispositivo
                    showMessage(`Conectando a la impresora ${device.name}...`);
                    const server = await device.gatt.connect();
                    
                    // Encontrar el servicio adecuado para la impresión
                    let service;
                    const serviceUUIDs = [
                        '000018f0-0000-1000-8000-00805f9b34fb',  // Servicio de impresión estándar
                        '1222e5db-36e1-4a53-bfef-bf7da833c5a5',  // Servicio de impresión alternativo
                        '00001101-0000-1000-8000-00805f9b34fb'   // Serial Port Profile
                    ];
                    
                    // Intentar cada servicio hasta encontrar uno que funcione
                    for (const uuid of serviceUUIDs) {
                        try {
                            service = await server.getPrimaryService(uuid);
                            console.log(`Servicio encontrado: ${uuid}`);
                            break;
                        } catch (e) {
                            console.log(`Servicio ${uuid} no encontrado, intentando otro...`);
                        }
                    }
                    
                    if (!service) {
                        throw new Error("No se encontró un servicio de impresión compatible");
                    }
                    
                    // Buscar características de escritura
                    const characteristics = await service.getCharacteristics();
                    console.log("Características disponibles:", characteristics.length);
                    
                    let characteristic;
                    for (let char of characteristics) {
                        if (char.properties.write || char.properties.writeWithoutResponse) {
                            characteristic = char;
                            console.log("Característica de escritura encontrada");
                            break;
                        }
                    }
                    
                    if (!characteristic) {
                        throw new Error("No se encontró una característica de escritura en la impresora");
                    }
                    
                    // Generar comando para la impresora
                    const command = generateBrotherCommand(printData);
                    
                    // Enviar datos a la impresora
                    const quantity = printData.quantity;
                    
                    for (let i = 0; i < quantity; i++) {
                        showMessage(`Imprimiendo etiqueta ${i+1} de ${quantity}...`);
                        
                        // Enviar comando en chunks si es muy grande
                        const CHUNK_SIZE = 512; // Tamaño máximo de chunk
                        
                        for (let j = 0; j < command.length; j += CHUNK_SIZE) {
                            const chunk = command.slice(j, j + CHUNK_SIZE);
                            
                            if (characteristic.properties.writeWithoutResponse) {
                                await characteristic.writeValueWithoutResponse(chunk);
                            } else {
                                await characteristic.writeValue(chunk);
                            }
                            
                            // Pequeña pausa entre chunks
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                        
                        // Pausa entre etiquetas
                        if (i < quantity - 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                    
                    showMessage(`¡Impresión completada! ${quantity} etiqueta(s) enviada(s) a la impresora`);
                    
                    // Desconectar
                    device.gatt.disconnect();
                    
                    return true;
                } catch (error) {
                    console.error("Error al imprimir:", error);
                    showMessage("Error de impresión: " + error.message, true);
                    return false;
                }
            };
            
            // Imprimir directamente con Bluetooth
            const printWithBluetooth = async () => {
                if (!navigator.bluetooth) {
                    showMessage("Tu navegador no soporta Bluetooth. Intenta con Chrome en Android", true);
                    return;
                }
                
                try {
                    showMessage("Buscando tu impresora... Selecciónala cuando aparezca.");
                    
                    // Obtener dispositivo Bluetooth
                    const device = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: [
                            // Servicios genéricos
                            'generic_access',
                            'battery_service',
                            
                            // Servicios de impresora Brother conocidos
                            '000018f0-0000-1000-8000-00805f9b34fb',  // Servicio de impresión estándar
                            '1222e5db-36e1-4a53-bfef-bf7da833c5a5',  // Servicio de impresión alternativo
                            '00001101-0000-1000-8000-00805f9b34fb',  // Serial Port Profile
                            
                            // Servicios genéricos Bluetooth
                            '00001800-0000-1000-8000-00805f9b34fb',  // Servicio genérico
                            '00001801-0000-1000-8000-00805f9b34fb',  // Servicio de atributos genéricos
                            '0000180a-0000-1000-8000-00805f9b34fb',  // Información del dispositivo
                            '0000180f-0000-1000-8000-00805f9b34fb',  // Servicio de batería
                            
                            // Servicios adicionales para impresoras térmicas
                            'e7810a71-73ae-499d-8c15-faa9aef0c3f2',  // Servicio de impresión alternativo
                            'af20fbac-2518-4998-9af7-af42540731b3',  // Servicio de impresión alternativo
                            'bef8d6c9-9c21-4c9e-b632-bd58c1009f9f',  // Servicio de transferencia de datos
                            
                            // Rangos comunes para servicios Serial (SPP) en diferentes modelos
                            '0000110a-0000-1000-8000-00805f9b34fb',
                            '0000110b-0000-1000-8000-00805f9b34fb',
                            '0000110c-0000-1000-8000-00805f9b34fb',
                            '0000110d-0000-1000-8000-00805f9b34fb',
                            '0000110e-0000-1000-8000-00805f9b34fb',
                            '0000110f-0000-1000-8000-00805f9b34fb'
                        ]
                    });
                    
                    // Obtener datos para imprimir
                    const printData = getPrintData();
                    
                    // Enviar a la impresora
                    await sendToPrinter(device, printData);
                    
                } catch (error) {
                    console.error("Error en proceso de impresión:", error);
                    
                    if (error.name === 'NotFoundError') {
                        showMessage("No se encontró ningún dispositivo Bluetooth", true);
                    } else if (error.name === 'SecurityError') {
                        showMessage("No se concedieron permisos para Bluetooth", true);
                    } else if (error.message && error.message.includes("User cancelled")) {
                        showMessage("Operación cancelada por el usuario", true);
                    } else {
                        showMessage("Error: " + (error.message || "Error desconocido"), true);
                    }
                }
            };
            
            // Configurar botón para impresión directa con Bluetooth
            const bluetoothPrintBtn = document.getElementById('bluetooth-print-btn');
            if (bluetoothPrintBtn) {
                // Limpiar cualquier evento existente
                const newBluetoothBtn = bluetoothPrintBtn.cloneNode(true);
                bluetoothPrintBtn.parentNode.replaceChild(newBluetoothBtn, bluetoothPrintBtn);
                
                // Configurar evento para impresión directa con Bluetooth
                newBluetoothBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Ocultar selector de impresoras Raspberry
                    document.getElementById('raspberry-printers-container').style.display = 'none';
                    // Mostrar mensaje
                    showMessage('Conectando con impresora Bluetooth...');
                    printWithBluetooth();
                });
            }
            
            // Configurar botón para impresión con Raspberry Pi
            const raspberryPrintBtn = document.getElementById('raspberry-print-btn');
            const raspberryContainer = document.getElementById('raspberry-printers-container');
            const printerSelect = document.getElementById('raspberry-printer-select');
            
            if (raspberryPrintBtn && raspberryContainer && printerSelect) {
                // Limpiar cualquier evento existente
                const newRaspberryBtn = raspberryPrintBtn.cloneNode(true);
                raspberryPrintBtn.parentNode.replaceChild(newRaspberryBtn, raspberryPrintBtn);
                
                // Configurar evento para mostrar las opciones de Raspberry Pi
                newRaspberryBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Mostrar u ocultar el contenedor de impresoras Raspberry Pi
                    if (raspberryContainer.style.display === 'none' || !raspberryContainer.style.display) {
                        // Cargar las impresoras disponibles
                        showMessage('Cargando impresoras disponibles...');
                        // Cargar impresoras de tipo Raspberry Pi desde el servidor
                        loadRaspberryPrinters();
                        raspberryContainer.style.display = 'block';
                    } else {
                        raspberryContainer.style.display = 'none';
                    }
                });
                
                // Configurar evento para cuando se selecciona una impresora
                printerSelect.addEventListener('change', function() {
                    const selectedPrinter = this.value;
                    if (selectedPrinter) {
                        printWithRaspberryPi(parseInt(selectedPrinter));
                    }
                });
                
                // Al cargar la página, buscar automáticamente la impresora y comenzar la impresión
                // sin necesidad de selección manual
                setTimeout(() => {
                    // Buscar impresoras Raspberry Pi automáticamente
                    loadRaspberryPrinters().then(printers => {
                        if (printers && printers.length > 0) {
                            // Usar la primera impresora directamente
                            printWithRaspberryPi(parseInt(printers[0].id));
                        }
                    });
                }, 500); // Pequeño retraso para asegurar que la página esté completamente cargada
            }
            
            // Función para cargar las impresoras Raspberry Pi disponibles
            const loadRaspberryPrinters = async () => {
                try {
                    // Obtener el ID de la ubicación desde la URL
                    const locationId = {{ user.location_id|default(0) }};
                    
                    if (!locationId) {
                        throw new Error('No se pudo determinar la ubicación');
                    }
                    
                    // Hacer petición al servidor para obtener todas las impresoras disponibles
                    const response = await fetch(`/tasks/api/printers/location/${locationId}`);
                    
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Respuesta de API:', data); // Log para depuración
                    
                    // Verificar que tenemos los datos esperados
                    if (!data || !data.success) {
                        throw new Error(data.message || 'Error al obtener impresoras');
                    }
                    
                    // Asegurarnos de que printers es un array, incluso si está vacío
                    const availablePrinters = Array.isArray(data.printers) ? data.printers : [];
                    console.log('Impresoras disponibles:', availablePrinters);
                    
                    // Limpiar selector
                    const select = document.getElementById('raspberry-printer-select');
                    select.innerHTML = '<option value="">Seleccione una impresora...</option>';
                    
                    // Agregar las impresoras al selector
                    if (availablePrinters && availablePrinters.length > 0) {
                        availablePrinters.forEach(printer => {
                            const option = document.createElement('option');
                            option.value = printer.id;
                            option.textContent = printer.name;
                            select.appendChild(option);
                        });
                        showMessage(`${availablePrinters.length} impresora(s) encontrada(s)`);
                    } else {
                        showMessage('No se encontraron impresoras configuradas', true);
                    }
                    
                    return availablePrinters;
                } catch (error) {
                    console.error('Error cargando impresoras:', error);
                    showMessage(`Error: ${error.message}`, true);
                    return [];
                }
            };
            
            // Función para imprimir usando una Raspberry Pi
            const printWithRaspberryPi = async (printerId) => {
                try {
                    showMessage('Conectando con servidor de impresión Raspberry Pi...');
                    
                    // Obtener datos para la impresión
                    const printData = getPrintData();
                    
                    // Obtener la ubicación
                    const locationId = {{ user.location_id|default(0) }};
                    
                    // Obtener todas las impresoras para encontrar la seleccionada
                    const response = await fetch(`/tasks/api/printers/location/${locationId}`);
                    
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    if (!data.printers || !data.printers.length) {
                        throw new Error('No se encontraron impresoras configuradas');
                    }
                    
                    // Buscar la impresora con el ID correspondiente
                    const printer = data.printers.find(p => p.id == printerId);
                    
                    if (!printer) {
                        throw new Error('No se encontró la impresora seleccionada');
                    }
                    
                    // Aceptamos cualquier tipo de impresora para mayor compatibilidad
                    // No hacemos verificación de tipo para permitir tanto DIRECT_NETWORK como raspberry_pi
                    
                    // Construir la URL del servidor de impresión
                    const url = `http://${printer.ip_address}:${printer.port || 5000}${printer.api_path || '/print'}`;
                    
                    // Construir los datos para enviar al servidor de impresión
                    const requestData = {
                        label_data: {
                            productName: printData.productName,
                            conservationType: printData.conservationType,
                            preparedBy: printData.preparedBy,
                            startDate: printData.startDate,
                            expiryDate: printData.expiryDate,
                            secondaryExpiryDate: printData.secondaryExpiryDate,
                        },
                        printer_settings: {
                            usb_port: printer.usb_port || '/dev/usb/lp0',
                            model: printer.model || 'generic',
                            width: 35,  // 35mm de ancho
                            height: 40,  // 40mm de alto
                            quantity: printData.quantity || 1
                        }
                    };
                    
                    // Configurar opciones de la petición
                    const requestOptions = {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    };
                    
                    // Si la impresora requiere autenticación, agregar las credenciales
                    if (printer.requires_auth && printer.username) {
                        requestOptions.headers['Authorization'] = `Basic ${btoa(`${printer.username}:${printer.password || ''}`)}`;
                    }
                    
                    // Enviar la petición
                    showMessage(`Enviando etiqueta a ${printer.name}...`);
                    const printResponse = await fetch(url, requestOptions);
                    
                    if (!printResponse.ok) {
                        throw new Error(`Error ${printResponse.status}: ${printResponse.statusText}`);
                    }
                    
                    const result = await printResponse.json();
                    
                    if (result.success) {
                        showMessage(`¡Impresión completada! ${printData.quantity} etiqueta(s) enviada(s) a la impresora`);
                        return true;
                    } else {
                        throw new Error(result.message || 'Error desconocido en el servidor de impresión');
                    }
                } catch (error) {
                    console.error('Error de impresión:', error);
                    showMessage(`Error: ${error.message}`, true);
                    return false;
                }
            };
            
            // Mostrar mensaje inicial
            showMessage("Imprimiendo automáticamente...");
        });
    </script>
</body>
</html>