{% extends "tasks/portal_layout.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-tag-fill me-2"></i>Etiqueta para: {{ product.name }}</h5>
                    <a href="{{ url_for('tasks.local_user_labels') }}" class="btn btn-light btn-sm">
                        <i class="bi bi-arrow-left me-1"></i> Volver a Productos
                    </a>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="product-icon">
                            <i class="bi bi-box-seam display-4"></i>
                        </div>
                        <h4 class="mb-0">{{ product.name }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0 text-center">SELECCIONE TIPO DE CONSERVACI√ìN</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('tasks.generate_labels') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        <input type="hidden" name="quantity" value="1">
                        
                        {% if not product.conservation_types %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Este producto no tiene tipos de conservaci√≥n configurados. Por favor, contacte con un administrador.
                        </div>
                        {% else %}
                        <div class="row row-cols-1 row-cols-md-3 g-4">
                            {% for ct in product.conservation_types %}
                            <div class="col">
                                <div class="card h-100 conservation-card" onclick="document.getElementById('conservation-{{ ct.conservation_type.value }}').click()">
                                    <div class="card-body text-center py-4">
                                        {% if ct.conservation_type.value == 'descongelacion' %}
                                            <i class="bi bi-snow display-1 text-primary"></i>
                                            <h5 class="mt-3">Descongelaci√≥n</h5>
                                            <p class="text-muted small">{{ ct.hours_valid }} horas</p>
                                        {% elif ct.conservation_type.value == 'refrigeracion' %}
                                            <i class="bi bi-thermometer-snow display-1 text-info"></i>
                                            <h5 class="mt-3">Refrigeraci√≥n</h5>
                                            <p class="text-muted small">{{ ct.hours_valid }} horas</p>
                                        {% elif ct.conservation_type.value == 'gastro' %}
                                            <i class="bi bi-cup-hot display-1 text-success"></i>
                                            <h5 class="mt-3">Gastro</h5>
                                            <p class="text-muted small">{{ ct.hours_valid }} horas</p>
                                        {% elif ct.conservation_type.value == 'caliente' %}
                                            <i class="bi bi-fire display-1 text-danger"></i>
                                            <h5 class="mt-3">Caliente</h5>
                                            <p class="text-muted small">{{ ct.hours_valid }} horas</p>
                                        {% else %}
                                            <i class="bi bi-droplet display-1 text-warning"></i>
                                            <h5 class="mt-3">Seco</h5>
                                            <p class="text-muted small">{{ ct.hours_valid }} horas</p>
                                        {% endif %}
                                        
                                        <div class="form-check d-inline-block mt-2">
                                            <input class="form-check-input visually-hidden" type="radio" 
                                                name="conservation_type" 
                                                id="conservation-{{ ct.conservation_type.value }}" 
                                                value="{{ ct.conservation_type.value }}">
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent border-0 py-3">
                                        <!-- Controles de cantidad -->
                                        <div class="d-flex align-items-center justify-content-center mb-3">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="decreaseQuantity('{{ ct.conservation_type.value }}')">
                                                <i class="bi bi-dash"></i>
                                            </button>
                                            <span class="mx-3 fw-bold" id="quantity-{{ ct.conservation_type.value }}">1</span>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="increaseQuantity('{{ ct.conservation_type.value }}')">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                        <!-- Bot√≥n de imprimir -->
                                        <button type="button" onclick="printLabels('{{ product.id }}', '{{ ct.conservation_type.value }}')" class="btn btn-primary w-100">
                                            <i class="bi bi-printer me-2"></i>Imprimir
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 text-center">
            <a href="{{ url_for('tasks.local_user_labels') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Volver a la lista de productos
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Funciones para controlar la cantidad
    function increaseQuantity(conservationType) {
        const quantityElement = document.getElementById('quantity-' + conservationType);
        let currentQuantity = parseInt(quantityElement.textContent);
        if (currentQuantity < 10) { // M√°ximo 10 etiquetas
            quantityElement.textContent = currentQuantity + 1;
        }
    }
    
    function decreaseQuantity(conservationType) {
        const quantityElement = document.getElementById('quantity-' + conservationType);
        let currentQuantity = parseInt(quantityElement.textContent);
        if (currentQuantity > 1) { // M√≠nimo 1 etiqueta
            quantityElement.textContent = currentQuantity - 1;
        }
    }
    
    // Funci√≥n para imprimir etiquetas directamente
    function printLabels(productId, conservationType) {
        console.log('printLabels llamada con:', productId, conservationType);
        
        const quantityElement = document.getElementById('quantity-' + conservationType);
        const quantity = parseInt(quantityElement.textContent);
        
        console.log('Cantidad seleccionada:', quantity);
        
        // Mostrar indicador de carga
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="bi bi-arrow-clockwise spin me-2"></i>Imprimiendo...';
        button.disabled = true;
        
        // Enviar datos al servidor
        fetch('{{ url_for("tasks.generate_labels") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'csrf_token': '{{ csrf_token() }}',
                'product_id': productId,
                'conservation_type': conservationType,
                'quantity': quantity
            })
        })
        .then(response => {
            console.log('Respuesta HTTP:', response.status, response.statusText);
            return response.text();
        })
        .then(text => {
            console.log('Respuesta del servidor:', text);
            try {
                const data = JSON.parse(text);
                console.log('JSON parseado:', data);
                if (data.success && data.print_to_brother && data.label_image) {
                    console.log('‚úÖ Etiqueta generada correctamente, enviando a impresora Brother...');
                    console.log('üìè Tama√±o de imagen base64:', data.label_image.length, 'caracteres');
                    
                    // Verificar si AndroidBridge est√° disponible
                    if (typeof AndroidBridge === 'undefined') {
                        console.error('‚ùå AndroidBridge no est√° disponible');
                        showMessage('Error: Esta funci√≥n solo est√° disponible en la aplicaci√≥n Android', 'error');
                        return;
                    }
                    
                    // Verificar si el m√©todo printImage existe
                    if (typeof AndroidBridge.printImage !== 'function') {
                        console.error('‚ùå AndroidBridge.printImage no est√° disponible');
                        showMessage('Error: M√©todo de impresi√≥n no disponible', 'error');
                        return;
                    }
                    
                    console.log('üñ®Ô∏è Enviando etiqueta a la impresora Brother TD-4550DNWB...');
                    
                    // Funci√≥n para imprimir etiquetas secuencialmente con calibraci√≥n
                    const printSequentially = async () => {
                        let successCount = 0;
                        console.log(`üöÄ Iniciando impresi√≥n de ${quantity} etiquetas`);
                        
                        for (let i = 0; i < quantity; i++) {
                            console.log(`üè∑Ô∏è === PROCESANDO ETIQUETA ${i + 1} DE ${quantity} ===`);
                            
                            try {
                                // Verificar AndroidBridge antes de cada impresi√≥n
                                if (typeof AndroidBridge === 'undefined' || typeof AndroidBridge.printImage !== 'function') {
                                    console.error(`‚ùå AndroidBridge no disponible en iteraci√≥n ${i + 1}`);
                                    break;
                                }
                                
                                console.log(`üì§ Enviando imagen a impresora (iteraci√≥n ${i + 1})`);
                                
                                // Enviar imagen a la impresora
                                const result = AndroidBridge.printImage(data.label_image);
                                console.log(`üìã Resultado de printImage:`, result);
                                
                                successCount++;
                                console.log(`‚úÖ Etiqueta ${i + 1} procesada exitosamente (total: ${successCount})`);
                                
                                // Solo hacer calibraci√≥n si no es la √∫ltima etiqueta
                                if (i < quantity - 1) {
                                    console.log(`üéØ Aplicando calibraci√≥n despu√©s de etiqueta ${i + 1}`);
                                    try {
                                        if (typeof AndroidBridge.calibratePrinter === 'function') {
                                            AndroidBridge.calibratePrinter();
                                            console.log(`‚úÖ Calibraci√≥n aplicada`);
                                        } else if (typeof AndroidBridge.feedLabel === 'function') {
                                            AndroidBridge.feedLabel();
                                            console.log(`‚úÖ Feed aplicado`);
                                        }
                                    } catch (calibrationError) {
                                        console.log(`‚ö†Ô∏è Error en calibraci√≥n (continuando): ${calibrationError}`);
                                    }
                                    
                                    console.log(`‚è±Ô∏è Esperando 4 segundos antes de siguiente etiqueta...`);
                                    await new Promise(resolve => setTimeout(resolve, 4000));
                                    console.log(`‚è∞ Espera completada, continuando con etiqueta ${i + 2}`);
                                }
                                
                            } catch (printError) {
                                console.error(`‚ùå ERROR CR√çTICO en etiqueta ${i + 1}:`, printError);
                                console.error(`‚ùå Tipo de error:`, typeof printError);
                                console.error(`‚ùå Mensaje:`, printError.message || 'Sin mensaje');
                                // Intentar continuar con la siguiente
                            }
                        }
                        
                        console.log(`üèÅ === PROCESO FINALIZADO ===`);
                        console.log(`üìä Resultado: ${successCount} de ${quantity} etiquetas procesadas`);
                        return successCount;
                    };
                    
                    // Ejecutar la impresi√≥n secuencial y esperar resultado
                    printSequentially().then(successCount => {
                        console.log(`üéØ Impresi√≥n finalizada: ${successCount} de ${quantity} etiquetas procesadas`);
                        if (successCount < quantity) {
                            showMessage(`Solo se imprimieron ${successCount} de ${quantity} etiquetas solicitadas`, 'warning');
                        }
                    }).catch(error => {
                        console.error('Error en el proceso de impresi√≥n:', error);
                    });
                    
                    // Mostrar mensaje de √©xito
                    showMessage(`${quantity} etiqueta(s) enviadas a la impresora Brother TD-4550DNWB`, 'success');
                    
                    // Resetear cantidad a 1
                    quantityElement.textContent = '1';
                    
                    // Regresar a la lista de productos despu√©s de un breve delay
                    setTimeout(() => {
                        window.location.href = '{{ url_for("tasks.local_user_labels") }}';
                    }, 2000);
                    
                } else if (data.success) {
                    // Respuesta exitosa pero sin impresi√≥n Brother (fallback)
                    showMessage('Etiquetas generadas correctamente', 'success');
                    quantityElement.textContent = '1';
                    setTimeout(() => {
                        window.location.href = '{{ url_for("tasks.local_user_labels") }}';
                    }, 2000);
                } else {
                    showMessage('Error: ' + data.message, 'error');
                }
            } catch (e) {
                console.error('Error parseando JSON:', e);
                console.log('Respuesta recibida no es JSON v√°lido:', text);
                showMessage('Error: Respuesta del servidor no v√°lida', 'error');
            }
        })
        .catch(error => {
            console.error('Error en fetch:', error);
            showMessage('Error de conexi√≥n al imprimir etiquetas', 'error');
        })
        .finally(() => {
            // Restaurar bot√≥n
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    // Funci√≥n para mostrar mensajes
    function showMessage(message, type) {
        // Crear elemento de mensaje
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}-fill me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insertar al principio del contenido
        const container = document.querySelector('.container-fluid');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>

<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block styles %}
<style>
.product-icon {
    color: #6c757d;
    margin-bottom: 15px;
}

.conservation-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
}

.conservation-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.conservation-card input[type="radio"]:checked + .card {
    border-color: #0d6efd;
    box-shadow: 0 0 0 2px #0d6efd;
}
</style>
{% endblock %}