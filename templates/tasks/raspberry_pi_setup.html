{% extends 'tasks/portal_layout.html' %}

{% block title %}Configuración de Raspberry Pi para Impresión{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .step-container {
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        background-color: #f9f7f4;
        border-left: 5px solid #8D6E63;
    }
    
    .step-number {
        display: inline-block;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
        background-color: #8D6E63;
        color: white;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .code-block {
        background-color: #f1f1f1;
        border-left: 4px solid #8D6E63;
        padding: 12px;
        margin-bottom: 20px;
        font-family: monospace;
        overflow-x: auto;
    }
    
    .alert-raspberry {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    
    .highlight {
        background-color: #ffffcc;
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    .terminal-output {
        background-color: #333;
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        font-family: monospace;
    }
    
    .command-explanation {
        margin-top: 8px;
        margin-bottom: 15px;
        padding-left: 15px;
        border-left: 3px solid #ddd;
        color: #666;
    }
    
    .virtual-env-active {
        color: #27ae60;
        font-weight: bold;
    }
    
    .important-note {
        border-left: 4px solid #e67e22;
        background-color: #fff3e0;
        padding: 10px;
        margin: 15px 0;
    }
    
    .success-example {
        background-color: #e8f5e9;
        border: 1px solid #c8e6c9;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
    }
    
    .error-example {
        background-color: #ffebee;
        border: 1px solid #ffcdd2;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
    }
    
    .printer-image {
        max-width: 100%;
        height: auto;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .model-badge {
        display: inline-block;
        background-color: #8D6E63;
        color: white;
        font-weight: bold;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        margin-left: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-earth-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-raspberry-pi me-2"></i>Guía Completa de Instalación: Servidor de Impresión en Raspberry Pi para TD-4550DNWB<span class="model-badge">TD-4550DNWB</span></h5>
                    <div>
                        <a href="{{ url_for('tasks.local_user_labels') }}" class="btn btn-light btn-sm">
                            <i class="bi bi-arrow-left me-1"></i> Volver a Etiquetas
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Para principiantes:</strong> Esta guía detallada le ayudará a configurar paso a paso una Raspberry Pi como servidor de impresión para la impresora Brother TD-4550DNWB. No se requieren conocimientos previos de Linux o programación.
                    </div>
                    
                    <div class="important-note">
                        <h5><i class="bi bi-lightbulb-fill me-2"></i>¿Qué estamos construyendo?</h5>
                        <p>Vamos a convertir una Raspberry Pi en un servidor de impresión que permitirá imprimir etiquetas en su impresora Brother TD-4550DNWB desde cualquier dispositivo en la red. El servidor usa un <strong>entorno virtual de Python</strong> para mantener el sistema limpio y organizado, y utiliza los controladores oficiales de Brother para garantizar la compatibilidad.</p>
                    </div>
                    
                    <h4 class="mb-4">Guía Paso a Paso</h4>
                    
                    <!-- PASO 1: REQUISITOS PREVIOS -->
                    <div class="step-container">
                        <h5><span class="step-number">1</span> Requisitos Previos</h5>
                        <p>Antes de comenzar, reúna todos estos elementos:</p>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <ul>
                                    <li>Una Raspberry Pi (modelo 3 o superior recomendado)</li>
                                    <li>Una tarjeta microSD (mínimo 8GB)</li>
                                    <li>Una impresora Brother compatible con USB</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul>
                                    <li>Cable de alimentación para la Raspberry Pi</li>
                                    <li>Cable USB para conectar la impresora a la Raspberry Pi</li>
                                    <li>Conexión a Internet (preferiblemente por cable Ethernet)</li>
                                </ul>
                            </div>
                        </div>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>¿No tiene una Raspberry Pi?</strong> Para esta guía, necesitará una Raspberry Pi física. No se puede utilizar un emulador.
                        </div>
                    </div>
                    
                    <!-- PASO 2: INSTALAR RASPBERRY PI OS -->
                    <div class="step-container">
                        <h5><span class="step-number">2</span> Instalar Raspberry Pi OS</h5>
                        <p>Vamos a instalar el sistema operativo en la tarjeta microSD:</p>
                        <ol>
                            <li>Descargue el <a href="https://www.raspberrypi.org/software/" target="_blank">Raspberry Pi Imager</a> en su ordenador</li>
                            <li>Inserte la tarjeta microSD en su ordenador</li>
                            <li>Abra el programa Raspberry Pi Imager</li>
                            <li>Haga clic en "Elegir OS" y seleccione "Raspberry Pi OS (other)" > "Raspberry Pi OS Lite (64-bit)"</li>
                            <li>Haga clic en "Elegir almacenamiento" y seleccione su tarjeta microSD</li>
                            <li>Haga clic en el icono de engranaje (configuración avanzada) y configure lo siguiente:
                                <ul>
                                    <li>Active "Habilitar SSH"</li>
                                    <li>Establezca un nombre de usuario (ejemplo: <code>pi</code>)</li>
                                    <li>Establezca una contraseña (ejemplo: <code>raspberry</code> - ¡cámbiela más tarde por seguridad!)</li>
                                    <li>Si usará WiFi: Configure SSID y contraseña de su red WiFi</li>
                                    <li>Si lo desea, configure la zona horaria y el idioma</li>
                                </ul>
                            </li>
                            <li>Haga clic en "Guardar" para cerrar la configuración avanzada</li>
                            <li>Haga clic en "Escribir" para grabar el sistema operativo en la tarjeta</li>
                            <li>Confirme la operación cuando se le solicite</li>
                            <li>Espere a que finalice el proceso (puede tardar unos minutos)</li>
                            <li>Cuando aparezca "Escritura Completada" retire la tarjeta de forma segura</li>
                        </ol>
                        <div class="success-example">
                            <p><i class="bi bi-check-circle-fill me-2"></i><strong>Su tarjeta microSD ahora contiene:</strong></p>
                            <ul>
                                <li>Raspberry Pi OS Lite (sistema sin interfaz gráfica)</li>
                                <li>SSH habilitado para conectarse remotamente</li>
                                <li>Usuario y contraseña configurados</li>
                                <li>Configuración WiFi (si la agregó)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- PASO 3: CONFIGURACIÓN BÁSICA -->
                    <div class="step-container">
                        <h5><span class="step-number">3</span> Configuración Básica</h5>
                        <p>Vamos a poner en marcha su Raspberry Pi:</p>
                        <ol>
                            <li>Inserte la tarjeta microSD en la ranura de la Raspberry Pi</li>
                            <li>Conecte la impresora Brother al puerto USB de la Raspberry Pi</li>
                            <li>Conecte la Raspberry Pi a su router mediante cable Ethernet (recomendado) o vía WiFi (si lo configuró)</li>
                            <li>Conecte el cable de alimentación a la Raspberry Pi</li>
                            <li>El LED de alimentación de la Raspberry Pi se encenderá, y el LED de actividad parpadeará durante el arranque</li>
                            <li>Espere aproximadamente 2 minutos para que el sistema arranque completamente</li>
                        </ol>
                        <div class="important-note">
                            <p><i class="bi bi-info-circle-fill me-2"></i>La Raspberry Pi no tiene pantalla ni teclado en esta configuración. Accederemos a ella remotamente a través de la red en el siguiente paso.</p>
                        </div>
                    </div>
                    
                    <!-- PASO 4: ACCEDER A LA RASPBERRY PI -->
                    <div class="step-container">
                        <h5><span class="step-number">4</span> Acceder a la Raspberry Pi</h5>
                        <p>Ahora vamos a conectarnos a la Raspberry Pi a través de SSH:</p>
                        
                        <h6 class="mt-3 mb-2">Encontrar la dirección IP de la Raspberry Pi:</h6>
                        <ul>
                            <li><strong>Opción 1:</strong> Acceda a su router (típicamente en 192.168.1.1 o 192.168.0.1) y busque la lista de dispositivos conectados. Busque "raspberrypi" en la lista.</li>
                            <li><strong>Opción 2:</strong> Use un escáner de red como "Advanced IP Scanner" en Windows o "Angry IP Scanner" (multiplataforma) para encontrar todos los dispositivos en su red.</li>
                            <li><strong>Opción 3:</strong> Si configuró el "hostname" en la instalación, puede intentar conectarse usando: <code>raspberrypi.local</code></li>
                        </ul>
                        <div class="alert alert-raspberry">
                            <strong>Nota:</strong> Necesitará saber la dirección IP de su Raspberry Pi para continuar. Típicamente será algo como <code>192.168.1.X</code> donde X es un número entre 2 y 254.
                        </div>
                        
                        <h6 class="mt-4 mb-2">Conectarse a la Raspberry Pi:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>En Windows:</strong></p>
                                <p>Opción 1 - Usando PowerShell o CMD:</p>
                                <div class="code-block">
                                    ssh pi@192.168.1.X
                                </div>
                                <p>Opción 2 - Usando PuTTY:</p>
                                <ol>
                                    <li>Descargue e instale <a href="https://www.putty.org/" target="_blank">PuTTY</a></li>
                                    <li>En "Host Name" escriba la IP de su Raspberry Pi</li>
                                    <li>El puerto debe ser 22</li>
                                    <li>Haga clic en "Open"</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <p><strong>En macOS o Linux:</strong></p>
                                <p>Abra Terminal y escriba:</p>
                                <div class="code-block">
                                    ssh pi@192.168.1.X
                                </div>
                                <p>Reemplace "192.168.1.X" con la dirección IP real de su Raspberry Pi.</p>
                            </div>
                        </div>
                        
                        <p class="mt-3">Al conectarse por primera vez, verá una advertencia sobre la autenticidad del host. Escriba "yes" para continuar.</p>
                        <p>Cuando se le solicite, introduzca la contraseña que configuró durante la instalación (por defecto es "raspberry" si no la cambió).</p>
                        
                        <div class="terminal-output">
                            $ ssh pi@192.168.1.123<br>
                            The authenticity of host '192.168.1.123 (192.168.1.123)' can't be established.<br>
                            ECDSA key fingerprint is SHA256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.<br>
                            Are you sure you want to continue connecting (yes/no/[fingerprint])? <strong>yes</strong><br>
                            Warning: Permanently added '192.168.1.123' (ECDSA) to the list of known hosts.<br>
                            pi@192.168.1.123's password: <strong>[Escriba su contraseña aquí]</strong><br>
                            <br>
                            Linux raspberrypi 6.1.0-rpi7-rpi-v8 #1 SMP PREEMPT Debian 1:6.1.54-1+rpt2 (2023-10-05) aarch64<br>
                            <br>
                            The programs included with the Debian GNU/Linux system are free software;<br>
                            the exact distribution terms for each program are described in the<br>
                            individual files in /usr/share/doc/*/copyright.<br>
                            <br>
                            Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent<br>
                            permitted by applicable law.<br>
                            <br>
                            pi@raspberrypi:~ $
                        </div>
                        
                        <p class="mt-3">Si ve un prompt similar a <code>pi@raspberrypi:~ $</code>, ¡felicidades! Ya está conectado a su Raspberry Pi.</p>
                    </div>
                    
                    <!-- PASO 5: ACTUALIZAR EL SISTEMA -->
                    <div class="step-container">
                        <h5><span class="step-number">5</span> Actualizar el Sistema</h5>
                        <p>Antes de instalar cualquier software, actualice el sistema operativo:</p>
                        
                        <div class="code-block">
                            sudo apt update
                        </div>
                        <div class="command-explanation">
                            Este comando actualiza la lista de paquetes disponibles. <code>sudo</code> otorga privilegios de administrador.
                        </div>
                        
                        <div class="code-block">
                            sudo apt upgrade -y
                        </div>
                        <div class="command-explanation">
                            Este comando instala las actualizaciones disponibles. La opción <code>-y</code> responde "sí" automáticamente a las preguntas.
                        </div>
                        
                        <p>La actualización puede tardar varios minutos. Tenga paciencia mientras se descargan e instalan los paquetes.</p>
                        <p>Cuando termine, verá de nuevo el prompt <code>pi@raspberrypi:~ $</code>.</p>
                    </div>
                    
                    <!-- PASO 6: INSTALAR DEPENDENCIAS -->
                    <div class="step-container">
                        <h5><span class="step-number">6</span> Instalar Dependencias</h5>
                        <p>Ahora instalaremos los programas necesarios para el servidor de impresión:</p>
                        
                        <div class="code-block">
                            sudo apt install -y python3 python3-pip python3-venv nginx cups libusb-1.0-0-dev cups-pdf build-essential libcups2-dev
                        </div>
                        <div class="command-explanation">
                            <strong>¿Qué estamos instalando?</strong><br>
                            • <code>python3</code>: El lenguaje de programación que usaremos<br>
                            • <code>python3-pip</code>: Gestor de paquetes para instalar bibliotecas de Python<br>
                            • <code>python3-venv</code>: Herramienta para crear entornos virtuales<br>
                            • <code>nginx</code>: Servidor web (opcional, para futuras expansiones)<br>
                            • <code>cups</code> y <code>cups-pdf</code>: Sistema de impresión para Linux<br>
                            • <code>libusb-1.0-0-dev</code>: Biblioteca para acceder a dispositivos USB<br>
                            • <code>build-essential</code>: Herramientas para compilar software<br>
                            • <code>libcups2-dev</code>: Biblioteca de desarrollo para CUPS
                        </div>
                        
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <strong>¿Qué es un entorno virtual de Python?</strong><br>
                            Un entorno virtual es como un "contenedor" aislado donde instalaremos las bibliotecas de Python para nuestro servidor de impresión. Esto evita conflictos con otras aplicaciones y mantiene el sistema operativo limpio y organizado. Piense en ello como una habitación separada donde guardaremos nuestras herramientas específicas.
                        </div>
                    </div>
                    
                    <!-- PASO 7: INSTALAR CONTROLADORES DE BROTHER -->
                    <div class="step-container">
                        <h5><span class="step-number">7</span> Instalar Controladores de Brother para TD-4550DNWB</h5>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <img src="https://support.brother.com/g/b/img/product/td4550dnwbxl/td4550dnwbxl_main.jpg" alt="Brother TD-4550DNWB" class="printer-image">
                            </div>
                            <div class="col-md-8">
                                <p>La impresora Brother TD-4550DNWB es una impresora de etiquetas profesional con múltiples opciones de conectividad. Para este modelo específico, necesitamos instalar los controladores oficiales de Brother en lugar de usar la biblioteca brother_ql, ya que este modelo no está soportado por esa biblioteca.</p>
                                
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <strong>Importante:</strong> Los controladores oficiales de Brother proporcionarán mejor compatibilidad y acceso a todas las funciones de la impresora TD-4550DNWB.
                                </div>
                            </div>
                        </div>
                        
                        <p>Primero, descargamos los controladores de CUPS para Brother:</p>
                        
                        <div class="code-block">
                            cd ~
                            wget https://download.brother.com/welcome/dlf103945/td4550dnwbcupswrapper-1.0.0-0.armhf.deb
                            wget https://download.brother.com/welcome/dlf103946/td4550dnwblpr-1.0.0-0.armhf.deb
                        </div>
                        <div class="command-explanation">
                            Descarga los paquetes de controladores oficiales de Brother para la impresora TD-4550DNWB. Incluyen los archivos LPR (sistema de impresión) y el wrapper de CUPS (para integración con el sistema de impresión de Linux).
                        </div>
                        
                        <p>Ahora instalamos los controladores:</p>
                        
                        <div class="code-block">
                            sudo dpkg -i --force-all td4550dnwblpr-1.0.0-0.armhf.deb
                            sudo dpkg -i --force-all td4550dnwbcupswrapper-1.0.0-0.armhf.deb
                        </div>
                        <div class="command-explanation">
                            Instala los paquetes de controladores. Usamos <code>--force-all</code> para superar posibles problemas de dependencias en Raspberry Pi OS.
                        </div>
                        
                        <p>Verificamos que CUPS esté ejecutándose correctamente:</p>
                        
                        <div class="code-block">
                            sudo systemctl status cups
                        </div>
                        <div class="terminal-output">
                            ● cups.service - CUPS Scheduler
                                Loaded: loaded (/lib/systemd/system/cups.service; enabled; vendor preset: enabled)
                                Active: active (running) since Wed 2025-05-07 14:35:12 BST; 2min 24s ago
                            Main PID: 1234 (cupsd)
                                Tasks: 1 (limit: 4915)
                                CGroup: /system.slice/cups.service
                                        └─1234 /usr/sbin/cupsd -l
                        </div>
                        
                        <p>Si CUPS no está ejecutándose, iniciamos el servicio:</p>
                        
                        <div class="code-block">
                            sudo systemctl start cups
                            sudo systemctl enable cups
                        </div>
                        
                        <p class="mt-3">Verificamos que la impresora esté conectada y sea reconocida:</p>
                        
                        <div class="code-block">
                            lsusb | grep Brother
                        </div>
                        <div class="terminal-output">
                            Bus 001 Device 004: ID 04f9:2098 Brother Industries, Ltd TD-4550DNWB
                        </div>
                        
                        <p>Ahora configuramos la impresora en CUPS:</p>
                        
                        <div class="code-block">
                            sudo lpadmin -p TD-4550DNWB -E -v usb://Brother/TD-4550DNWB -m TD-4550DNWB.ppd
                        </div>
                        <div class="command-explanation">
                            Este comando configura la impresora en el sistema CUPS:<br>
                            • <code>-p TD-4550DNWB</code>: Nombre de la impresora<br>
                            • <code>-E</code>: Habilita la impresora<br>
                            • <code>-v usb://Brother/TD-4550DNWB</code>: Ruta USB de la impresora<br>
                            • <code>-m TD-4550DNWB.ppd</code>: Archivo de definición de la impresora
                        </div>
                    </div>
                    
                    <!-- PASO 8: VERIFICAR CONEXIÓN DE IMPRESORA -->
                    <div class="step-container">
                        <h5><span class="step-number">8</span> Verificar la Conexión de la Impresora</h5>
                        
                        <p>Comprobemos que la Raspberry Pi detecta la impresora TD-4550DNWB:</p>
                        <div class="code-block">
                            lsusb | grep Brother
                        </div>
                        <div class="terminal-output">
                            Bus 001 Device 004: ID 04f9:2098 Brother Industries, Ltd TD-4550DNWB
                        </div>
                        <div class="command-explanation">
                            Este comando muestra los dispositivos USB de Brother conectados. Debería ver la impresora TD-4550DNWB en la lista.
                        </div>
                        
                        <p>Ahora verificamos que CUPS reconoce la impresora:</p>
                        <div class="code-block">
                            lpstat -p -d
                        </div>
                        <div class="terminal-output">
                            printer TD-4550DNWB is idle. enabled since Wed May 7 14:35:12 2025
                        </div>
                        <div class="command-explanation">
                            Muestra las impresoras configuradas y su estado. Debería ver la TD-4550DNWB en estado "idle" (inactiva) y "enabled" (habilitada).
                        </div>
                        
                        <p>Comprobamos que el servicio de impresión está funcionando correctamente:</p>
                        <div class="code-block">
                            sudo systemctl status cups
                        </div>
                        <div class="terminal-output">
                            ● cups.service - CUPS Scheduler
                               Loaded: loaded (/lib/systemd/system/cups.service; enabled; vendor preset: enabled)
                               Active: active (running) since Wed 2025-05-07 14:35:12 BST; 20min ago
                             Main PID: 1234 (cupsd)
                                Tasks: 1 (limit: 4915)
                                  CPU: 345ms
                               CGroup: /system.slice/cups.service
                                       └─1234 /usr/sbin/cupsd -l
                        </div>
                        
                        <p>Realizamos una impresión de prueba para verificar que todo funciona correctamente:</p>
                        <div class="code-block">
                            echo "Prueba de impresión TD-4550DNWB" > ~/test-print.txt
                            lp -d TD-4550DNWB ~/test-print.txt
                        </div>
                        <div class="terminal-output">
                            request id is TD-4550DNWB-1 (1 file(s))
                        </div>
                        <div class="command-explanation">
                            Crea un archivo de texto simple y lo envía a la impresora. Si todo está configurado correctamente, la impresora debería imprimir el texto.
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <strong>Solución de problemas:</strong> Si la impresora no imprime correctamente:
                            <ul>
                                <li>Verifique que la impresora está encendida y con papel</li>
                                <li>Compruebe los permisos del dispositivo USB con <code>ls -la /dev/usb/lp0</code></li>
                                <li>Asegúrese de que su usuario está en el grupo "lp" con <code>sudo usermod -a -G lp pi</code></li>
                                <li>Reinicie CUPS con <code>sudo systemctl restart cups</code></li>
                                <li>Verifique los logs con <code>sudo journalctl -u cups</code></li>
                            </ul>
                        </div>
                        
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>¡Excelente!</strong> Si la impresora ha impreso la prueba, significa que los controladores están instalados correctamente y CUPS está configurado para trabajar con su impresora Brother TD-4550DNWB.
                        </div>
                    </div>
                    
                    <!-- PASO 9: CREAR Y ACTIVAR ENTORNO VIRTUAL -->
                    <div class="step-container">
                        <h5><span class="step-number">9</span> Crear y Activar el Entorno Virtual</h5>
                        
                        <p>Vamos a crear un directorio para nuestro proyecto y configurar un entorno virtual de Python:</p>
                        
                        <div class="code-block">
                            mkdir -p ~/printer_server
                        </div>
                        <div class="command-explanation">
                            Crea un directorio llamado <code>printer_server</code> en la carpeta personal. La opción <code>-p</code> crea directorios intermedios si es necesario.
                        </div>
                        
                        <div class="code-block">
                            cd ~/printer_server
                        </div>
                        <div class="command-explanation">
                            Cambia al directorio recién creado. <code>~</code> es un atajo a su carpeta personal.
                        </div>
                        
                        <div class="code-block">
                            python3 -m venv env
                        </div>
                        <div class="command-explanation">
                            Crea un entorno virtual llamado <code>env</code>. Este comando puede tardar unos segundos en completarse.
                        </div>
                        
                        <h6 class="mt-4 mb-2"><i class="bi bi-stars me-2"></i>Activar el Entorno Virtual</h6>
                        <p>Este paso es <strong>CRÍTICO</strong>. Debe activar el entorno virtual antes de instalar bibliotecas o ejecutar scripts:</p>
                        
                        <div class="code-block">
                            source env/bin/activate
                        </div>
                        <div class="command-explanation">
                            Activa el entorno virtual. Notará que el prompt cambia para mostrar <code>(env)</code> al principio, indicando que el entorno virtual está activo.
                        </div>
                        
                        <div class="terminal-output">
                            pi@raspberrypi:~/printer_server $ source env/bin/activate<br>
                            <span class="virtual-env-active">(env)</span> pi@raspberrypi:~/printer_server $
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>¡Muy importante!</strong> Siempre que vea <span class="virtual-env-active">(env)</span> al principio del prompt, significa que su entorno virtual está activado. Si cierra la terminal o se desconecta, necesitará activarlo nuevamente con <code>source env/bin/activate</code> cuando vuelva a conectarse.
                        </div>
                        
                        <h6 class="mt-4 mb-2">Instalar Bibliotecas en el Entorno Virtual</h6>
                        <p>Ahora que el entorno virtual está activo, vamos a instalar las bibliotecas necesarias <strong>dentro</strong> del entorno:</p>
                        
                        <div class="code-block">
                            pip install flask gunicorn brother_ql
                        </div>
                        <div class="command-explanation">
                            Instala tres bibliotecas dentro del entorno virtual:<br>
                            • <code>flask</code>: Un marco web para crear la API<br>
                            • <code>gunicorn</code>: Un servidor web para Python<br>
                            • <code>brother_ql</code>: La biblioteca para manejar impresoras Brother
                        </div>
                        <div class="terminal-output">
                            Collecting flask<br>
                            ...<br>
                            Collecting gunicorn<br>
                            ...<br>
                            Collecting brother_ql<br>
                            ...<br>
                            Successfully installed Flask-2.2.3 Jinja2-3.1.2 MarkupSafe-2.1.2 Werkzeug-2.2.3 brother-ql-0.9.4 click-8.1.3 gunicorn-20.1.0 itsdangerous-2.1.2 pillow-9.4.0
                        </div>
                        
                        <p class="mt-3">Note que usamos <code>pip</code> en lugar de <code>pip3</code> porque dentro del entorno virtual, <code>pip</code> ya está configurado para usar Python 3.</p>
                    </div>
                    
                    <!-- PASO 10: CREAR SERVIDOR DE IMPRESIÓN -->
                    <div class="step-container">
                        <h5><span class="step-number">10</span> Crear el Servidor de Impresión</h5>
                        
                        <p>Ahora vamos a crear el archivo del servidor que procesará las peticiones de impresión:</p>
                        
                        <div class="code-block">
                            nano ~/printer_server/app.py
                        </div>
                        <div class="command-explanation">
                            Abre el editor de texto <code>nano</code> para crear un archivo llamado <code>app.py</code>
                        </div>
                        
                        <p>Copie y pegue el siguiente código (puede usar Ctrl+Shift+V para pegar en la terminal):</p>
                        
                        <div class="code-block">
import os
from flask import Flask, request, jsonify
import subprocess
import logging
from logging.handlers import RotatingFileHandler
import tempfile
import base64
import cups

app = Flask(__name__)

# Configuración de logging
if not os.path.exists('logs'):
    os.mkdir('logs')
file_handler = RotatingFileHandler('logs/printer_server.log', maxBytes=10240, backupCount=10)
file_handler.setFormatter(logging.Formatter(
    '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'
))
file_handler.setLevel(logging.INFO)
app.logger.addHandler(file_handler)
app.logger.setLevel(logging.INFO)
app.logger.info('Servidor de impresión TD-4550DNWB iniciado')

# Nombre de la impresora CUPS
PRINTER_NAME = "TD-4550DNWB"

@app.route('/status', methods=['GET'])
def status_check():
    """Verificar estado del servidor y la impresora TD-4550DNWB"""
    try:
        # Conectar con CUPS para verificar estado de la impresora
        conn = cups.Connection()
        printers = conn.getPrinters()
        
        if PRINTER_NAME in printers:
            printer_info = printers[PRINTER_NAME]
            printer_state = printer_info['printer-state']
            state_message = "ready"
            
            if printer_state == 3:
                state_message = "idle"
            elif printer_state == 4:
                state_message = "processing"
            elif printer_state == 5:
                state_message = "stopped"
                
            return jsonify({
                'success': True,
                'status': 'online',
                'printer_status': state_message,
                'printer_info': printer_info
            })
        else:
            return jsonify({
                'success': True,
                'status': 'online',
                'printer_status': 'not_found',
                'message': f'Impresora {PRINTER_NAME} no encontrada en CUPS'
            })
    except Exception as e:
        app.logger.error(f'Error al verificar estado de la impresora: {str(e)}')
        return jsonify({
            'success': True,
            'status': 'online',
            'printer_status': 'error',
            'error': str(e)
        })

@app.route('/health', methods=['GET'])
def health_check():
    """Endpoint simple para verificar que el servidor esté funcionando"""
    return jsonify({'status': 'online'})

@app.route('/print', methods=['POST'])
def print_label():
    """Endpoint principal para imprimir etiquetas en TD-4550DNWB usando CUPS"""
    data = request.json
    content = data.get('content')
    
    if not content:
        return jsonify({'success': False, 'message': 'No se proporcionó contenido para imprimir'})
    
    try:
        # Crear archivo temporal con la imagen base64
        with tempfile.NamedTemporaryFile(delete=False, suffix='.png') as temp:
            temp_filename = temp.name
            try:
                # Decodificar la imagen base64
                imgdata = base64.b64decode(content.split(',')[1] if ',' in content else content)
                temp.write(imgdata)
                temp.flush()
                
                app.logger.info(f'Archivo temporal creado: {temp_filename}')
                
                # Conectar con CUPS e imprimir
                conn = cups.Connection()
                
                # Verificar que la impresora existe
                printers = conn.getPrinters()
                if PRINTER_NAME not in printers:
                    app.logger.error(f'Impresora {PRINTER_NAME} no encontrada')
                    return jsonify({'success': False, 'message': f'Impresora {PRINTER_NAME} no encontrada'})
                
                # Opciones de impresión para TD-4550DNWB
                options = {
                    "media": "Custom.102x152mm",  # Ajustar según el tamaño de etiqueta que use
                    "BrRollWidth": "102",        # Ancho del rollo en mm
                    "BrLabelLength": "152",      # Longitud de la etiqueta en mm
                    "fit-to-page": "true"
                }
                
                # Enviar trabajo de impresión a CUPS
                job_id = conn.printFile(PRINTER_NAME, temp_filename, "Etiqueta desde API", options)
                
                if job_id > 0:
                    app.logger.info(f'Impresión exitosa: Job ID {job_id}')
                    return jsonify({
                        'success': True, 
                        'message': 'Etiqueta enviada a la impresora correctamente',
                        'job_id': job_id
                    })
                else:
                    app.logger.error('Error al enviar trabajo de impresión a CUPS')
                    return jsonify({'success': False, 'message': 'Error al enviar trabajo de impresión'})
                
            except Exception as e:
                app.logger.error(f'Error al procesar la imagen: {str(e)}')
                return jsonify({'success': False, 'message': f'Error al procesar la imagen: {str(e)}'})
            finally:
                # Limpiar archivo temporal
                try:
                    os.unlink(temp_filename)
                except:
                    pass
    except Exception as e:
        app.logger.error(f'Error en el servidor: {str(e)}')
        return jsonify({'success': False, 'message': f'Error en el servidor: {str(e)}'})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
                        </div>
                        
                        <p>Para guardar el archivo:</p>
                        <ol>
                            <li>Presione <strong>Ctrl+O</strong> para guardar ("WriteOut")</li>
                            <li>Presione <strong>Enter</strong> para confirmar el nombre del archivo</li>
                            <li>Presione <strong>Ctrl+X</strong> para salir del editor</li>
                        </ol>
                        
                        <h6 class="mt-4 mb-2">Probar el Servidor Manualmente</h6>
                        
                        <p>Antes de configurar el servicio, probemos que el servidor funciona correctamente:</p>
                        <div class="code-block">
                            # Primero, instalar la biblioteca de CUPS para Python
                            pip install pycups
                            
                            # Asegúrese de que el entorno virtual esté activado - debe ver (env) al inicio del prompt
                            # Si no lo ve, ejecute: source env/bin/activate
                            
                            python app.py
                        </div>
                        <div class="terminal-output">
                            <span class="virtual-env-active">(env)</span> pi@raspberrypi:~/printer_server $ pip install pycups<br>
                            Collecting pycups<br>
                            &nbsp;&nbsp;Downloading pycups-2.0.1.tar.gz (52 kB)<br>
                            &nbsp;&nbsp;&nbsp;&nbsp;━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 52.4/52.4 kB 1.2 MB/s eta 0:00:00<br>
                            Building wheels for collected packages: pycups<br>
                            &nbsp;&nbsp;Building wheel for pycups (setup.py) ... done<br>
                            Successfully installed pycups-2.0.1<br>
                            <span class="virtual-env-active">(env)</span> pi@raspberrypi:~/printer_server $ python app.py<br>
                            * Serving Flask app 'app'<br>
                            * Debug mode: off<br>
                            WARNING: This is a development server. Do not use it in a production deployment.<br>
                            * Running on all addresses (0.0.0.0)<br>
                            * Running on http://127.0.0.1:5000<br>
                            * Running on http://192.168.1.123:5000<br>
                            Press CTRL+C to quit
                        </div>
                        
                        <p>En otra terminal, pruebe que el servidor responde correctamente:</p>
                        <div class="code-block">
                            # Abra una nueva terminal y conéctese a su Raspberry Pi
                            ssh pi@192.168.1.X
                            
                            # Pruebe la conexión con el servidor
                            curl http://localhost:5000/health
                        </div>
                        <div class="terminal-output">
                            {"status":"online"}
                        </div>
                        
                        <p>Verifique el estado de la impresora a través del servidor:</p>
                        <div class="code-block">
                            curl http://localhost:5000/status
                        </div>
                        <div class="terminal-output">
                            {"printer_info":{"device-uri":"usb://Brother/TD-4550DNWB","printer-info":"Brother TD-4550DNWB","printer-is-accepting-jobs":true,"printer-is-shared":true,"printer-make-and-model":"Brother TD-4550DNWB","printer-state":3,"printer-state-message":"","printer-state-reasons":["none"],"printer-type":10522636,"printer-uri-supported":"ipp://localhost:631/printers/TD-4550DNWB"},"printer_status":"idle","status":"online","success":true}
                        </div>
                        
                        <p>Una vez que haya verificado que funciona, detenga el servidor temporal presionando <strong>Ctrl+C</strong> en la terminal donde lo ejecutó. Continuaremos configurando el servicio permanente.</p>
                    </div>
                    
                    <!-- PASO 11: CONFIGURAR SERVICIO SYSTEMD -->
                    <div class="step-container">
                        <h5><span class="step-number">11</span> Configurar el Servicio Systemd</h5>
                        
                        <p>Ahora configuraremos el sistema para que el servidor se inicie automáticamente cuando arranque la Raspberry Pi:</p>
                        
                        <div class="code-block">
                            sudo nano /etc/systemd/system/printer-server.service
                        </div>
                        
                        <p>Copie y pegue el siguiente contenido (ajuste el nombre de usuario si es diferente a 'pi'):</p>
                        
                        <div class="code-block">
[Unit]
Description=Servidor de impresión Brother
After=network.target

[Service]
User=pi
WorkingDirectory=/home/pi/printer_server
Environment="PATH=/home/pi/printer_server/env/bin"
ExecStart=/home/pi/printer_server/env/bin/gunicorn --bind 0.0.0.0:5000 app:app
Restart=always

[Install]
WantedBy=multi-user.target
                        </div>
                        
                        <div class="command-explanation">
                            Este archivo configura un servicio del sistema que:<br>
                            • Se ejecutará como el usuario 'pi'<br>
                            • Usará el entorno virtual creado anteriormente<br>
                            • Iniciará automáticamente el servidor al arrancar<br>
                            • Se reiniciará automáticamente si falla
                        </div>
                        
                        <p>Guarde el archivo (Ctrl+O, Enter, Ctrl+X) y luego active el servicio:</p>
                        
                        <div class="code-block">
                            sudo systemctl enable printer-server.service
                        </div>
                        <div class="terminal-output">
                            Created symlink /etc/systemd/system/multi-user.target.wants/printer-server.service → /etc/systemd/system/printer-server.service.
                        </div>
                        
                        <div class="code-block">
                            sudo systemctl start printer-server.service
                        </div>
                        
                        <div class="code-block">
                            sudo systemctl status printer-server.service
                        </div>
                        <div class="terminal-output">
                            ● printer-server.service - Servidor de impresión Brother<br>
                               Loaded: loaded (/etc/systemd/system/printer-server.service; enabled; vendor preset: enabled)<br>
                               Active: active (running) since Wed 2025-05-07 15:25:34 BST; 5s ago<br>
                             Main PID: 12345 (gunicorn)<br>
                                Tasks: 2 (limit: 4915)<br>
                                  CPU: 1.028s<br>
                               CGroup: /system.slice/printer-server.service<br>
                                       ├─12345 /home/pi/printer_server/env/bin/python /home/pi/printer_server/env/bin/gunicorn --bind 0.0.0.0:5000 app:app<br>
                                       └─12346 /home/pi/printer_server/env/bin/python /home/pi/printer_server/env/bin/gunicorn --bind 0.0.0.0:5000 app:app<br>
                            <br>
                            May 07 15:25:34 raspberrypi systemd[1]: Started Servidor de impresión Brother.<br>
                            May 07 15:25:34 raspberrypi gunicorn[12345]: [2025-05-07 15:25:34 +0000] [12345] [INFO] Starting gunicorn 20.1.0<br>
                            May 07 15:25:34 raspberrypi gunicorn[12345]: [2025-05-07 15:25:34 +0000] [12345] [INFO] Listening at: http://0.0.0.0:5000 (12345)<br>
                            May 07 15:25:34 raspberrypi gunicorn[12345]: [2025-05-07 15:25:34 +0000] [12345] [INFO] Using worker: sync<br>
                            May 07 15:25:34 raspberrypi gunicorn[12345]: [2025-05-07 15:25:34 +0000] [12346] [INFO] Booting worker with pid: 12346
                        </div>
                        
                        <p>Presione <strong>Q</strong> para salir de la vista de estado.</p>
                        
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>¡Felicidades!</strong> Su servidor de impresión ya está funcionando como un servicio del sistema y se iniciará automáticamente cada vez que arranque la Raspberry Pi.
                        </div>
                        
                        <h6 class="mt-4 mb-2">Verificar que el Servicio Funciona</h6>
                        <div class="code-block">
                            curl http://localhost:5000/health
                        </div>
                        <div class="terminal-output">
                            {"status":"online"}
                        </div>
                        
                        <div class="code-block">
                            curl http://localhost:5000/status
                        </div>
                        <div class="terminal-output">
                            {"printer_info":{"device-uri":"usb://Brother/TD-4550DNWB","printer-info":"Brother TD-4550DNWB","printer-is-accepting-jobs":true,"printer-is-shared":true,"printer-make-and-model":"Brother TD-4550DNWB","printer-state":3,"printer-state-message":"","printer-state-reasons":["none"],"printer-type":10522636,"printer-uri-supported":"ipp://localhost:631/printers/TD-4550DNWB"},"printer_status":"idle","status":"online","success":true}
                        </div>
                    </div>
                    
                    <!-- PASO 12: CONFIGURAR EN LA APLICACIÓN WEB -->
                    <div class="step-container">
                        <h5><span class="step-number">12</span> Configurar en la Aplicación Web</h5>
                        
                        <p>Ahora que el servidor está funcionando, necesitamos configurarlo en la aplicación web:</p>
                        
                        <h6 class="mt-3 mb-2">Información Necesaria:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-earth-medium text-white">
                                        Configuración del Servidor
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Dirección IP:</strong> 
                                            <span>IP de su Raspberry Pi (ej: 192.168.1.X)</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Puerto:</strong> 
                                            <span>5000</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Ruta API:</strong> 
                                            <span>/print</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-earth-medium text-white">
                                        Configuración de la Impresora TD-4550DNWB
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Modelo:</strong> 
                                            <span>TD-4550DNWB</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Puerto USB:</strong> 
                                            <span>/dev/usb/lp0</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Tipo de Impresora:</strong> 
                                            <span>RASPBERRY_PI</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Importante:</strong> Para que el servidor sea accesible desde otros dispositivos de forma permanente, configure una IP estática o una reserva DHCP en su router para la Raspberry Pi.
                        </div>
                        
                        <h6 class="mt-4 mb-2">Configurar una IP Estática (Recomendado)</h6>
                        <p>Para evitar que la dirección IP cambie después de reiniciar:</p>
                        
                        <div class="code-block">
                            sudo nano /etc/dhcpcd.conf
                        </div>
                        
                        <p>Añada estas líneas al final del archivo (ajuste las direcciones según su red):</p>
                        
                        <div class="code-block">
# Configuración de IP estática para eth0 (cable)
interface eth0
static ip_address=192.168.1.200/24
static routers=192.168.1.1
static domain_name_servers=192.168.1.1

# Configuración de IP estática para wlan0 (WiFi)
interface wlan0
static ip_address=192.168.1.200/24
static routers=192.168.1.1
static domain_name_servers=192.168.1.1
                        </div>
                        
                        <p>Guarde el archivo (Ctrl+O, Enter, Ctrl+X) y reinicie la Raspberry Pi:</p>
                        
                        <div class="code-block">
                            sudo reboot
                        </div>
                        
                        <p>Después de reiniciar, su Raspberry Pi siempre tendrá la misma dirección IP (192.168.1.200 en este ejemplo).</p>
                    </div>
                    
                    <!-- PASO 13: SOLUCIÓN DE PROBLEMAS -->
                    <div class="step-container">
                        <h5><span class="step-number">13</span> Solución de Problemas</h5>
                        
                        <p>Si encuentra problemas con la impresión, aquí tiene algunas formas de diagnosticarlos:</p>
                        
                        <div class="accordion" id="troubleshootingAccordion">
                            <!-- Problema 1 -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problemOne" aria-expanded="false" aria-controls="problemOne">
                                        <i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i> El servidor no responde
                                    </button>
                                </h2>
                                <div id="problemOne" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                    <div class="accordion-body">
                                        <ol>
                                            <li>Verifique el estado del servicio:
                                                <div class="code-block">
                                                    sudo systemctl status printer-server.service
                                                </div>
                                            </li>
                                            <li>Revise los logs del sistema:
                                                <div class="code-block">
                                                    sudo journalctl -u printer-server.service -f
                                                </div>
                                            </li>
                                            <li>Reinicie el servicio:
                                                <div class="code-block">
                                                    sudo systemctl restart printer-server.service
                                                </div>
                                            </li>
                                            <li>Verifique la conectividad de red:
                                                <div class="code-block">
                                                    ip addr show
                                                </div>
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Problema 2 -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problemTwo" aria-expanded="false" aria-controls="problemTwo">
                                        <i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i> La impresora no imprime
                                    </button>
                                </h2>
                                <div id="problemTwo" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                    <div class="accordion-body">
                                        <ol>
                                            <li>Verifique que la impresora esté conectada y encendida</li>
                                            <li>Compruebe la detección de la impresora:
                                                <div class="code-block">
                                                    lsusb
                                                    ls -la /dev/usb/
                                                </div>
                                            </li>
                                            <li>Verifique la configuración de CUPS:
                                                <div class="code-block">
                                                    lpstat -p -d
                                                </div>
                                            </li>
                                            <li>Verifique permisos del dispositivo USB:
                                                <div class="code-block">
                                                    sudo chmod 666 /dev/usb/lp0
                                                </div>
                                            </li>
                                            <li>Compruebe si puede imprimir directamente a través de CUPS:
                                                <div class="code-block">
                                                    echo "Test TD-4550DNWB" > test.txt<br>
                                                    lp -d TD-4550DNWB test.txt
                                                </div>
                                            </li>
                                            <li>Verifique el estado de los trabajos de impresión:
                                                <div class="code-block">
                                                    lpq -a
                                                </div>
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Problema 3 -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problemThree" aria-expanded="false" aria-controls="problemThree">
                                        <i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i> Errores de entorno virtual
                                    </button>
                                </h2>
                                <div id="problemThree" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                    <div class="accordion-body">
                                        <p>Si el servicio falla por problemas con el entorno virtual:</p>
                                        <ol>
                                            <li>Verifique la configuración del servicio:
                                                <div class="code-block">
                                                    sudo cat /etc/systemd/system/printer-server.service
                                                </div>
                                                Asegúrese de que las rutas al entorno virtual sean correctas.
                                            </li>
                                            <li>Recree el entorno virtual si es necesario:
                                                <div class="code-block">
                                                    cd ~/printer_server<br>
                                                    rm -rf env<br>
                                                    python3 -m venv env<br>
                                                    source env/bin/activate<br>
                                                    pip install flask gunicorn brother_ql
                                                </div>
                                            </li>
                                            <li>Recargue la configuración del servicio:
                                                <div class="code-block">
                                                    sudo systemctl daemon-reload<br>
                                                    sudo systemctl restart printer-server.service
                                                </div>
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Problema 4 -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problemFour" aria-expanded="false" aria-controls="problemFour">
                                        <i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i> Logs y diagnóstico
                                    </button>
                                </h2>
                                <div id="problemFour" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                    <div class="accordion-body">
                                        <p>Revise los diferentes logs para diagnosticar problemas:</p>
                                        <ol>
                                            <li>Logs del servicio del sistema:
                                                <div class="code-block">
                                                    sudo journalctl -u printer-server.service -f
                                                </div>
                                            </li>
                                            <li>Logs de la aplicación:
                                                <div class="code-block">
                                                    cat ~/printer_server/logs/printer_server.log
                                                </div>
                                            </li>
                                            <li>Pruebe el endpoint de estado:
                                                <div class="code-block">
                                                    curl http://localhost:5000/status
                                                </div>
                                            </li>
                                            <li>Verifique la conectividad desde otro dispositivo:
                                                <div class="code-block">
                                                    # Desde otro computador en la misma red
                                                    curl http://192.168.1.X:5000/health
                                                </div>
                                                Reemplace 192.168.1.X con la IP de su Raspberry Pi.
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-4">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            <strong>Recordatorio sobre entornos virtuales:</strong> 
                            <p>Si necesita realizar pruebas manuales, recuerde siempre activar primero el entorno virtual:</p>
                            <div class="code-block">
                                cd ~/printer_server<br>
                                source env/bin/activate
                            </div>
                            <p>Verá <code>(env)</code> al principio del prompt cuando el entorno virtual esté activado.</p>
                        </div>
                    </div>
                    
                    <!-- PASO 14: MANTENIMIENTO -->
                    <div class="step-container">
                        <h5><span class="step-number">14</span> Mantenimiento</h5>
                        
                        <p>Para mantener su servidor de impresión en buen estado, realice estas tareas periódicamente:</p>
                        
                        <div class="accordion" id="maintenanceAccordion">
                            <!-- Tarea 1 -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#maintenanceOne" aria-expanded="false" aria-controls="maintenanceOne">
                                        <i class="bi bi-arrow-repeat me-2 text-primary"></i> Actualizar el sistema (mensualmente)
                                    </button>
                                </h2>
                                <div id="maintenanceOne" class="accordion-collapse collapse" data-bs-parent="#maintenanceAccordion">
                                    <div class="accordion-body">
                                        <p>Mantenga el sistema operativo actualizado:</p>
                                        <div class="code-block">
                                            sudo apt update<br>
                                            sudo apt upgrade -y
                                        </div>
                                        <p>Después de actualizaciones importantes, reinicie el sistema:</p>
                                        <div class="code-block">
                                            sudo reboot
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tarea 2 -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#maintenanceTwo" aria-expanded="false" aria-controls="maintenanceTwo">
                                        <i class="bi bi-arrow-repeat me-2 text-primary"></i> Actualizar bibliotecas (trimestralmente)
                                    </button>
                                </h2>
                                <div id="maintenanceTwo" class="accordion-collapse collapse" data-bs-parent="#maintenanceAccordion">
                                    <div class="accordion-body">
                                        <p>Actualice las bibliotecas Python en el entorno virtual:</p>
                                        <div class="code-block">
                                            cd ~/printer_server<br>
                                            source env/bin/activate<br>
                                            pip install --upgrade flask gunicorn pycups
                                        </div>
                                        <p>Reinicie el servicio después de actualizar las bibliotecas:</p>
                                        <div class="code-block">
                                            sudo systemctl restart printer-server.service
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tarea 3 -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#maintenanceThree" aria-expanded="false" aria-controls="maintenanceThree">
                                        <i class="bi bi-arrow-repeat me-2 text-primary"></i> Gestión de logs (según necesidad)
                                    </button>
                                </h2>
                                <div id="maintenanceThree" class="accordion-collapse collapse" data-bs-parent="#maintenanceAccordion">
                                    <div class="accordion-body">
                                        <p>Si los logs ocupan demasiado espacio, puede limpiarlos:</p>
                                        <div class="code-block">
                                            cd ~/printer_server<br>
                                            rm -f logs/printer_server.log.*<br>
                                            truncate -s 0 logs/printer_server.log
                                        </div>
                                        <p>Para ver el tamaño actual de los logs:</p>
                                        <div class="code-block">
                                            du -sh ~/printer_server/logs/
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tarea 4 -->
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#maintenanceFour" aria-expanded="false" aria-controls="maintenanceFour">
                                        <i class="bi bi-arrow-repeat me-2 text-primary"></i> Copias de seguridad (antes de cambios importantes)
                                    </button>
                                </h2>
                                <div id="maintenanceFour" class="accordion-collapse collapse" data-bs-parent="#maintenanceAccordion">
                                    <div class="accordion-body">
                                        <p>Realice una copia de seguridad de la configuración:</p>
                                        <div class="code-block">
                                            cd ~<br>
                                            tar -czvf printer_server_backup.tar.gz printer_server/app.py /etc/systemd/system/printer-server.service
                                        </div>
                                        <p>Puede copiar este archivo a su ordenador mediante SCP:</p>
                                        <div class="code-block">
                                            # Ejecute este comando DESDE su ordenador, no en la Raspberry Pi
                                            scp pi@192.168.1.X:~/printer_server_backup.tar.gz .
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-success mt-4">
                            <i class="bi bi-lightbulb-fill me-2"></i>
                            <strong>Consejo:</strong> Guarde una copia de esta guía y del código del servidor en un lugar seguro. Si alguna vez necesita reinstalar la Raspberry Pi, le facilitará la configuración.
                        </div>
                    </div>
                    
                    <!-- RESUMEN -->
                    <div class="step-container">
                        <h5><i class="bi bi-check-circle-fill me-2 text-success"></i>¡Felicidades!</h5>
                        <p>Ha completado con éxito la configuración de su servidor de impresión Raspberry Pi. Ahora puede imprimir etiquetas desde cualquier dispositivo en su red local.</p>
                        
                        <div class="card mb-4">
                            <div class="card-header bg-earth-dark text-white">
                                Resumen de la Configuración
                            </div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <strong>URL del servidor:</strong> http://192.168.1.X:5000/print
                                </li>
                                <li class="list-group-item">
                                    <strong>Endpoint de estado:</strong> http://192.168.1.X:5000/status
                                </li>
                                <li class="list-group-item">
                                    <strong>Modelo de impresora:</strong> TD-4550DNWB
                                </li>
                                <li class="list-group-item">
                                    <strong>Puerto USB:</strong> /dev/usb/lp0
                                </li>
                                <li class="list-group-item">
                                    <strong>Servicio del sistema:</strong> printer-server.service
                                </li>
                            </ul>
                        </div>
                        
                        <p>Ahora puede configurar esta impresora en la aplicación web siguiendo el paso 12.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Script para hacer que los acordeones funcionen
document.addEventListener('DOMContentLoaded', function() {
    // Obtener todos los botones del acordeón
    var accordionButtons = document.querySelectorAll('.accordion-button');
    
    // Añadir event listeners a cada botón
    accordionButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            // Obtener el ID del contenido a mostrar/ocultar
            var targetId = this.getAttribute('data-bs-target').substring(1);
            var targetElement = document.getElementById(targetId);
            
            // Alternar la clase 'show' para mostrar/ocultar el contenido
            if (targetElement.classList.contains('show')) {
                targetElement.classList.remove('show');
                this.classList.add('collapsed');
                this.setAttribute('aria-expanded', 'false');
            } else {
                // Cerrar todos los demás paneles primero
                var parentId = targetElement.getAttribute('data-bs-parent');
                if (parentId) {
                    var parentElement = document.querySelector(parentId);
                    var openPanels = parentElement.querySelectorAll('.accordion-collapse.show');
                    openPanels.forEach(function(panel) {
                        panel.classList.remove('show');
                        var panelButton = document.querySelector('[data-bs-target="#' + panel.id + '"]');
                        if (panelButton) {
                            panelButton.classList.add('collapsed');
                            panelButton.setAttribute('aria-expanded', 'false');
                        }
                    });
                }
                
                // Abrir el panel seleccionado
                targetElement.classList.add('show');
                this.classList.remove('collapsed');
                this.setAttribute('aria-expanded', 'true');
            }
        });
    });
});
</script>
{% endblock %}
