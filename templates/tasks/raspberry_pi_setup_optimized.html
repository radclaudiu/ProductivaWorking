{% extends 'tasks/portal_layout.html' %}

{% block title %}Configuración de Raspberry Pi para Impresión{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .step-container {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        background-color: #f9f7f4;
        border-left: 5px solid #8D6E63;
    }
    
    .step-number {
        display: inline-block;
        width: 28px;
        height: 28px;
        line-height: 28px;
        text-align: center;
        background-color: #8D6E63;
        color: white;
        border-radius: 50%;
        margin-right: 10px;
    }
    
    .code-block {
        position: relative;
        background-color: #f1f1f1;
        border-left: 4px solid #8D6E63;
    }
    
    .code-command {
        display: block;
        padding: 2px 0;
        white-space: pre;
        line-height: 1.5;
    }
    
    .copy-button {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 3px 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 10;
    }
    
    .copy-button:hover {
        background-color: #8D6E63;
        color: white;
        border-color: #8D6E63;
    }
    
    .copy-success {
        background-color: #28a745 !important;
        color: white !important;
        border-color: #28a745 !important;
    }
    
    .code-block {
        padding: 10px;
        margin-bottom: 15px;
        font-family: monospace;
        overflow-x: auto;
        font-size: 0.9rem;
        position: relative;
    }
    
    .code-command {
        display: block;
        padding: 5px 8px;
        margin-bottom: 5px;
        background-color: #f8f8f8;
        border-radius: 4px;
        border-left: 3px solid #8D6E63;
    }
    
    .copy-button {
        position: absolute;
        right: 5px;
        top: 5px;
        background-color: #8D6E63;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 3px 8px;
        font-size: 0.8rem;
        cursor: pointer;
    }
    
    .copy-code-btn {
        background-color: #8D6E63;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 3px 8px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-left: 8px;
        vertical-align: middle;
    }
    
    .alert-raspberry {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
    
    .highlight {
        background-color: #ffffcc;
        padding: 2px 4px;
        border-radius: 3px;
    }
    
    .important-note {
        border-left: 4px solid #e67e22;
        background-color: #fff3e0;
        padding: 10px;
        margin: 15px 0;
    }
    
    .printer-image {
        max-width: 100%;
        height: auto;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .model-badge {
        display: inline-block;
        background-color: #8D6E63;
        color: white;
        font-weight: bold;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        margin-left: 10px;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Función para copiar texto al portapapeles
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        
        // Configurar los botones de copia
        document.querySelectorAll('.copy-code-btn').forEach(button => {
            button.addEventListener('click', function() {
                const command = this.getAttribute('data-command');
                copyToClipboard(command);
                
                // Cambiar texto del botón temporalmente
                const originalText = this.textContent;
                this.textContent = '¡Copiado!';
                
                setTimeout(() => {
                    this.textContent = originalText;
                }, 1500);
            });
        });
        
        // Configurar los botones de copia de bloques
        document.querySelectorAll('.copy-button').forEach(button => {
            button.addEventListener('click', function() {
                const codeBlock = this.parentElement;
                const commands = [];
                codeBlock.querySelectorAll('.code-command').forEach(cmd => {
                    const cmdText = cmd.textContent.trim();
                    // No incluir líneas vacías o comentarios que empiezan con #
                    if (cmdText !== '' && !cmdText.startsWith('#')) {
                        commands.push(cmdText);
                    }
                });
                copyToClipboard(commands.join('\n'));
                
                // Cambiar texto del botón temporalmente
                const originalText = this.textContent;
                this.textContent = '✓ ¡Copiado!';
                this.classList.add('copy-success');
                
                setTimeout(() => {
                    this.textContent = originalText;
                    this.classList.remove('copy-success');
                }, 2000);
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-earth-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-raspberry-pi me-2"></i>Guía de Instalación: Servidor para Brother TD-4550DNWB<span class="model-badge">TD-4550DNWB</span></h5>
                    <div>
                        <a href="{{ url_for('tasks.local_user_labels') }}" class="btn btn-light btn-sm">
                            <i class="bi bi-arrow-left me-1"></i> Volver a Etiquetas
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>Guía concisa:</strong> Configuración de Raspberry Pi como servidor de impresión para la impresora Brother TD-4550DNWB, que requiere controladores oficiales de Brother.
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <img src="https://support.brother.com/g/b/img/product/td4550dnwbxl/td4550dnwbxl_main.jpg" alt="Brother TD-4550DNWB" class="printer-image">
                        </div>
                        <div class="col-md-8">
                            <div class="important-note">
                                <h5><i class="bi bi-lightbulb-fill me-2"></i>¿Qué estamos construyendo?</h5>
                                <p>Un servidor de impresión en Raspberry Pi que permitirá imprimir etiquetas en la impresora Brother TD-4550DNWB desde cualquier dispositivo en la red. Usaremos los controladores oficiales de Brother junto con CUPS (Sistema de impresión para Linux) y una API web simple.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PASO 1: REQUISITOS PREVIOS -->
                    <div class="step-container">
                        <h5><span class="step-number">1</span> Requisitos</h5>
                        <ul class="mb-0">
                            <li>Raspberry Pi (modelo 3 o superior)</li>
                            <li>Tarjeta microSD (mínimo 8GB)</li>
                            <li>Impresora Brother TD-4550DNWB</li>
                            <li>Cable USB para conectar la impresora a la Raspberry Pi</li>
                        </ul>
                    </div>
                    
                    <!-- PASO 2: INSTALAR RASPBERRY PI OS -->
                    <div class="step-container">
                        <h5><span class="step-number">2</span> Instalar Raspberry Pi OS</h5>
                        <ol class="mb-0">
                            <li>Descargue e instale <a href="https://www.raspberrypi.org/software/" target="_blank">Raspberry Pi Imager</a></li>
                            <li>Seleccione "Raspberry Pi OS Lite (64-bit)"</li>
                            <li>Configure SSH, nombre de usuario/contraseña y opcionalmente WiFi</li>
                            <li>Escriba la imagen en la tarjeta microSD</li>
                            <li>Arranque la Raspberry Pi con la tarjeta</li>
                        </ol>
                    </div>
                    
                    <!-- PASO 3: ACCEDER Y ACTUALIZAR -->
                    <div class="step-container">
                        <h5><span class="step-number">3</span> Acceder y Actualizar</h5>
                        <p>Conéctese a la Raspberry Pi vía SSH (reemplace con su IP):</p>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">ssh pi@192.168.1.X</div>
                        </div>
                        
                        <p>Actualice el sistema:</p>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">sudo apt update</div>
                            <div class="code-command">sudo apt upgrade -y</div>
                        </div>
                    </div>
                    
                    <!-- PASO 4: INSTALAR DEPENDENCIAS -->
                    <div class="step-container">
                        <h5><span class="step-number">4</span> Instalar Dependencias</h5>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">sudo apt install -y python3 python3-pip python3-venv nginx cups libusb-1.0-0-dev cups-pdf build-essential libcups2-dev</div>
                        </div>
                    </div>
                    
                    <!-- PASO 5: INSTALAR CONTROLADORES DE BROTHER -->
                    <div class="step-container">
                        <h5><span class="step-number">5</span> Instalar Controladores de Brother para TD-4550DNWB</h5>
                        <p>Visite el <a href="https://support.brother.com/g/b/downloadlist.aspx?c=es&lang=es&prod=lptd4550dnwbeuk&os=130&flang=English#SelectLanguageType-593_0_1" target="_blank">sitio web oficial de Brother</a> para descargar los controladores más recientes.</p>
                        <div class="important-note">
                            <p><strong>Importante:</strong> Si los enlaces directos no funcionan, descargue manualmente los archivos <code>LPR driver</code> y <code>CUPSwrapper driver</code> de la sección "Linux" en el sitio web de Brother.</p>
                            <p><strong>Instrucciones oficiales de Brother:</strong></p>
                            <ol>
                                <li>Descargue los drivers</li>
                                <li>Inicie sesión como superusuario (o use "sudo")</li>
                                <li>Encienda la impresora y conecte el cable USB</li>
                                <li><strong>Importante:</strong> Cierre el asistente de instalación si aparece</li>
                                <li>Abra la terminal y vaya al directorio donde está el driver</li>
                                <li>Instale el driver con <code>dpkg -i --force-all (nombre-del-driver)</code></li>
                                <li>Verifique si el driver está instalado con <code>dpkg -l | grep Brother</code></li>
                            </ol>
                        </div>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">cd ~</div>
                            <div class="code-command"># Método 1: Usar el navegador web para descargar desde el sitio oficial de Brother</div>
                            <div class="code-command"># y transferir los archivos .deb a la Raspberry Pi usando SCP</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Método 2: Alternativa - usar curl para descargar directamente</div>
                            <div class="code-command">sudo apt-get install -y curl</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Descargar controladores (enlaces pueden cambiar, verificar en el sitio oficial)</div>
                            <div class="code-command">curl -L -O "https://download.brother.com/welcome/dlf103945/td4550dnwbcupswrapper-1.0.0-0.armhf.deb"</div>
                            <div class="code-command">curl -L -O "https://download.brother.com/welcome/dlf103946/td4550dnwblpr-1.0.0-0.armhf.deb"</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Verificar si los archivos se descargaron correctamente</div>
                            <div class="code-command">ls -la *.deb</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Si el tamaño de los archivos es muy pequeño (menos de 1MB), la descarga falló</div>
                            <div class="code-command"># En ese caso, descargue manualmente los archivos del sitio web de Brother</div>
                            <div class="code-command"># y transfiéralos usando SCP o un dispositivo USB</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Instalar (si descargó los archivos manualmente, asegúrese de que los nombres coincidan)</div>
                            <div class="code-command">sudo dpkg -i --force-all td4550dnwblpr-*.deb</div>
                            <div class="code-command">sudo dpkg -i --force-all td4550dnwbcupswrapper-*.deb</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Si hay errores de dependencias, ejecutar:</div>
                            <div class="code-command">sudo apt-get -f install -y</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Comprobar que CUPS esté funcionando</div>
                            <div class="code-command">sudo systemctl status cups</div>
                            <div class="code-command"># Si no está activo, ejecutar:</div>
                            <div class="code-command">sudo systemctl start cups</div>
                            <div class="code-command">sudo systemctl enable cups</div>
                        </div>
                    </div>
                    
                    <!-- PASO 6: VERIFICAR Y CONFIGURAR IMPRESORA -->
                    <div class="step-container">
                        <h5><span class="step-number">6</span> Verificar y Configurar Impresora</h5>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command"># Verificar que la impresora está conectada</div>
                            <div class="code-command">lsusb | grep Brother</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Configurar la impresora en CUPS</div>
                            <div class="code-command">sudo lpadmin -p TD-4550DNWB -E -v usb://Brother/TD-4550DNWB -m TD-4550DNWB.ppd</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Comprobar la configuración</div>
                            <div class="code-command">lpstat -p -d</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Realizar una impresión de prueba</div>
                            <div class="code-command">echo "Prueba de impresión TD-4550DNWB" > ~/test-print.txt</div>
                            <div class="code-command">lp -d TD-4550DNWB ~/test-print.txt</div>
                        </div>
                    </div>
                    
                    <!-- PASO 7: CREAR SERVIDOR DE IMPRESIÓN -->
                    <div class="step-container">
                        <h5><span class="step-number">7</span> Crear Servidor de Impresión</h5>
                        <p>1. Crear directorio y entorno virtual:</p>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">mkdir -p ~/printer_server</div>
                            <div class="code-command">cd ~/printer_server</div>
                            <div class="code-command">python3 -m venv env</div>
                            <div class="code-command">source env/bin/activate</div>
                            <div class="code-command">pip install flask gunicorn pycups</div>
                        </div>
                        
                        <p>2. Crear archivo de la aplicación:</p>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">nano ~/printer_server/app.py</div>
                        </div>
                        
                        <p>3. Copie este código en el archivo:</p>
                        <div class="code-block">
import os
from flask import Flask, request, jsonify
import subprocess
import logging
from logging.handlers import RotatingFileHandler
import tempfile
import base64
import cups

app = Flask(__name__)

# Configuración de logging
if not os.path.exists('logs'):
    os.mkdir('logs')
file_handler = RotatingFileHandler('logs/printer_server.log', maxBytes=10240, backupCount=10)
file_handler.setFormatter(logging.Formatter(
    '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'
))
file_handler.setLevel(logging.INFO)
app.logger.addHandler(file_handler)
app.logger.setLevel(logging.INFO)
app.logger.info('Servidor de impresión TD-4550DNWB iniciado')

# Nombre de la impresora CUPS
PRINTER_NAME = "TD-4550DNWB"

@app.route('/status', methods=['GET'])
def status_check():
    """Verificar estado del servidor y la impresora TD-4550DNWB"""
    try:
        # Conectar con CUPS para verificar estado de la impresora
        conn = cups.Connection()
        printers = conn.getPrinters()
        
        if PRINTER_NAME in printers:
            printer_info = printers[PRINTER_NAME]
            printer_state = printer_info['printer-state']
            state_message = "ready"
            
            if printer_state == 3:
                state_message = "idle"
            elif printer_state == 4:
                state_message = "processing"
            elif printer_state == 5:
                state_message = "stopped"
                
            return jsonify({
                'success': True,
                'status': 'online',
                'printer_status': state_message,
                'printer_info': printer_info
            })
        else:
            return jsonify({
                'success': True,
                'status': 'online',
                'printer_status': 'not_found',
                'message': f'Impresora {PRINTER_NAME} no encontrada en CUPS'
            })
    except Exception as e:
        app.logger.error(f'Error al verificar estado de la impresora: {str(e)}')
        return jsonify({
            'success': True,
            'status': 'online',
            'printer_status': 'error',
            'error': str(e)
        })

@app.route('/health', methods=['GET'])
def health_check():
    """Endpoint simple para verificar que el servidor esté funcionando"""
    return jsonify({'status': 'online'})

@app.route('/print', methods=['POST'])
def print_label():
    """Endpoint principal para imprimir etiquetas en TD-4550DNWB usando CUPS"""
    data = request.json
    content = data.get('content')
    
    if not content:
        return jsonify({'success': False, 'message': 'No se proporcionó contenido para imprimir'})
    
    try:
        # Crear archivo temporal con la imagen base64
        with tempfile.NamedTemporaryFile(delete=False, suffix='.png') as temp:
            temp_filename = temp.name
            try:
                # Decodificar la imagen base64
                imgdata = base64.b64decode(content.split(',')[1] if ',' in content else content)
                temp.write(imgdata)
                temp.flush()
                
                app.logger.info(f'Archivo temporal creado: {temp_filename}')
                
                # Conectar con CUPS e imprimir
                conn = cups.Connection()
                
                # Verificar que la impresora existe
                printers = conn.getPrinters()
                if PRINTER_NAME not in printers:
                    app.logger.error(f'Impresora {PRINTER_NAME} no encontrada')
                    return jsonify({'success': False, 'message': f'Impresora {PRINTER_NAME} no encontrada'})
                
                # Opciones de impresión para TD-4550DNWB
                options = {
                    "media": "Custom.102x152mm",  # Ajustar según el tamaño de etiqueta que use
                    "BrRollWidth": "102",        # Ancho del rollo en mm
                    "BrLabelLength": "152",      # Longitud de la etiqueta en mm
                    "fit-to-page": "true"
                }
                
                # Enviar trabajo de impresión a CUPS
                job_id = conn.printFile(PRINTER_NAME, temp_filename, "Etiqueta desde API", options)
                
                if job_id > 0:
                    app.logger.info(f'Impresión exitosa: Job ID {job_id}')
                    return jsonify({
                        'success': True, 
                        'message': 'Etiqueta enviada a la impresora correctamente',
                        'job_id': job_id
                    })
                else:
                    app.logger.error('Error al enviar trabajo de impresión a CUPS')
                    return jsonify({'success': False, 'message': 'Error al enviar trabajo de impresión'})
                
            except Exception as e:
                app.logger.error(f'Error al procesar la imagen: {str(e)}')
                return jsonify({'success': False, 'message': f'Error al procesar la imagen: {str(e)}'})
            finally:
                # Limpiar archivo temporal
                try:
                    os.unlink(temp_filename)
                except:
                    pass
    except Exception as e:
        app.logger.error(f'Error en el servidor: {str(e)}')
        return jsonify({'success': False, 'message': f'Error en el servidor: {str(e)}'})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
                        </div>
                        
                        <p>4. Guarde el archivo (Ctrl+O, Enter, Ctrl+X) y pruebe el servidor:</p>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command"># Asegúrese de estar en el entorno virtual (env)</div>
                            <div class="code-command">python app.py</div>
                            <div class="code-command"></div>
                            <div class="code-command"># En otra terminal, pruebe la conexión</div>
                            <div class="code-command">curl http://localhost:5000/health</div>
                            <div class="code-command">curl http://localhost:5000/status</div>
                        </div>
                    </div>
                    
                    <!-- PASO 8: CONFIGURAR SERVICIO SYSTEMD -->
                    <div class="step-container">
                        <h5><span class="step-number">8</span> Configurar Servicio Systemd</h5>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">sudo nano /etc/systemd/system/printer-server.service</div>
                        </div>
                        
                        <p>Copie este contenido (ajuste el nombre de usuario si no es 'pi'):</p>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">[Unit]</div>
                            <div class="code-command">Description=Servidor de impresión Brother TD-4550DNWB</div>
                            <div class="code-command">After=network.target</div>
                            <div class="code-command"></div>
                            <div class="code-command">[Service]</div>
                            <div class="code-command">User=pi</div>
                            <div class="code-command">WorkingDirectory=/home/pi/printer_server</div>
                            <div class="code-command">Environment="PATH=/home/pi/printer_server/env/bin"</div>
                            <div class="code-command">ExecStart=/home/pi/printer_server/env/bin/gunicorn --bind 0.0.0.0:5000 app:app</div>
                            <div class="code-command">Restart=always</div>
                            <div class="code-command"></div>
                            <div class="code-command">[Install]</div>
                            <div class="code-command">WantedBy=multi-user.target</div>
                        </div>
                        
                        <p>Active e inicie el servicio:</p>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">sudo systemctl enable printer-server.service</div>
                            <div class="code-command">sudo systemctl start printer-server.service</div>
                            <div class="code-command">sudo systemctl status printer-server.service</div>
                        </div>
                    </div>
                    
                    <!-- PASO 9: CONFIGURAR IP ESTÁTICA -->
                    <div class="step-container">
                        <h5><span class="step-number">9</span> Configurar IP Estática</h5>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">sudo nano /etc/dhcpcd.conf</div>
                        </div>
                        
                        <p>Añada estas líneas al final (ajuste según su red):</p>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command"># Configuración de IP estática para eth0 (cable)</div>
                            <div class="code-command">interface eth0</div>
                            <div class="code-command">static ip_address=192.168.1.200/24</div>
                            <div class="code-command">static routers=192.168.1.1</div>
                            <div class="code-command">static domain_name_servers=192.168.1.1</div>
                            <div class="code-command"></div>
                            <div class="code-command"># Configuración de IP estática para wlan0 (WiFi)</div>
                            <div class="code-command">interface wlan0</div>
                            <div class="code-command">static ip_address=192.168.1.200/24</div>
                            <div class="code-command">static routers=192.168.1.1</div>
                            <div class="code-command">static domain_name_servers=192.168.1.1</div>
                        </div>
                        
                        <p>Reinicie para aplicar la configuración:</p>
                        <div class="code-block">
                            <button class="copy-button">Copiar todo</button>
                            <div class="code-command">sudo reboot</div>
                        </div>
                    </div>
                    
                    <!-- RESUMEN -->
                    <div class="step-container">
                        <h5><i class="bi bi-check-circle-fill me-2 text-success"></i>Configuración Completa</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-earth-medium text-white">
                                        Configuración del Servidor
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Dirección IP:</strong> 
                                            <span>192.168.1.200 (o la que configuró)</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Puerto:</strong> 
                                            <span>5000</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Ruta API:</strong> 
                                            <span>/print</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-earth-medium text-white">
                                        Configuración de la Impresora TD-4550DNWB
                                    </div>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Modelo:</strong> 
                                            <span>TD-4550DNWB</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Tipo de Impresora:</strong> 
                                            <span>RASPBERRY_PI</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SOLUCIÓN DE PROBLEMAS -->
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i> 
                        <strong>¿Problemas con la instalación?</strong> <a href="#troubleshooting" class="alert-link">Consulte la sección de solución de problemas</a>
                    </div>
                    
                    <div id="troubleshooting" class="step-container">
                        <h4 class="mb-3"><i class="bi bi-tools me-2"></i>Solución de Problemas Comunes</h4>
                        
                        <div class="card mb-4">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">Error: "No es un archivo en formato Debian"</h5>
                            </div>
                            <div class="card-body">
                                <p>Este error ocurre cuando el archivo .deb descargado está dañado o incompleto. Las instrucciones oficiales de Brother indican:</p>
                                
                                <ol>
                                    <li>Descargar el driver directamente del <a href="https://support.brother.com/g/b/downloadlist.aspx?c=es&lang=es&prod=lptd4550dnwbeuk&os=130&flang=English#SelectLanguageType-593_0_1" target="_blank">sitio web oficial de Brother</a></li>
                                    <li>Verificar que el archivo descargado tiene un tamaño apropiado (varios MB, no KB)</li>
                                    <li>Cerrar cualquier asistente de instalación que aparezca automáticamente</li>
                                    <li>Usar el comando exacto <code>dpkg -i --force-all (nombre-del-driver)</code></li>
                                </ol>
                                
                                <p><strong>Solución 1:</strong> Verificar el archivo descargado</p>
                                <div class="code-block">
                                    <button class="copy-button">Copiar todo</button>
                                    <div class="code-command">ls -la *.deb</div>
                                </div>
                                
                                <p><strong>Solución 2:</strong> Si el archivo es muy pequeño (menos de 1MB), está dañado. Descargue desde el navegador en su PC y transfiera a la Raspberry Pi:</p>
                                <div class="code-block">
                                    <button class="copy-button">Copiar todo</button>
                                    <div class="code-command"># En su PC, use SCP para transferir los archivos a la Raspberry Pi</div>
                                    <div class="code-command"># Reemplace "pi" y "192.168.1.X" con sus datos</div>
                                    <div class="code-command">scp ruta_al_archivo/td4550dnwblpr-*.deb pi@192.168.1.X:~</div>
                                    <div class="code-command">scp ruta_al_archivo/td4550dnwbcupswrapper-*.deb pi@192.168.1.X:~</div>
                                </div>
                                
                                <p><strong>Solución 3:</strong> Instale las dependencias necesarias antes de intentar instalar los drivers:</p>
                                <div class="code-block">
                                    <button class="copy-button">Copiar todo</button>
                                    <div class="code-command">sudo apt update</div>
                                    <div class="code-command">sudo apt install -y cups libcups2-dev libc6-dev</div>
                                </div>
                                
                                <p><strong>Solución 4:</strong> Use el flag <code>--force-all</code> como indican las instrucciones oficiales:</p>
                                <div class="code-block">
                                    <button class="copy-button">Copiar todo</button>
                                    <div class="code-command">sudo dpkg -i --force-all td4550dnwblpr-*.deb</div>
                                    <div class="code-command">sudo dpkg -i --force-all td4550dnwbcupswrapper-*.deb</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RESUMEN -->
                    <div class="step-container">
                        <h5><i class="bi bi-check-circle-fill me-2 text-success"></i>Configuración Completa</h5>
                        <a href="#" id="showTroubleshooting" class="alert-link">Haga clic aquí para ver soluciones</a>
                    </div>
                    <div class="accordion" id="troubleshootingAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#problemHelp" aria-expanded="false" aria-controls="problemHelp" id="troubleshootingButton">
                                    <i class="bi bi-question-circle-fill me-2 text-primary"></i> Solución de Problemas
                                </button>
                            </h2>
                            <div id="problemHelp" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                                <div class="accordion-body">
                                    <p><strong>Error en .deb: "No es un archivo en formato Debian"</strong></p>
                                    <p>Si recibe el error: <code>dpkg-deb: error: 'td4550dnwblpr-*.deb' is not a Debian format archive</code>, es porque el archivo está dañado o no se descargó correctamente. Solución:</p>
                                    
                                    <div class="code-block">
                                        <button class="copy-button">Copiar todo</button>
                                        <div class="code-command"># Eliminar archivos dañados</div>
                                        <div class="code-command">rm -f td4550dnwb*.deb</div>
                                        <div class="code-command"></div>
                                        <div class="code-command"># Descargar directamente del sitio de Brother</div>
                                        <div class="code-command">wget "https://download.brother.com/welcome/dlf103945/td4550dnwbcupswrapper-1.0.0-0.armhf.deb"</div>
                                        <div class="code-command">wget "https://download.brother.com/welcome/dlf103946/td4550dnwblpr-1.0.0-0.armhf.deb"</div>
                                        <div class="code-command"></div>
                                        <div class="code-command"># Verificar tamaño (debe ser mayor a 5KB)</div>
                                        <div class="code-command">ls -lh *.deb</div>
                                    </div>
                                    
                                    <p>Si sigue sin funcionar, descargue manualmente desde <a href="https://support.brother.com/g/b/downloadlist.aspx?c=us&lang=en&prod=td4550dnwb_us_eu_as&os=128" target="_blank">el sitio oficial</a> y transfiéralos a la Raspberry Pi con un dispositivo USB o usando SCP.</p>
                                    
                                    <p><strong>Verificar estado del servidor:</strong></p>
                                    <div class="code-block">
                                        <button class="copy-button">Copiar todo</button>
                                        <div class="code-command">sudo systemctl status printer-server.service</div>
                                        <div class="code-command">sudo journalctl -u printer-server.service -f</div>
                                    </div>
                                    
                                    <p><strong>Reiniciar servicios:</strong></p>
                                    <div class="code-block">
                                        <button class="copy-button">Copiar todo</button>
                                        <div class="code-command">sudo systemctl restart cups</div>
                                        <div class="code-command">sudo systemctl restart printer-server.service</div>
                                    </div>
                                    
                                    <p><strong>Verificar impresora:</strong></p>
                                    <div class="code-block">
                                        <button class="copy-button">Copiar todo</button>
                                        <div class="code-command">lsusb | grep Brother</div>
                                        <div class="code-command">lpstat -p -d</div>
                                        <div class="code-command">lpq -a</div>
                                    </div>
                                    
                                    <p><strong>Probar impresión directa:</strong></p>
                                    <div class="code-block">
                                        <button class="copy-button">Copiar todo</button>
                                        <div class="code-command">echo "Test TD-4550DNWB" > test.txt</div>
                                        <div class="code-command">lp -d TD-4550DNWB test.txt</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Script para hacer que los acordeones funcionen
document.addEventListener('DOMContentLoaded', function() {
    // Botones de acordeón
    var accordionButtons = document.querySelectorAll('.accordion-button');
    
    accordionButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            var targetId = this.getAttribute('data-bs-target').substring(1);
            var targetElement = document.getElementById(targetId);
            
            if (targetElement.classList.contains('show')) {
                targetElement.classList.remove('show');
                this.classList.add('collapsed');
                this.setAttribute('aria-expanded', 'false');
            } else {
                var parentId = targetElement.getAttribute('data-bs-parent');
                if (parentId) {
                    var parentElement = document.querySelector(parentId);
                    var openPanels = parentElement.querySelectorAll('.accordion-collapse.show');
                    openPanels.forEach(function(panel) {
                        panel.classList.remove('show');
                        var panelButton = document.querySelector('[data-bs-target="#' + panel.id + '"]');
                        if (panelButton) {
                            panelButton.classList.add('collapsed');
                            panelButton.setAttribute('aria-expanded', 'false');
                        }
                    });
                }
                
                targetElement.classList.add('show');
                this.classList.remove('collapsed');
                this.setAttribute('aria-expanded', 'true');
            }
        });
    });
    
    // Botón de solución de problemas
    document.getElementById('showTroubleshooting').addEventListener('click', function(e) {
        e.preventDefault();
        var troubleshootingButton = document.getElementById('troubleshootingButton');
        var problemHelp = document.getElementById('problemHelp');
        
        problemHelp.classList.add('show');
        troubleshootingButton.classList.remove('collapsed');
        troubleshootingButton.setAttribute('aria-expanded', 'true');
        
        // Desplazar suavemente hasta la sección
        problemHelp.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
    
    // Botones de copiar
    var copyButtons = document.querySelectorAll('.copy-button');
    
    copyButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            // Obtener todos los elementos .code-command del bloque
            var codeBlock = this.closest('.code-block');
            var commands = codeBlock.querySelectorAll('.code-command');
            
            // Filtrar líneas vacías y líneas que comiencen con #
            var textToCopy = Array.from(commands)
                .map(function(cmd) {
                    var text = cmd.textContent;
                    // Si la línea está vacía o comienza con # (comentario), ignorarla
                    if (text.trim() === '' || text.trim().startsWith('#')) {
                        return '';
                    }
                    return text;
                })
                .filter(function(text) { return text !== ''; })
                .join('\n');
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(textToCopy).then(function() {
                // Cambiar estilo del botón para indicar éxito
                var originalText = button.textContent;
                button.textContent = '✓ ¡Copiado!';
                button.classList.add('copy-success');
                
                // Restablecer después de 2 segundos
                setTimeout(function() {
                    button.textContent = originalText;
                    button.classList.remove('copy-success');
                }, 2000);
            }).catch(function(err) {
                console.error('No se pudo copiar: ', err);
                alert('Error al copiar. Intente seleccionar y copiar manualmente.');
            });
        });
    });
});
</script>
{% endblock %}