<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejemplo de Impresi√≥n Brother TD-4550DNWB - Sistema de Plantillas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .info-banner {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .info-banner h3 {
            margin-top: 0;
            color: #1976D2;
        }
        .panel {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .panel-title {
            background-color: #f5f5f5;
            padding: 10px;
            margin: -15px -15px 15px;
            border-bottom: 1px solid #ddd;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        button.secondary {
            background-color: #2196F3;
        }
        button.secondary:hover {
            background-color: #1976D2;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .status-ok {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .printer-list {
            list-style: none;
            padding: 0;
        }
        .printer-item {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .printer-item:hover {
            background-color: #f0f0f0;
        }
        .preview-section {
            background-color: #f9f9f9;
            border: 1px dashed #ddd;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        .preview-content {
            font-family: monospace;
            white-space: pre-wrap;
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .template-layout {
            text-align: center;
            background: white;
            border: 2px solid #333;
            padding: 20px;
            margin: 15px auto;
            max-width: 400px;
            font-family: 'Courier New', monospace;
        }
        .template-layout h4 {
            margin: 5px 0;
        }
        .template-layout .barcode {
            font-family: 'Libre Barcode 128', monospace;
            font-size: 48px;
            margin: 10px 0;
        }
        .template-layout .info-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè∑Ô∏è Ejemplo de Impresi√≥n Brother TD-4550DNWB</h1>
        <p><strong>Sistema de Plantillas</strong> - Etiquetas de 44mm x 38mm</p>
        
        <div class="info-banner">
            <h3>‚ÑπÔ∏è Nuevo Sistema de Impresi√≥n</h3>
            <p>Este ejemplo usa el <strong>nuevo sistema de plantillas</strong>. Solo necesitas enviar los datos en formato JSON y la app se encarga de generar la etiqueta con el formato correcto, respetando el tama√±o y separaci√≥n configurados.</p>
        </div>
        
        <div class="panel">
            <div class="panel-title">üì° Estado de la Impresora</div>
            <div id="printerStatus">Verificando estado de la impresora...</div>
            <button id="btnCheckPrinter">üîç Verificar Estado</button>
            <button id="btnSearchPrinters" class="secondary">üñ®Ô∏è Buscar Impresoras</button>
        </div>
        
        <div class="panel" id="printerListPanel" style="display: none;">
            <div class="panel-title">üñ®Ô∏è Impresoras Disponibles</div>
            <ul id="printerList" class="printer-list"></ul>
        </div>
        
        <div class="panel">
            <div class="panel-title">üìù Datos de la Etiqueta</div>
            
            <div class="form-group">
                <label for="producto">Producto (nombre principal):</label>
                <input type="text" id="producto" value="POLLO EMPANADO" placeholder="Ej: POLLO EMPANADO">
            </div>
            
            <div class="form-group">
                <label for="estado">Estado del producto:</label>
                <input type="text" id="estado" value="REFRIGERADO" placeholder="Ej: REFRIGERADO, CONGELADO, etc.">
            </div>
            
            <div class="form-group">
                <label for="cad1">CAD 1 (Primera fecha de caducidad):</label>
                <input type="text" id="cad1" value="05/06/2025" placeholder="Ej: 05/06/2025">
            </div>
            
            <div class="form-group">
                <label for="cad2">CAD 2 (Segunda fecha de caducidad):</label>
                <input type="text" id="cad2" value="08/06/2025" placeholder="Ej: 08/06/2025">
            </div>
            
            <div class="form-group">
                <label for="manipulador">Manipulador:</label>
                <input type="text" id="manipulador" value="Juan P√©rez Garc√≠a" placeholder="Ej: Juan P√©rez">
            </div>
            
            <div class="form-group">
                <label for="lote">N√∫mero de Lote:</label>
                <input type="text" id="lote" value="L2025-0156" placeholder="Ej: L2025-0156">
            </div>
            
            <div class="preview-section">
                <h4>üëÅÔ∏è Vista Previa de la Etiqueta</h4>
                <div class="template-layout">
                    <h4 id="previewProducto" style="font-size: 24px; margin-bottom: 5px;">POLLO EMPANADO</h4>
                    <p id="previewEstado" style="font-size: 18px; margin-top: 0;">REFRIGERADO</p>
                    <hr>
                    <div style="text-align: left; margin: 10px 0;">
                        <strong>CAD 1:</strong> <span id="previewCad1">05/06/2025</span><br>
                        <strong>CAD 2:</strong> <span id="previewCad2">08/06/2025</span>
                    </div>
                    <hr>
                    <div class="info-row">
                        <span><strong>Manipulador:</strong> <span id="previewManipulador">Juan P√©rez Garc√≠a</span></span>
                    </div>
                    <div class="info-row">
                        <span><strong>LOTE:</strong> <span id="previewLote">L2025-0156</span></span>
                    </div>
                    <div class="barcode">||||| |||| |||||</div>
                    <p style="font-size: 10px; margin: 5px 0;" id="previewLoteCode">L2025-0156</p>
                </div>
                <button id="btnPreviewJSON" class="secondary">üìã Ver Datos JSON</button>
            </div>
        </div>
        
        <div class="panel" id="jsonPreviewPanel" style="display: none;">
            <div class="panel-title">üìã Datos JSON a Enviar</div>
            <div class="preview-content" id="jsonPreview"></div>
        </div>
        
        <div class="panel">
            <div class="panel-title">üñ®Ô∏è Imprimir Etiqueta</div>
            <button id="btnPrintLabel" disabled>üè∑Ô∏è Imprimir Etiqueta con Plantilla</button>
<button id="btnSendJson">üöÄ Enviar JSON</button>
<button id="btnGetFields" class="secondary">üìã Ver Campos Disponibles</button>
            <div id="printStatus"></div>
        </div>
    </div>
    
    <script>
        // Configurar callbacks globales para Brother Print
        window.BrotherPrint = {
            onPrintersFound: function(printersJsonString) {
                console.log('Impresoras encontradas:', printersJsonString);
                try {
                    const printers = JSON.parse(printersJsonString);
                    displayPrinterList(printers);
                } catch (e) {
                    console.error('Error parseando lista de impresoras:', e);
                }
            },
            onPrinterConnected: function(data) {
                console.log('Impresora conectada exitosamente');
                document.getElementById('printerStatus').innerHTML = `
                    <div class="status status-ok">
                        ‚úÖ Impresora conectada exitosamente
                    </div>
                `;
                checkPrinterAvailability();
            },
            onPrintSuccess: function(data) {
                console.log('Impresi√≥n exitosa:', data);
                try {
                    const result = JSON.parse(data);
                    document.getElementById('printStatus').innerHTML = `
                        <div class="status status-ok">
                            ‚úÖ ${result.message || 'Etiqueta a√±adida a la cola de impresi√≥n'}
                            ${result.queueSize ? `<br>üìã Etiquetas en cola: ${result.queueSize}` : ''}
                        </div>
                    `;
                } catch (e) {
                    document.getElementById('printStatus').innerHTML = `
                        <div class="status status-ok">
                            ‚úÖ Etiqueta enviada correctamente
                        </div>
                    `;
                }
            },
            onPrintError: function(errorData) {
                console.error('Error de impresi√≥n:', errorData);
                try {
                    const error = JSON.parse(errorData);
                    document.getElementById('printStatus').innerHTML = `
                        <div class="status status-error">
                            ‚ùå Error: ${error.error || 'Error desconocido'}
                        </div>
                    `;
                } catch (e) {
                    document.getElementById('printStatus').innerHTML = `
                        <div class="status status-error">
                            ‚ùå Error al imprimir
                        </div>
                    `;
                }
            },
            onStatusUpdate: function(statusData) {
                console.log('Estado actualizado:', statusData);
                try {
                    const status = JSON.parse(statusData);
                    if (status.connected) {
                        document.getElementById('printerStatus').innerHTML = `
                            <div class="status status-ok">
                                ‚úÖ Impresora conectada y lista
                                ${status.message ? `<br>${status.message}` : ''}
                            </div>
                        `;
                        document.getElementById('btnPrintLabel').disabled = false;
                    } else {
                        document.getElementById('printerStatus').innerHTML = `
                            <div class="status status-warning">
                                ‚ö†Ô∏è Impresora no conectada
                            </div>
                        `;
                        document.getElementById('btnPrintLabel').disabled = true;
                    }
                } catch (e) {
                    console.error('Error procesando estado:', e);
                }
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
    // Bot√≥n para enviar el JSON fijo
    const btnSendJson = document.getElementById('btnSendJson');
    if (btnSendJson) {
        btnSendJson.addEventListener('click', function() {
            const etiqueta = {
                producto: "POLLO EMPANADO",
                estado: "REFRIGERADO",
                cad1: "05/06/2025",
                cad2: "08/06/2025",
                manipulador: "Juan P√©rez",
                lote: "L2025-0156"
            };
            if (window.AndroidBridge && window.AndroidBridge.printLabelData) {
                AndroidBridge.printLabelData(JSON.stringify(etiqueta));
            } else {
                alert('La API de impresora Brother no est√° disponible.');
            }
        });
    }
            // Referencias a elementos del DOM
            const printerStatusElement = document.getElementById('printerStatus');
            const btnCheckPrinter = document.getElementById('btnCheckPrinter');
            const btnSearchPrinters = document.getElementById('btnSearchPrinters');
            const btnPrintLabel = document.getElementById('btnPrintLabel');
            const btnPreviewJSON = document.getElementById('btnPreviewJSON');
            const btnGetFields = document.getElementById('btnGetFields');
            const printStatusElement = document.getElementById('printStatus');
            const printerListPanel = document.getElementById('printerListPanel');
            const printerList = document.getElementById('printerList');
            const jsonPreviewPanel = document.getElementById('jsonPreviewPanel');
            const jsonPreview = document.getElementById('jsonPreview');
            
            // Actualizar vista previa en tiempo real
            function updatePreview() {
                document.getElementById('previewProducto').textContent = document.getElementById('producto').value || 'PRODUCTO';
                document.getElementById('previewEstado').textContent = document.getElementById('estado').value || 'ESTADO';
                document.getElementById('previewCad1').textContent = document.getElementById('cad1').value || 'DD/MM/AAAA';
                document.getElementById('previewCad2').textContent = document.getElementById('cad2').value || 'DD/MM/AAAA';
                document.getElementById('previewManipulador').textContent = document.getElementById('manipulador').value || 'Nombre';
                document.getElementById('previewLote').textContent = document.getElementById('lote').value || 'LOTE';
                document.getElementById('previewLoteCode').textContent = document.getElementById('lote').value || 'LOTE';
            }
            
            // Agregar event listeners para actualizar preview
            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updatePreview);
            });
            
            // Obtener datos del formulario mapeados a los campos de la plantilla
            function getFormData() {
                return {
                    producto: document.getElementById('producto').value,
                    estado: document.getElementById('estado').value,
                    cad1: document.getElementById('cad1').value,
                    cad2: document.getElementById('cad2').value,
                    manipulador: document.getElementById('manipulador').value,
                    lote: document.getElementById('lote').value
                };
            }
            
            // Verificar disponibilidad de la API de impresora
            function checkPrinterAvailability() {
                if (window.AndroidBridge && window.AndroidBridge.getPrinterStatus) {
                    AndroidBridge.getPrinterStatus();
                } else {
                    printerStatusElement.innerHTML = `
                        <div class="status status-error">
                            ‚ùå La API de impresora Brother no est√° disponible. 
                            Este ejemplo debe ejecutarse dentro de la aplicaci√≥n Android WebView.
                        </div>
                    `;
                    return false;
                }
                return true;
            }
            
            // Buscar impresoras disponibles
            function searchPrinters() {
                if (window.AndroidBridge && window.AndroidBridge.searchPrinters) {
                    printerStatusElement.innerHTML = `
                        <div class="status status-warning">
                            üîç Buscando impresoras Brother...
                        </div>
                    `;
                    AndroidBridge.searchPrinters();
                } else {
                    alert('La funci√≥n de b√∫squeda no est√° disponible fuera de la aplicaci√≥n Android');
                }
            }
            
            // Mostrar lista de impresoras
            function displayPrinterList(printers) {
                if (printers.length === 0) {
                    printerList.innerHTML = '<li class="printer-item">No se encontraron impresoras Brother</li>';
                } else {
                    printerList.innerHTML = '';
                    printers.forEach(printer => {
                        const li = document.createElement('li');
                        li.className = 'printer-item';
                        li.innerHTML = `
                            <strong>üñ®Ô∏è ${printer.name}</strong><br>
                            <small>MAC: ${printer.address}</small>
                            ${printer.model ? `<br><small>Modelo: ${printer.model}</small>` : ''}
                        `;
                        li.onclick = function() {
                            connectToPrinter(printer.address);
                        };
                        printerList.appendChild(li);
                    });
                }
                printerListPanel.style.display = 'block';
            }
            
            // Conectar a una impresora
            function connectToPrinter(macAddress) {
                if (window.AndroidBridge && window.AndroidBridge.connectPrinter) {
                    printerStatusElement.innerHTML = `
                        <div class="status status-warning">
                            ‚è≥ Conectando a la impresora...
                        </div>
                    `;
                    AndroidBridge.connectPrinter(macAddress);
                    printerListPanel.style.display = 'none';
                }
            }
            
            // Mostrar preview JSON
            function showJSONPreview() {
                const data = getFormData();
                jsonPreview.textContent = JSON.stringify(data, null, 2);
                jsonPreviewPanel.style.display = 'block';
            }
            
            // Imprimir etiqueta con el nuevo sistema
            function printLabel() {
                const data = getFormData();
                
                if (window.AndroidBridge && window.AndroidBridge.printLabelData) {
                    printStatusElement.innerHTML = `
                        <div class="status status-warning">
                            ‚è≥ Enviando etiqueta a la cola de impresi√≥n...
                        </div>
                    `;
                    
                    try {
                        // Usar el nuevo m√©todo printLabelData
                        AndroidBridge.printLabelData(JSON.stringify(data));
                    } catch (e) {
                        printStatusElement.innerHTML = `
                            <div class="status status-error">
                                ‚ùå Error: ${e.message}
                            </div>
                        `;
                        console.error('Error al imprimir:', e);
                    }
                } else {
                    printStatusElement.innerHTML = `
                        <div class="status status-error">
                            ‚ùå La API de impresora Brother no est√° disponible.
                        </div>
                    `;
                }
            }
            
            // Mostrar campos disponibles
            function showAvailableFields() {
                if (window.AndroidBridge && window.AndroidBridge.getDefaultTemplateFields) {
                    try {
                        const response = JSON.parse(AndroidBridge.getDefaultTemplateFields());
                        if (response.success) {
                            let fieldsHTML = '<h4>Campos disponibles en la plantilla:</h4><ul>';
                            response.fields.forEach(field => {
                                fieldsHTML += `<li><strong>${field.name}</strong>: ${field.description}</li>`;
                            });
                            fieldsHTML += '</ul>';
                            
                            printStatusElement.innerHTML = `
                                <div class="status status-ok">
                                    ${fieldsHTML}
                                </div>
                            `;
                        }
                    } catch (e) {
                        console.error('Error obteniendo campos:', e);
                    }
                } else {
                    printStatusElement.innerHTML = `
                        <div class="status status-warning">
                            <h4>Campos disponibles (demo):</h4>
                            <ul>
                                <li><strong>producto</strong>: Nombre del producto (t√≠tulo principal)</li>
                                <li><strong>estado</strong>: Estado del producto</li>
                                <li><strong>cad1</strong>: Primera fecha de caducidad</li>
                                <li><strong>cad2</strong>: Segunda fecha de caducidad</li>
                                <li><strong>manipulador</strong>: Nombre del manipulador</li>
                                <li><strong>lote</strong>: N√∫mero de lote (se mostrar√° tambi√©n como c√≥digo de barras)</li>
                            </ul>
                        </div>
                    `;
                }
            }
            
            // Asignar eventos
            btnCheckPrinter.addEventListener('click', checkPrinterAvailability);
            btnSearchPrinters.addEventListener('click', searchPrinters);
            btnPrintLabel.addEventListener('click', printLabel);
            btnPreviewJSON.addEventListener('click', showJSONPreview);
            btnGetFields.addEventListener('click', showAvailableFields);
            
            // Inicializaci√≥n
            checkPrinterAvailability();
            updatePreview();
        });
    </script>
</body>
</html>