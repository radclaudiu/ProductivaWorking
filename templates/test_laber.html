<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Brother Printer - Simple con Logs Detallados</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; border-radius: 4px; }
        .btn-success { background: #28a745; color: white; border: none; border-radius: 4px; }
        .log { background: #f8f9fa; padding: 10px; margin-top: 20px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .log-entry { margin: 2px 0; }
        .log-error { color: #dc3545; }
        .log-success { color: #28a745; }
        .log-info { color: #17a2b8; }
        .log-warning { color: #ffc107; }
        #printerList { margin: 20px 0; }
        .printer-item { padding: 10px; background: #e9ecef; margin: 5px 0; cursor: pointer; border-radius: 4px; }
        .printer-item:hover { background: #dee2e6; }
    </style>
</head>
<body>

<div class="container">
    <h1>Test Brother TD-4550DNWB - Logs Detallados</h1>

    <div>
        <h3>1. Verificar Estado</h3>
        <button class="btn-primary" onclick="checkStatus()">Verificar Estado</button>
        <button class="btn-primary" onclick="tryReconnect()">Reconectar</button>
    </div>

    <div>
        <h3>2. Buscar Impresoras</h3>
        <button class="btn-primary" onclick="searchPrinters()">Buscar Impresoras</button>
        <small style="display: block; margin-top: 5px; color: #666;">
            Asegúrate de que la impresora esté encendida y visible por Bluetooth
        </small>
    </div>

    <div id="printerList"></div>

    <div>
        <h3>3. Imprimir Prueba</h3>
        <button class="btn-success" onclick="testPrint()">Imprimir Etiqueta de Prueba</button>
    </div>

    <h3>Logs:</h3>
    <div id="log" class="log"></div>
</div>

<script>
// Sistema de logs mejorado
function log(message, type = 'info') {
    const logDiv = document.getElementById('log');
    const time = new Date().toLocaleTimeString('es-ES');
    const className = `log-${type}`;
    const entry = document.createElement('div');
    entry.className = `log-entry ${className}`;
    entry.textContent = `${time} - ${message}`;
    logDiv.appendChild(entry);
    logDiv.scrollTop = logDiv.scrollHeight;

    // También mostrar en consola
    console.log(`[${type.toUpperCase()}] ${time} - ${message}`);
}

// Definir callbacks ANTES de cualquier llamada
window.BrotherPrint = {
    onStatusUpdate: function(data) {
        log('onStatusUpdate recibido: ' + data, 'info');
        try {
            // Log del tipo de datos recibido
            log('Tipo de datos: ' + typeof data, 'info');

            // Si es string, intentar parsearlo
            if (typeof data === 'string') {
                const status = JSON.parse(data);
                log('Estado parseado: connected=' + status.connected + ', ready=' + status.ready, 'success');

                if (status.connected) {
                    if (status.message) {
                        log('✅ ' + status.message, 'success');
                    } else {
                        log('✅ Impresora conectada y lista', 'success');
                    }
                } else {
                    log('❌ Impresora no conectada', 'warning');
                    log('Tip: Verifica que la impresora esté encendida y emparejada por Bluetooth', 'info');
                }
            } else {
                log('Error: Se esperaba string pero se recibió ' + typeof data, 'error');
            }
        } catch (e) {
            log('Error parseando status: ' + e.message, 'error');
            log('Datos recibidos: "' + data + '"', 'error');
        }
    },

    onPrintersFound: function(data) {
        log('onPrintersFound recibido: ' + data, 'info');
        try {
            log('Tipo de datos: ' + typeof data, 'info');

            if (typeof data === 'string') {
                const printers = JSON.parse(data);
                log('Se encontraron ' + printers.length + ' impresoras', 'success');

                const listDiv = document.getElementById('printerList');
                listDiv.innerHTML = '';

                if (printers.length === 0) {
                    listDiv.innerHTML = '<p style="color: #666;">No se encontraron impresoras. Asegúrate de que:<br>' +
                        '- La impresora esté encendida<br>' +
                        '- El Bluetooth esté activado<br>' +
                        '- La impresora esté emparejada en Configuración de Android</p>';
                } else {
                    printers.forEach((printer, index) => {
                        log('Impresora ' + (index + 1) + ': ' + printer.name + ' (' + printer.address + ')', 'info');

                        const item = document.createElement('div');
                        item.className = 'printer-item';
                        item.innerHTML = `
                            <strong>${printer.name}</strong><br>
                            MAC: ${printer.address}<br>
                            Modelo: ${printer.model || 'N/A'}
                        `;
                        item.onclick = function() {
                            connectPrinter(printer.address);
                        };
                        listDiv.appendChild(item);
                    });
                }
            } else {
                log('Error: Se esperaba string pero se recibió ' + typeof data, 'error');
            }
        } catch (e) {
            log('Error parseando impresoras: ' + e.message, 'error');
            log('Datos recibidos: "' + data + '"', 'error');
        }
    },

    onPrinterConnected: function(data) {
        log('onPrinterConnected recibido: ' + data, 'info');
        try {
            log('Tipo de datos: ' + typeof data, 'info');

            if (typeof data === 'string') {
                const result = JSON.parse(data);
                log('✅ Conectado exitosamente a ' + result.mac, 'success');
            } else {
                log('Error: Se esperaba string pero se recibió ' + typeof data, 'error');
            }
        } catch (e) {
            log('Error parseando conexión: ' + e.message, 'error');
        }
    },

    onPrintSuccess: function(data) {
        log('onPrintSuccess recibido: ' + data, 'info');
        try {
            log('Tipo de datos: ' + typeof data, 'info');

            if (typeof data === 'string') {
                const result = JSON.parse(data);
                log('✅ Impresión exitosa: ' + result.message, 'success');
            } else {
                log('Error: Se esperaba string pero se recibió ' + typeof data, 'error');
            }
        } catch (e) {
            log('Error parseando éxito: ' + e.message, 'error');
        }
    },

    onPrintError: function(data) {
        log('onPrintError recibido: ' + data, 'error');
        try {
            log('Tipo de datos: ' + typeof data, 'info');

            if (typeof data === 'string') {
                const error = JSON.parse(data);
                log('❌ Error: ' + error.error, 'error');
                if (error.mac) {
                    log('MAC: ' + error.mac, 'error');
                }
            } else {
                log('Error: Se esperaba string pero se recibió ' + typeof data, 'error');
            }
        } catch (e) {
            log('Error parseando error: ' + e.message, 'error');
            log('Datos recibidos: "' + data + '"', 'error');
        }
    },

    onPrinterDisconnected: function(data) {
        log('onPrinterDisconnected recibido: ' + data, 'info');
        try {
            if (typeof data === 'string') {
                const result = JSON.parse(data);
                log('Impresora desconectada', 'info');
            }
        } catch (e) {
            log('Error parseando desconexión: ' + e.message, 'error');
        }
    }
};

// Funciones principales
function checkStatus() {
    if (typeof AndroidBridge === 'undefined') {
        log('❌ AndroidBridge no está disponible', 'error');
        return;
    }

    log('Llamando getPrinterStatus()...', 'info');
    try {
        AndroidBridge.getPrinterStatus();
    } catch (e) {
        log('Error al llamar getPrinterStatus: ' + e.message, 'error');
    }
}

function searchPrinters() {
    if (typeof AndroidBridge === 'undefined') {
        log('❌ AndroidBridge no está disponible', 'error');
        return;
    }

    log('Llamando searchPrinters()...', 'info');
    document.getElementById('printerList').innerHTML = '<p>Buscando...</p>';

    try {
        AndroidBridge.searchPrinters();
    } catch (e) {
        log('Error al llamar searchPrinters: ' + e.message, 'error');
    }
}

function connectPrinter(mac) {
    if (typeof AndroidBridge === 'undefined') {
        log('❌ AndroidBridge no está disponible', 'error');
        return;
    }

    log('Conectando a impresora: ' + mac, 'info');
    try {
        AndroidBridge.connectPrinter(mac);
    } catch (e) {
        log('Error al llamar connectPrinter: ' + e.message, 'error');
    }
}

function testPrint() {
    if (typeof AndroidBridge === 'undefined') {
        log('❌ AndroidBridge no está disponible', 'error');
        return;
    }

    log('Creando imagen de prueba...', 'info');

    try {
        // Crear canvas exacto para TD-4550DNWB
        const canvas = document.createElement('canvas');
        canvas.width = 520;  // 44mm a 300 DPI
        canvas.height = 449; // 38mm a 300 DPI
        const ctx = canvas.getContext('2d');

        // Fondo blanco
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, 520, 449);

        // Borde negro
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 3;
        ctx.strokeRect(10, 10, 500, 429);

        // Título
        ctx.fillStyle = 'black';
        ctx.font = 'bold 36px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('TEST BROTHER', 260, 80);
        ctx.fillText('TD-4550DNWB', 260, 130);

        // Línea
        ctx.beginPath();
        ctx.moveTo(50, 150);
        ctx.lineTo(470, 150);
        ctx.stroke();

        // Información
        ctx.font = '24px Arial';
        ctx.fillText('44mm x 38mm', 260, 200);
        ctx.fillText('520 x 449 px', 260, 240);

        // Timestamp
        ctx.font = '20px Arial';
        const now = new Date();
        ctx.fillText(now.toLocaleString('es-ES'), 260, 300);

        // Test de logs
        ctx.font = '16px Arial';
        ctx.fillText('Test con logs detallados', 260, 350);
        ctx.fillText('WebView Productiva', 260, 380);

        // Convertir a base64 SIN el prefijo
        const dataUrl = canvas.toDataURL('image/png');
        const base64 = dataUrl.split(',')[1];

        log('Canvas creado: ' + canvas.width + 'x' + canvas.height, 'info');
        log('Base64 generado, longitud: ' + base64.length, 'info');

        // Verificar que tenemos base64 válido
        if (!base64 || base64.length === 0) {
            log('Error: Base64 vacío', 'error');
            return;
        }

        // Log de los primeros caracteres del base64
        log('Primeros 50 chars del base64: ' + base64.substring(0, 50) + '...', 'info');

        log('Llamando printImage()...', 'info');
        AndroidBridge.printImage(base64);

    } catch (e) {
        log('Error al crear/enviar imagen: ' + e.message, 'error');
        log('Stack trace: ' + e.stack, 'error');
    }
}

// Función para intentar reconectar manualmente
function tryReconnect() {
    if (typeof AndroidBridge === 'undefined') {
        log('❌ AndroidBridge no está disponible', 'error');
        return;
    }

    log('Intentando reconectar con la impresora configurada...', 'info');

    // Primero verificar el estado, lo que activará la reconexión automática
    checkStatus();
}

// Al cargar la página
window.onload = function() {
    log('Página cargada', 'info');

    if (typeof AndroidBridge !== 'undefined') {
        log('✅ AndroidBridge disponible', 'success');

        // Verificar métodos disponibles
        const methods = ['searchPrinters', 'connectPrinter', 'printImage', 'getPrinterStatus', 'disconnectPrinter'];
        methods.forEach(method => {
            if (typeof AndroidBridge[method] === 'function') {
                log('✓ AndroidBridge.' + method + ' disponible', 'success');
            } else {
                log('✗ AndroidBridge.' + method + ' NO disponible', 'error');
            }
        });

        // Verificar estado inicial
        setTimeout(() => {
            log('Verificando estado inicial...', 'info');
            checkStatus();
        }, 1000);

    } else {
        log('❌ AndroidBridge NO disponible', 'error');
        log('Esta página debe ejecutarse dentro de la app Android', 'warning');
    }
};

// Log de errores globales
window.onerror = function(msg, url, lineNo, columnNo, error) {
    log('Error global: ' + msg + ' en línea ' + lineNo, 'error');
    return false;
};
</script>

</body>
</html> 